define("8567e4de-8cb3-406c-a31d-bcfd13c03eb8_2.1.0",["tslib","@microsoft/sp-core-library","@microsoft/sp-diagnostics","@microsoft/sp-http-base","@ms/sp-telemetry","@microsoft/sp-http"],(e,t,n,a,i,r)=>(()=>{var o={42:function(e,t){var n="undefined"!=typeof self?self:this,a=function(){function e(){this.fetch=!1,this.DOMException=n.DOMException}return e.prototype=n,new e}();!function(e){!function(t){var n="URLSearchParams"in e,a="Symbol"in e&&"iterator"in Symbol,i="FileReader"in e&&"Blob"in e&&function(){try{return new Blob,!0}catch(e){return!1}}(),r="FormData"in e,o="ArrayBuffer"in e;if(o)var s=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],c=ArrayBuffer.isView||function(e){return e&&s.indexOf(Object.prototype.toString.call(e))>-1};function d(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function l(e){return"string"!=typeof e&&(e=String(e)),e}function u(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return a&&(t[Symbol.iterator]=function(){return t}),t}function f(e){this.map={},e instanceof f?e.forEach(function(e,t){this.append(t,e)},this):Array.isArray(e)?e.forEach(function(e){this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function p(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function m(e){return new Promise(function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function _(e){var t=new FileReader,n=m(t);return t.readAsArrayBuffer(e),n}function h(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function b(){return this.bodyUsed=!1,this._initBody=function(e){var t;this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:i&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:r&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:n&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():o&&i&&(t=e)&&DataView.prototype.isPrototypeOf(t)?(this._bodyArrayBuffer=h(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):o&&(ArrayBuffer.prototype.isPrototypeOf(e)||c(e))?this._bodyArrayBuffer=h(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},i&&(this.blob=function(){var e=p(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?p(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(_)}),this.text=function(){var e,t,n,a=p(this);if(a)return a;if(this._bodyBlob)return e=this._bodyBlob,n=m(t=new FileReader),t.readAsText(e),n;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),n=new Array(t.length),a=0;a<t.length;a++)n[a]=String.fromCharCode(t[a]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},r&&(this.formData=function(){return this.text().then(y)}),this.json=function(){return this.text().then(JSON.parse)},this}f.prototype.append=function(e,t){e=d(e),t=l(t);var n=this.map[e];this.map[e]=n?n+", "+t:t},f.prototype.delete=function(e){delete this.map[d(e)]},f.prototype.get=function(e){return e=d(e),this.has(e)?this.map[e]:null},f.prototype.has=function(e){return this.map.hasOwnProperty(d(e))},f.prototype.set=function(e,t){this.map[d(e)]=l(t)},f.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},f.prototype.keys=function(){var e=[];return this.forEach(function(t,n){e.push(n)}),u(e)},f.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),u(e)},f.prototype.entries=function(){var e=[];return this.forEach(function(t,n){e.push([n,t])}),u(e)},a&&(f.prototype[Symbol.iterator]=f.prototype.entries);var g=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function v(e,t){var n,a,i=(t=t||{}).body;if(e instanceof v){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new f(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,i||null==e._bodyInit||(i=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new f(t.headers)),this.method=(a=(n=t.method||this.method||"GET").toUpperCase(),g.indexOf(a)>-1?a:n),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function y(e){var t=new FormData;return e.trim().split("&").forEach(function(e){if(e){var n=e.split("="),a=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(a),decodeURIComponent(i))}}),t}function S(e,t){t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new f(t.headers),this.url=t.url||"",this._initBody(e)}v.prototype.clone=function(){return new v(this,{body:this._bodyInit})},b.call(v.prototype),b.call(S.prototype),S.prototype.clone=function(){return new S(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})},S.error=function(){var e=new S(null,{status:0,statusText:""});return e.type="error",e};var D=[301,302,303,307,308];S.redirect=function(e,t){if(-1===D.indexOf(t))throw new RangeError("Invalid status code");return new S(null,{status:t,headers:{location:e}})},t.DOMException=e.DOMException;try{new t.DOMException}catch(e){t.DOMException=function(e,t){this.message=e,this.name=t;var n=Error(e);this.stack=n.stack},t.DOMException.prototype=Object.create(Error.prototype),t.DOMException.prototype.constructor=t.DOMException}function I(e,n){return new Promise(function(a,r){var o=new v(e,n);if(o.signal&&o.signal.aborted)return r(new t.DOMException("Aborted","AbortError"));var s=new XMLHttpRequest;function c(){s.abort()}s.onload=function(){var e,t,n={status:s.status,statusText:s.statusText,headers:(e=s.getAllResponseHeaders()||"",t=new f,e.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(e){var n=e.split(":"),a=n.shift().trim();if(a){var i=n.join(":").trim();t.append(a,i)}}),t)};n.url="responseURL"in s?s.responseURL:n.headers.get("X-Request-URL");var i="response"in s?s.response:s.responseText;a(new S(i,n))},s.onerror=function(){r(new TypeError("Network request failed"))},s.ontimeout=function(){r(new TypeError("Network request failed"))},s.onabort=function(){r(new t.DOMException("Aborted","AbortError"))},s.open(o.method,o.url,!0),"include"===o.credentials?s.withCredentials=!0:"omit"===o.credentials&&(s.withCredentials=!1),"responseType"in s&&i&&(s.responseType="blob"),o.headers.forEach(function(e,t){s.setRequestHeader(t,e)}),o.signal&&(o.signal.addEventListener("abort",c),s.onreadystatechange=function(){4===s.readyState&&o.signal.removeEventListener("abort",c)}),s.send(void 0===o._bodyInit?null:o._bodyInit)})}I.polyfill=!0,e.fetch||(e.fetch=I,e.Headers=f,e.Request=v,e.Response=S),t.Headers=f,t.Request=v,t.Response=S,t.fetch=I,Object.defineProperty(t,"__esModule",{value:!0})}({})}(a),a.fetch.ponyfill=!0,delete a.fetch.polyfill;var i=a;(t=i.fetch).default=i.fetch,t.fetch=i.fetch,t.Headers=i.Headers,t.Request=i.Request,t.Response=i.Response,e.exports=t}
,126:e=>{"use strict";function t(e){if(this._capacity=a(e),this._length=0,this._front=0,n(e)){for(var t=e.length,i=0;i<t;++i)this[i]=e[i];this._length=t}}t.prototype.toArray=function(){for(var e=this._length,t=new Array(e),n=this._front,a=this._capacity,i=0;i<e;++i)t[i]=this[n+i&a-1];return t},t.prototype.push=function(e){var t=arguments.length,n=this._length;if(t>1){var a=this._capacity;if(n+t>a){for(var i=0;i<t;++i)this._checkCapacity(n+1),this[r=this._front+n&this._capacity-1]=arguments[i],n++,this._length=n;return n}var r=this._front;for(i=0;i<t;++i)this[r+n&a-1]=arguments[i],r++;return this._length=n+t,n+t}return 0===t?n:(this._checkCapacity(n+1),this[i=this._front+n&this._capacity-1]=e,this._length=n+1,n+1)},t.prototype.pop=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1,n=this[t];return this[t]=void 0,this._length=e-1,n}},t.prototype.shift=function(){var e=this._length;if(0!==e){var t=this._front,n=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length=e-1,n}},t.prototype.unshift=function(e){var t=this._length,n=arguments.length;if(n>1){if(t+n>(i=this._capacity)){for(var a=n-1;a>=0;a--){this._checkCapacity(t+1);var i=this._capacity;this[o=(this._front-1&i-1^i)-i]=arguments[a],t++,this._length=t,this._front=o}return t}var r=this._front;for(a=n-1;a>=0;a--){var o;this[o=(r-1&i-1^i)-i]=arguments[a],r=o}return this._front=r,this._length=t+n,t+n}return 0===n?t:(this._checkCapacity(t+1),i=this._capacity,this[a=(this._front-1&i-1^i)-i]=e,this._length=t+1,this._front=a,t+1)},t.prototype.peekBack=function(){var e=this._length;if(0!==e)return this[this._front+e-1&this._capacity-1]},t.prototype.peekFront=function(){if(0!==this._length)return this[this._front]},t.prototype.get=function(e){var t=e;if(t===(0|t)){var n=this._length;if(t<0&&(t+=n),!(t<0||t>=n))return this[this._front+t&this._capacity-1]}},t.prototype.isEmpty=function(){return 0===this._length},t.prototype.clear=function(){for(var e=this._length,t=this._front,n=this._capacity,a=0;a<e;++a)this[t+a&n-1]=void 0;this._length=0,this._front=0},t.prototype.toString=function(){return this.toArray().toString()},t.prototype.valueOf=t.prototype.toString,t.prototype.removeFront=t.prototype.shift,t.prototype.removeBack=t.prototype.pop,t.prototype.insertFront=t.prototype.unshift,t.prototype.insertBack=t.prototype.push,t.prototype.enqueue=t.prototype.push,t.prototype.dequeue=t.prototype.shift,t.prototype.toJSON=t.prototype.toArray,Object.defineProperty(t.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),t.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(a(1.5*this._capacity+16))},t.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var n=this._front,a=this._length;n+a>t&&function(e,t,n,a,i){for(var r=0;r<i;++r)n[r+a]=e[r+0],e[r+0]=void 0}(this,0,this,t,n+a&t-1)};var n=Array.isArray;function a(e){if("number"!=typeof e){if(!n(e))return 16;e=e.length}return t=Math.min(Math.max(16,e),1073741824),t>>>=0,t-=1,t|=t>>1,t|=t>>2,t|=t>>4,1+((t|=t>>8)|t>>16);var t}e.exports=t}
,230:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function a(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function r(e,t,a,r,o){if("function"!=typeof a)throw new TypeError("The listener must be a function");var s=new i(a,r||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new a:delete e._events[t]}function s(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(n=!1)),s.prototype.eventNames=function(){var e,a,i=[];if(0===this._eventsCount)return i;for(a in e=this._events)t.call(e,a)&&i.push(n?a.slice(1):a);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},s.prototype.listeners=function(e){var t=n?n+e:e,a=this._events[t];if(!a)return[];if(a.fn)return[a.fn];for(var i=0,r=a.length,o=new Array(r);i<r;i++)o[i]=a[i].fn;return o},s.prototype.listenerCount=function(e){var t=n?n+e:e,a=this._events[t];return a?a.fn?1:a.length:0},s.prototype.emit=function(e,t,a,i,r,o){var s=n?n+e:e;if(!this._events[s])return!1;var c,d,l=this._events[s],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,a),!0;case 4:return l.fn.call(l.context,t,a,i),!0;case 5:return l.fn.call(l.context,t,a,i,r),!0;case 6:return l.fn.call(l.context,t,a,i,r,o),!0}for(d=1,c=new Array(u-1);d<u;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var f,p=l.length;for(d=0;d<p;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),u){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,a);break;case 4:l[d].fn.call(l[d].context,t,a,i);break;default:if(!c)for(f=1,c=new Array(u-1);f<u;f++)c[f-1]=arguments[f];l[d].fn.apply(l[d].context,c)}}return!0},s.prototype.on=function(e,t,n){return r(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return r(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,a,i){var r=n?n+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var s=this._events[r];if(s.fn)s.fn!==t||i&&!s.once||a&&s.context!==a||o(this,r);else{for(var c=0,d=[],l=s.length;c<l;c++)(s[c].fn!==t||i&&!s[c].once||a&&s[c].context!==a)&&d.push(s[c]);d.length?this._events[r]=1===d.length?d[0]:d:o(this,r)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new a,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s}
,209:e=>{"use strict";e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var a,i,r;if(Array.isArray(t)){if((a=t.length)!=n.length)return!1;for(i=a;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((a=(r=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(i=a;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,r[i]))return!1;for(i=a;0!=i--;){var o=r[i];if(!e(t[o],n[o]))return!1}return!0}return t!=t&&n!=n}}
,664:function(e,t,n){!function(e){"use strict";function t(e){for(var t=0,n=Math.min(65536,e.length+1),a=new Uint16Array(n),i=[],r=0;;){var o=t<e.length;if(!o||r>=n-1){var s=a.subarray(0,r);if(i.push(String.fromCharCode.apply(null,s)),!o)return i.join("");e=e.subarray(t),t=0,r=0}var c=e[t++];if(0==(128&c))a[r++]=c;else if(192==(224&c)){var d=63&e[t++];a[r++]=(31&c)<<6|d}else if(224==(240&c)){d=63&e[t++];var l=63&e[t++];a[r++]=(31&c)<<12|d<<6|l}else if(240==(248&c)){var u=(7&c)<<18|(d=63&e[t++])<<12|(l=63&e[t++])<<6|63&e[t++];u>65535&&(u-=65536,a[r++]=u>>>10&1023|55296,u=56320|1023&u),a[r++]=u}}}var n="Failed to ",a=function(e,t,a){if(e)throw new Error("".concat(n).concat(t,": the '").concat(a,"' option is unsupported."))},i="function"==typeof Buffer&&Buffer.from,r=i?function(e){return Buffer.from(e)}:function(e){for(var t=0,n=e.length,a=0,i=Math.max(32,n+(n>>>1)+7),r=new Uint8Array(i>>>3<<3);t<n;){var o=e.charCodeAt(t++);if(o>=55296&&o<=56319){if(t<n){var s=e.charCodeAt(t);56320==(64512&s)&&(++t,o=((1023&o)<<10)+(1023&s)+65536)}if(o>=55296&&o<=56319)continue}if(a+4>r.length){i+=8,i=(i*=1+t/e.length*2)>>>3<<3;var c=new Uint8Array(i);c.set(r),r=c}if(0!=(4294967168&o)){if(0==(4294965248&o))r[a++]=o>>>6&31|192;else if(0==(4294901760&o))r[a++]=o>>>12&15|224,r[a++]=o>>>6&63|128;else{if(0!=(4292870144&o))continue;r[a++]=o>>>18&7|240,r[a++]=o>>>12&63|128,r[a++]=o>>>6&63|128}r[a++]=63&o|128}else r[a++]=o}return r.slice?r.slice(0,a):r.subarray(0,a)};function o(){this.encoding="utf-8"}o.prototype.encode=function(e,t){return a(t&&t.stream,"encode","stream"),r(e)};var s=!i&&"function"==typeof Blob&&"function"==typeof URL&&"function"==typeof URL.createObjectURL,c=["utf-8","utf8","unicode-1-1-utf-8"],d=t;i?d=function(e,t){return(e instanceof Buffer?e:Buffer.from(e.buffer,e.byteOffset,e.byteLength)).toString(t)}:s&&(d=function(e){try{return function(e){var t;try{var n=new Blob([e],{type:"text/plain;charset=UTF-8"});t=URL.createObjectURL(n);var a=new XMLHttpRequest;return a.open("GET",t,!1),a.send(),a.responseText}finally{t&&URL.revokeObjectURL(t)}}(e)}catch(n){return t(e)}});var l="construct 'TextDecoder'",u="".concat(n," ").concat(l,": the ");function f(e,t){if(a(t&&t.fatal,l,"fatal"),e=e||"utf-8",!(i?Buffer.isEncoding(e):-1!==c.indexOf(e.toLowerCase())))throw new RangeError("".concat(u," encoding label provided ('").concat(e,"') is invalid."));this.encoding=e,this.fatal=!1,this.ignoreBOM=!1}f.prototype.decode=function(e,t){var n;return a(t&&t.stream,"decode","stream"),n=e instanceof Uint8Array?e:e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer):new Uint8Array(e),d(n,this.encoding)},e.TextEncoder=e.TextEncoder||o,e.TextDecoder=e.TextDecoder||f}("undefined"!=typeof window?window:void 0!==n.g?n.g:this)}
,875:(e,t,n)=>{var a=null;"undefined"!=typeof WebSocket?a=WebSocket:"undefined"!=typeof MozWebSocket?a=MozWebSocket:void 0!==n.g?a=n.g.WebSocket||n.g.MozWebSocket:"undefined"!=typeof window?a=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(a=self.WebSocket||self.MozWebSocket),e.exports=a}
,676:e=>{"use strict";e.exports=t},207:e=>{"use strict";e.exports=n},909:e=>{"use strict";e.exports=r},737:e=>{"use strict";e.exports=a},408:e=>{"use strict";e.exports=i},280:t=>{"use strict";t.exports=e},246:e=>{"use strict";e.exports={r:"2.35.1243"}}
},s={};function c(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return o[e].call(n.exports,n,n.exports,c),n.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var n in t)c.o(t,n)&&!c.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},c.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var d={};return(()=>{"use strict";c.r(d),c.d(d,{AddOperation:()=>p,AlWorkflowProxy:()=>Yc,Document:()=>ar,RecurrenceFrequency:()=>Pc,SharePointCopilotRPCFunctions:()=>Ec,SharepointCopilotRequest:()=>Jc,TextTile:()=>A,getRecommendedFiles:()=>sd,searchFileEntity:()=>rd});var e=c(280);class t{constructor(e){t.assign(t,this,e)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFor(e){return e&&e.H_?e.H_.T_:void 0}static getBaseTypesFor(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}static getAllTypesFor(e){const n=t.getTypeNameFor(e);return n?[n,...t.getBaseTypesFor(e)]:[]}static matchesTypesFor(e,n){if(!Array.isArray(n)||0===n.length)return!0;const a=t.getTypeNameFor(e),i=t.getBaseTypesFor(e);for(const e of n){if(e===a)return!0;if(i.indexOf(e)>=0)return!0}return!1}static assign(e,t,n){if(n)for(const e of Object.keys(n))t[e]=n[e];return t.H_=e.H_,t}}t.H_={T_:t.getTypeName(),B_:t.getBaseTypes()};class n{constructor(e){t.assign(n,this,e)}static getTypeName(){return"AugLoop_Chat_ChatsHolder"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return t.matchesTypesFor(e,[n.getTypeName()])}}n.H_={T_:n.getTypeName(),B_:n.getBaseTypes()};class a{constructor(e){t.assign(a,this,e)}static getTypeName(){return"AugLoop_Chat_Chat"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[a.getTypeName()])}}a.H_={T_:a.getTypeName(),B_:a.getBaseTypes()};class i{constructor(e){t.assign(i,this,e)}static getTypeName(){return"AugLoop_Chat_MessagesHolder"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return t.matchesTypesFor(e,[i.getTypeName()])}}i.H_={T_:i.getTypeName(),B_:i.getBaseTypes()};class r{constructor(e){t.assign(r,this,e)}static getTypeName(){return"AugLoop_Chat_ChatMessage"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[r.getTypeName()])}}r.H_={T_:r.getTypeName(),B_:r.getBaseTypes()};class o{constructor(e){t.assign(o,this,e)}static getTypeName(){return"AugLoop_Chat_TextChatMessage"}static getBaseTypes(){return["AugLoop_Chat_ChatMessage"]}static typeGuard(e){return t.matchesTypesFor(e,[o.getTypeName()])}}o.H_={T_:o.getTypeName(),B_:o.getBaseTypes()};class s{constructor(e){t.assign(s,this,e)}static getTypeName(){return"AugLoop_Core_ItemDelta"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[s.getTypeName()])}}s.H_={T_:s.getTypeName(),B_:s.getBaseTypes()};class l{constructor(e){t.assign(l,this,e)}static getTypeName(){return"AugLoop_Core_ItemChangesDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(e){return t.matchesTypesFor(e,[l.getTypeName()])}}l.H_={T_:l.getTypeName(),B_:l.getBaseTypes()};class u{constructor(e){t.assign(u,this,e)}static getTypeName(){return"AugLoop_Core_Operation"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[u.getTypeName()])}}u.H_={T_:u.getTypeName(),B_:u.getBaseTypes()};class f{constructor(e){t.assign(f,this,e)}static getTypeName(){return"AugLoop_Core_OperationWithSiblingContext"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[f.getTypeName()])}}f.H_={T_:f.getTypeName(),B_:f.getBaseTypes()};class p{constructor(e){t.assign(p,this,e)}static getTypeName(){return"AugLoop_Core_AddOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[p.getTypeName()])}}p.H_={T_:p.getTypeName(),B_:p.getBaseTypes()};class m{constructor(e){t.assign(m,this,e)}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[m.getTypeName()])}}m.H_={T_:m.getTypeName(),B_:m.getBaseTypes()};class _{constructor(e){t.assign(_,this,e)}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[_.getTypeName()])}}_.H_={T_:_.getTypeName(),B_:_.getBaseTypes()};class h{constructor(e){t.assign(h,this,e)}static getTypeName(){return"AugLoop_Core_UpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[h.getTypeName()])}}h.H_={T_:h.getTypeName(),B_:h.getBaseTypes()};class b{constructor(e){t.assign(b,this,e)}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[b.getTypeName()])}}b.H_={T_:b.getTypeName(),B_:b.getBaseTypes()};class g{constructor(e){t.assign(g,this,e)}static getTypeName(){return"AugLoop_Core_PurgeOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[g.getTypeName()])}}g.H_={T_:g.getTypeName(),B_:g.getBaseTypes()};class v{constructor(e){t.assign(v,this,e)}static getTypeName(){return"AugLoop_Core_PurgeSubtreeExceptTypesOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[v.getTypeName()])}}v.H_={T_:v.getTypeName(),B_:v.getBaseTypes()};class y{constructor(e){t.assign(y,this,e)}static getTypeName(){return"AugLoop_Core_PurgeByTypesOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[y.getTypeName()])}}y.H_={T_:y.getTypeName(),B_:y.getBaseTypes()};class S{constructor(e){t.assign(S,this,e)}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[S.getTypeName()])}}S.H_={T_:S.getTypeName(),B_:S.getBaseTypes()};class D{constructor(e){t.assign(D,this,e)}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[D.getTypeName()])}}D.H_={T_:D.getTypeName(),B_:D.getBaseTypes()};class I{constructor(e){t.assign(I,this,e)}static getTypeName(){return"AugLoop_Core_DeltaUpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[I.getTypeName()])}}I.H_={T_:I.getTypeName(),B_:I.getBaseTypes()};class x{constructor(e){t.assign(x,this,e)}static getTypeName(){return"AugLoop_Core_MicroSyncOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[x.getTypeName()])}}x.H_={T_:x.getTypeName(),B_:x.getBaseTypes()};class C{constructor(e){t.assign(C,this,e)}static getTypeName(){return"AugLoop_Signals_SignalOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[C.getTypeName()])}}C.H_={T_:C.getTypeName(),B_:C.getBaseTypes()};class O{constructor(e){t.assign(O,this,e)}static getTypeName(){return"AugLoop_Core_CancelSignalTriggeredWorkflowExecutionOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return t.matchesTypesFor(e,[O.getTypeName()])}}function w(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}O.H_={T_:O.getTypeName(),B_:O.getBaseTypes()};class E{static create(e){const t=new E(e);return t.activateAnnotation(e.responseType).then(()=>t)}constructor(e){this.config=e,this.nextMessageId=0,this.responseCallbacks=new Map;const t=["session","chats"],n=w(),a="messages",r=[...t,n];this.messagesPath=[...r,a],this.config.session.submitOperations([new p({parentPath:t,items:[{id:n,body:e.chat}]}),new p({parentPath:r,items:[{id:a,body:new i}]})])}send(e,t){const n=""+this.nextMessageId++;this.responseCallbacks.set(n,t),this.config.session.submitOperations([new p({parentPath:this.messagesPath,items:[{id:n,body:e}]})])}close(){return this.config.session.releaseAnnotation(this.activatedAnnotationToken)}activateAnnotation(e){return this.config.session.activateAnnotation(e,{callback:e=>{if(p.typeGuard(e)&&this.isUnderSubtree(e.parentPath,this.messagesPath))for(const t of e.items){const n=e.parentPath[e.parentPath.length-1],a=this.responseCallbacks.get(n);a&&(a(t.body),this.responseCallbacks.delete(n))}}}).then(({token:e})=>{this.activatedAnnotationToken=e})}isUnderSubtree(e,t){if(e.length<t.length)return!1;for(let n=0;n<t.length;n++)if(e[n]!==t[n])return!1;return!0}}class A{constructor(e){t.assign(A,this,e)}static getTypeName(){return"AugLoop_Text_TextTile"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[A.getTypeName()])}}A.H_={T_:A.getTypeName(),B_:A.getBaseTypes()};class L{constructor(e){t.assign(L,this,e)}static getTypeName(){return"AugLoop_Text_FormattedTextTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[L.getTypeName()])}}L.H_={T_:L.getTypeName(),B_:L.getBaseTypes()};class k{constructor(e){t.assign(k,this,e)}static getTypeName(){return"AugLoop_Text_DynamicTextContext"}static getBaseTypes(){return["AugLoop_Core_DynamicContext"]}static typeGuard(e){return t.matchesTypesFor(e,[k.getTypeName()])}}k.H_={T_:k.getTypeName(),B_:k.getBaseTypes()};class M{constructor(e){t.assign(M,this,e)}static getTypeName(){return"AugLoop_Text_TaskTile"}static getBaseTypes(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[M.getTypeName()])}}M.H_={T_:M.getTypeName(),B_:M.getBaseTypes()};class P{constructor(e){t.assign(P,this,e)}static getTypeName(){return"AugLoop_Text_PersonTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[P.getTypeName()])}}P.H_={T_:P.getTypeName(),B_:P.getBaseTypes()};class T{constructor(e){t.assign(T,this,e)}static getTypeName(){return"AugLoop_Text_DateTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[T.getTypeName()])}}T.H_={T_:T.getTypeName(),B_:T.getBaseTypes()};class U{constructor(e){t.assign(U,this,e)}static getTypeName(){return"AugLoop_Text_LinkTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[U.getTypeName()])}}U.H_={T_:U.getTypeName(),B_:U.getBaseTypes()};var F,H=c(676),R=c(207);!function(e){e[e.error=0]="error",e[e.warn=1]="warn",e[e.info=3]="info",e[e.metric=4]="metric",e[e.verbose=5]="verbose",e[e.debug=6]="debug",e[e.disabled=7]="disabled"}(F||(F={}));var N={util:{},roots:{default:{}}},B=(N.util,N.roots.default||(N.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.count=0,e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.traceId="",e.prototype.durationMs=0,e.prototype.success=!1,e.prototype.resultDescription="",e.prototype.resultJSON="",e.prototype.resultSignature="",e.prototype.operationName="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientDeviceId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.userTenantId="",e.prototype.joinContextId="",e.prototype.ariaTenant="",e.prototype.ariaNamespace="",e.prototype.dataFields="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/OperationEvent"},e}());const j="undefined"!=typeof process&&process.hrtime?()=>{const e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof performance&&performance.now?()=>performance.now():()=>Date.now();class V extends B{constructor(e,t){super(e),this.eventName="Operation",this.options=t,this.durationMs=null==e?void 0:e.durationMs,e&&null!=e.count||(this.count=1)}setClientMetadata(e,t){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,null!=t&&t||(this.clientFlights=e.flights),this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientDeviceId=e.deviceId,this.clientUserAgent=e.userAgent),this}setUserContext(e){return e&&(this.userId=e.puid||e.oid,this.userType=e.userType&&e.userType.toString(),this.userTenantId=e.tid),this}setMetricCustomDimensions(e,t){if(!this.options)throw new Error(`Attempting to set custom dimensions ${e} to operation ${this.operationName} without activating MetricCount or MetricDuration`);this.options.metricCustomDimensions=this.options.metricCustomDimensions||{},this.options.metricCustomDimensions[e]=t}setDataField(e,t){if(null==t)return;const n=this.dataFields?JSON.parse(this.dataFields):{};n[e]=t,this.dataFields=JSON.stringify(n)}setDataFields(e){this.dataFields?this.dataFields=JSON.stringify(Object.assign(Object.assign({},JSON.parse(this.dataFields)),e)):this.dataFields=JSON.stringify(e)}start(){return this.startTime=j(),this}recordStep(e){return this.setDataField(e,Math.floor(j()-this.startTime)),this}stop(){const e=j();return this.durationMs=Math.round(e-this.startTime),this}getMetrics(e){var t,n;const a={};if(this.operationName)switch(this.operationName){case"SessionHealthOrphanedEventsWithoutProperSessionKey":case"SessionHealthOrphanedSessions":case"WorkflowActivationState":a[this.operationName+".CountV2"]={dimensionNames:V.getOrphanedSessionHealthDimensionNames.bind(V),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case"MarkUnhealthySession":case"MarkHealthWarningSession":a[this.operationName+".Reason"]={dimensionNames:V.getSessionHealthDimensionNames.bind(V),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:if("matchmaker_timer"===this.operationName&&(a["Workflow.DurationMs"]={dimensionNames:V.getWorkflowDimensionNames.bind(V),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},a["Workflow.Count"]={dimensionNames:V.getWorkflowDimensionNames.bind(V),dimensionValues:this.getWorkflowDimensionValues(),value:1}),void 0!==this.durationMs){const n=`${this.operationName}.DurationMsV2`;((null===(t=this.options)||void 0===t?void 0:t.metricDuration)||e.indexOf(n)>=0)&&(a[n]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs})}{const t=`${this.operationName}.CountV2`;((null===(n=this.options)||void 0===n?void 0:n.metricCount)||e.indexOf(t)>=0)&&(a[t]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count})}}return a}getDimensionNames(){var e,t;let n=V.dimensionNames;if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions){n=n.slice();for(const e in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)n.push(e)}return n}getDimensionValues(){var e,t;const n=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions)for(const e in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)n.push(this.options.metricCustomDimensions[e]);return n}static getOrphanedSessionHealthDimensionNames(){return this.orphanedSessionHealthDimensionNames}getOrphanedSessionHealthDimensionValues(){return[this.success,this.clientAppName,this.clientAppPlatform,this.clientReleaseAudienceGroup,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getSessionHealthDimensionNames(){return this.sessionHealthDimensionNames}getSessionHealthDimensionValues(){return[this.resultSignature,this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getWorkflowDimensionNames(){return this.workflowDimensionNames}getWorkflowDimensionValues(){return[this.resultSignature,this.resourceId,this.resourceId,this.success]}}var z,G;V.dimensionNames=["Success","ClientAppName","ClientAppPlatform","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],V.orphanedSessionHealthDimensionNames=["Success","ClientAppName","ClientAppPlatform","ClientReleaseAudienceGroup","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],V.sessionHealthDimensionNames=["Reason","ClientAppName","ClientAppPlatform","ClientAppVersion","Dimension0","Dimension1","Dimension2","Dimension3"],V.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"],function(e){e[e.error=0]="error",e[e.warn=1]="warn",e[e.info=3]="info",e[e.metric=4]="metric",e[e.verbose=5]="verbose",e[e.debug=6]="debug",e[e.disabled=7]="disabled"}(z||(z={})),function(e){e.Log="Log"}(G||(G={}));const K="undefined"!=typeof process?{NODE_ENV:"production"}.SERVICE_NAME:"client",W="abcdefghijklmnopqrstuvwxyz0123456789",q={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35};let Q,Y=[],J=[],X=e=>null,Z=e=>{};const $=new Map,ee=new Map,te=new Map,ne=new Map;var ae;!function(e){e.defineCoreLogCategory=e=>({root:"Core",name:e}),e.defineWorkflowLogCategory=e=>({root:"Workflow",name:e}),e.clearLoggers=()=>{Y=[],J=[],ee.clear(),te.clear()},e.clearAggregators=()=>{$.clear()},e.addLogger=e=>{-1===Y.indexOf(e)&&(Y.push(e),ie(ee,e))},e.addDecidingLogger=e=>{-1===J.indexOf(e)&&(J.push(e),ie(te,e))},e.setCorrelationContextCallback=e=>{Q=e},e.setStartPerformanceEventCallback=e=>{X=e},e.setStopPerformanceEventCallback=e=>{Z=e},e.addAggregator=e=>{e.init((e,t)=>{pe(e,t)}),$.has(e.eventName)?$.get(e.eventName).push(e):$.set(e.eventName,[e])},e.flushAggregators=e=>{$.forEach(t=>{t.forEach(t=>t.flush(e))})},e.setTagLevelOverride=(e,t)=>{const n=be(e);ne.set(n,t)},e.resetTagLevelOverrides=()=>{ne.clear()},e.error=(e,t,n,a,i,r,o,s,c,d)=>{fe(e,t,z.error,n,a,i,r,o,s,c,d)},e.warn=(e,t,n,a,i,r,o,s,c,d)=>{fe(e,t,z.warn,n,a,i,r,o,s,c,d)},e.info=(e,t,n,a,i,r,o,s,c,d)=>{fe(e,t,z.info,n,a,i,r,o,s,c,d)},e.verbose=(e,t,n,a,i,r,o,s,c,d)=>{fe(e,t,z.verbose,n,a,i,r,o,s,c,d)},e.debug=(e,t,n,a,i,r,o,s,c,d)=>{fe(e,t,z.debug,n,a,i,r,o,s,c,d)},e.metric=(e,t,n,a,i,r,o,s,c,d)=>{fe(e,t,z.metric,n,a,i,r,o,s,c,d)},e.formatMetric=(e,t,n,a)=>{const i={};return i[e]={dimensionNames:n,dimensionValues:a,value:t},i},e.dynamic=e=>{pe(e)}}(ae||(ae={}));const ie=(e,t)=>{const n=t.level;Object.keys(z).map(e=>z[e]).filter(e=>"string"!=typeof e).filter(e=>e<=n).forEach(n=>{e.has(n)?e.get(n).push(t):e.set(n,[t])})},re=e=>{if("string"==typeof e)return e;let t="";for(let n=0;n<e.length;n++){n>0&&(t+=" ");const a=e[n];a instanceof Error?t+=JSON.stringify({message:a.message,name:a.name,stack:a.stack}):t+="object"==typeof a?JSON.stringify(a):a}return t},oe=[],se=["Level","Tag"],ce=["Level","Tag","Workflow"],de=e=>le(e).length,le=e=>void 0!==e?ee.get(e)||oe:Y,ue=(e,t)=>(void 0!==e?te.get(e)||[]:J).filter(e=>e.shouldLog(t)),fe=(e,t,n,a,i,r,o,s,c,d,l)=>{n=ne.get(e)||n;const u=le(n),f=ue(n,a);if(0==u.length&&0==f.length)return;const p=X(G.Log),m=he(e),_=((e,t,n,a,i,r,o,s)=>{if(void 0===t&&("string"==typeof e||"object"==typeof e))return e;if(void 0===t&&"function"==typeof e)return e();const c=[];for(const d of[e,t,n,a,i,r,o,s])void 0!==d&&c.push("function"==typeof d?d():d);return c})(a,i,r,o,s,c,d,l);if(me(t))_e(_)&&pe({eventName:"Metrics",tagId:m,category:`${t.root}.${t.name}`,traceLevel:n,message:"",getMetrics:()=>_},!1,u,f);else if(_e(_)){const e=_;e.tagId=m,e.category=`${t.root}.${t.name}`,"Operation"===e.eventName&&"Workflow"===t.root&&(e.eventName="WorkflowOperation",Q&&(e.joinContextId=Q().joinContextId,e.workflow=Q().workflow)),e.traceLevel=n;const a=$.get(e.eventName);if(a)for(let t=0;t<a.length;++t){const n=a[t];if(n&&n.add(e,t===a.length-1))break}else pe(e,!1,u,f)}else{const e=()=>{var e;return"Core"===t.root?{TraceEventV2:{dimensionNames:()=>se,dimensionValues:[String(n),m],value:1}}:{WorkflowTraceEvent:{dimensionNames:()=>ce,dimensionValues:[String(n),m,Q?null===(e=Q())||void 0===e?void 0:e.workflow:""],value:1}}};pe({eventName:"Log",tagId:m,category:`${t.root}.${t.name}`,traceLevel:n,message:re(_),getMetrics:e},!1,u,f)}Z(p)},pe=(e,t=!1,n,a)=>{var i,r,o,s,c,d,l,u,f,p,m,_;let h;if(null==n&&(n=le(e.traceLevel)),a=a||oe,n.length>0||a.length>0){if(e.serviceName=K,!t&&Q){const t=Q();t&&(h={disableLogging:t.disableLogging},e.cv=e.cv?e.cv:t.cv.toString(),e.sessionKey=e.sessionKey?e.sessionKey:t.sessionKey,e.workflow=e.workflow?e.workflow:t.workflow,e.clientAppName=e.clientAppName?e.clientAppName:null===(i=t.clientMetadata)||void 0===i?void 0:i.appName,e.clientAppPlatform=e.clientAppPlatform?e.clientAppPlatform:null===(r=t.clientMetadata)||void 0===r?void 0:r.appPlatform,e.clientAppVersion=e.clientAppVersion?e.clientAppVersion:null===(o=t.clientMetadata)||void 0===o?void 0:o.appVersion,e.clientDeviceId=e.clientDeviceId?e.clientDeviceId:null===(s=t.clientMetadata)||void 0===s?void 0:s.deviceId,e.clientDocSessionId=e.clientDocSessionId?e.clientDocSessionId:null===(c=t.clientMetadata)||void 0===c?void 0:c.docSessionId,e.clientReleaseAudienceGroup=e.clientReleaseAudienceGroup?e.clientReleaseAudienceGroup:null===(d=t.clientMetadata)||void 0===d?void 0:d.releaseAudienceGroup,e.clientReleaseChannel=e.clientReleaseChannel?e.clientReleaseChannel:null===(l=t.clientMetadata)||void 0===l?void 0:l.releaseChannel,e.clientReleaseFork=e.clientReleaseFork?e.clientReleaseFork:null===(u=t.clientMetadata)||void 0===u?void 0:u.releaseFork,e.clientRuntimeVersion=e.clientRuntimeVersion?e.clientRuntimeVersion:null===(f=t.clientMetadata)||void 0===f?void 0:f.runtimeVersion,e.clientSessionId=e.clientSessionId?e.clientSessionId:null===(p=t.clientMetadata)||void 0===p?void 0:p.sessionId,e.clientUserAgent=e.clientUserAgent?e.clientUserAgent:null===(m=t.clientMetadata)||void 0===m?void 0:m.userAgent,e.traceId=e.traceId||t.traceId,e.isClientTelemetrySampled=e.isClientTelemetrySampled?e.isClientTelemetrySampled:null===(_=t.clientMetadata)||void 0===_?void 0:_.isClientTelemetrySampled)}for(const t of n)t.log(e,h);for(const t of a)t.log(e)}},me=e=>e.name===ge.WorkflowMetricsOnly.name&&e.root===ge.WorkflowMetricsOnly.root,_e=e=>!Array.isArray(e)&&"object"==typeof e,he=e=>W[e>>24&63]+W[e>>18&63]+W[e>>12&63]+W[e>>6&63]+W[e>>0&63],be=e=>e&&5===e.length?q[e.charCodeAt(0)]<<24|q[e.charCodeAt(1)]<<18|q[e.charCodeAt(2)]<<12|q[e.charCodeAt(3)]<<6|q[e.charCodeAt(4)]:-1;class ge{}var ve,ye;ge.CoreDefault=ae.defineCoreLogCategory("Default"),ge.CoreSystem=ae.defineCoreLogCategory("System"),ge.CoreUnsampled=ae.defineCoreLogCategory("Unsampled"),ge.WorkflowDefault=ae.defineWorkflowLogCategory("Default"),ge.WorkflowUnsampled=ae.defineWorkflowLogCategory("Unsampled"),ge.WorkflowMetricsOnly=ae.defineWorkflowLogCategory("MetricsOnly"),ge.PrivacyGuardEvent=ae.defineCoreLogCategory("PrivacyGuardEvent"),function(e){e[e.ProductServiceUsage=2]="ProductServiceUsage",e[e.ProductServicePerformance=4]="ProductServicePerformance"}(ve||(ve={})),function(e){e[e.BasicEvent=10]="BasicEvent",e[e.FullEvent=100]="FullEvent",e[e.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"}(ye||(ye={}));const Se="n~",De=/\|\~/g;class Ie{constructor(){this.count=0,this.measureSums=new Map}}class xe{constructor(e,t,n,a,i){this.buckets=new Map,this.init=e=>{this.log=e},this.add=(e,t=!0)=>{if(!this.condition||!this.condition(e))return!0===t&&this.log(e,!1),!1;const n=[];for(const t of this.dimensions)if(void 0===e[t]||null===e[t])n.push(null);else{let a="";"boolean"==typeof e[t]?a="b~":"number"==typeof e[t]&&(a=Se),n.push(`${a}${e[t].toString().replace(De,"_")}`)}const a=n.join("|");let i=this.buckets.get(a);if(!i){i=new Ie,i.traceLevel=e.traceLevel;for(const e of this.avgMeasures)i.measureSums.set(e,0);this.buckets.set(a,i)}i.count++;for(const t of this.avgMeasures)e[t]&&i.measureSums.set(t,i.measureSums.get(t)+e[t]);return!0},this.flush=(e=!1)=>{this.buckets.forEach((e,t)=>{const n={traceLevel:e.traceLevel,eventName:this.eventName,count:e.count},a=t.split("|");for(let e=0;e<this.dimensions.length;e++){const t=this.dimensions[e],i=a[e];0===i.indexOf("b~")?n[t]="b~true"===i:0===i.indexOf(Se)?n[t]=parseInt(i.slice(Se.length),10):n[t]=i}for(const t of this.avgMeasures)n[t]=Math.round(e.measureSums.get(t)/e.count);this.log(n,!0)}),this.buckets.clear(),e&&(this.condition=null,clearInterval(this.interval))},this.eventName=e,this.condition=t,this.dimensions=n,this.avgMeasures=a,i>0&&(this.interval=setInterval(this.flush,1e3*i))}}const Ce=["cloud-dev.microsoft","officeppe.com","cloud.microsoft","office.com","office365.us","ic.gov","microsoft.scloud","microsoftonline.cn"],Oe=(e,t,n,a)=>new xe(e,e=>e.success&&n.indexOf(e[t])>=0,[t,"ariaNamespace","resourceId","success","resultSignature","clientDocSessionId","dimension0","dimension1","dimension2","dimension3"],["durationMs"],a),we=e=>{if(!e)return e;for(const t of Ce)if(e.indexOf(t)>=0)return e;return"**redacted**"};class Ee{constructor(e){this.level=F.info,this.hostCallbacks=e}log(e){if(null==this.hostCallbacks||null==this.hostCallbacks.sendTelemetryEvent)return;const t=(e,t,n,a,i)=>{let r=t.charAt(0).toUpperCase()+t.slice(1),o={DocSessionId:e.clientDocSessionId,ResourceId:e.resourceId,ResultDescription:e.resultDescription,ResultSignature:e.resultSignature,Dimension0:e.dimension0,Dimension1:e.dimension1,Dimension2:e.dimension2,Dimension3:e.dimension3,JoinContextId:e.joinContextId,ServerSessionKey:this.serverSessionKey};n&&(o=Object.assign(Object.assign({},o),JSON.parse(n)));const s=a||Ee.augLoopAriaTenantToken,c=i||s!=Ee.augLoopAriaTenantToken?i:Ee.augLoopAriaNamespace;r=r||Ee.operationNamePlaceholder;const d={CV:e.cv,Duration:1e3*(e.durationMs||0),Count:e.count,AggMode:2,Success:e.success};this.hostCallbacks.sendTelemetryEvent(s,c?`${c}_${r}`:r,o,"Office.System.Activity",d,!1,ve.ProductServiceUsage|ve.ProductServicePerformance,ye.RequiredServiceDataEvent)};if("Workflow.MetricsOnly"==e.category);else if("Operation"===e.eventName){const n=e;t(n,n.operationName,n.dataFields,void 0,n.ariaNamespace)}else if("SessionHealth"===e.eventName)t(e,e.sessionHealthEventName);else if("WorkflowOperation"===e.eventName){const n=e;t(n,n.operationName,n.dataFields,n.ariaTenant,n.ariaNamespace)}else"Log"===e.eventName&&((e,t,n)=>{this.hostCallbacks.sendDiagnosticTrace&&this.hostCallbacks.sendDiagnosticTrace(e,t,n)})(e.tagId,e.traceLevel,e.message)}setServerSessionKey(e){this.serverSessionKey=e}}Ee.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770",Ee.augLoopAriaNamespace="Office_AugLoop_Client",Ee.operationNamePlaceholder="OperationNameNotProvided";var Ae=c(875),Le=c.n(Ae);class ke{constructor(){this.hadEgressError=!1,this.isClosing=!1,this.pendingEgress=[]}init(e,t,n,a,i){this.ws=new(Le())(e),this.logOp=new V({operationName:ke.className,success:!0}).start(),this.logOp.setClientMetadata(i,!0),this.ingressByteCountOp=new V({operationName:"WSIngressByteOrderOfMagnitude",success:!0}),this.ingressByteCountOp.setClientMetadata(i,!0),this.ws.addEventListener("open",e=>{n(),this.logOp.resourceId="OnOpen",this.logOp.resultDescription="",this.logOp.success=!0,this.logOp.dimension0=this.pendingEgress.length.toString(),ae.info(508843801,ge.CoreDefault,this.logOp.stop())}),this.ws.addEventListener("message",e=>{this.logIngressCount(e.data),t(e.data)}),this.ws.addEventListener("error",e=>{this.errorMessage=e.message,this.logOp.resourceId="OnError",this.logOp.resultDescription=this.errorMessage,this.logOp.success=!1,ae.info(508843800,ge.CoreDefault,this.logOp.stop()),this.ws.close()}),this.ws.addEventListener("close",e=>{this.logOp.resourceId="OnClose",this.logOp.resultDescription=e?`code: ${e.code}. reason: ${e.reason}`:"",this.logOp.success=!0,ae.info(508843799,ge.CoreDefault,this.logOp.stop()),a(this.errorMessage),this.isClosing=!1})}egress(e){const t=e.obj;this.ws.send(t,e=>{e&&!this.hadEgressError&&(this.hadEgressError=!0,this.logOp.resourceId="OnEgressError",this.logOp.resultDescription=e.message,this.logOp.success=!1,ae.info(508843797,ge.CoreDefault,this.logOp.stop()))})}close(){this.isClosing||(this.isClosing=!0,this.ws.close())}logIngressCount(e){const t=e.length;t>1e5&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=t.toString().length.toString(),ae.info(508843794,ge.CoreDefault,this.ingressByteCountOp.stop()))}}ke.className="WebSocketWorker";class Me{constructor(e){this.childCount=0,this.id=e||function(){for(let e=0;e<22;e++)Te[e]=Pe[Math.floor(Math.random()*Pe.length)];return Te.join("")}()}static fromString(e,t){if(!e)throw new Error("Received invalid correlation vector string");let n;return n=e.endsWith(".0")?new Me(e.substring(0,e.length-2)):new Me(e),t&&(n.childCount=t),n}newChild(){return++this.childCount,new Me(this.id+"."+this.childCount.toString())}toString(){return this.id.length>127?this.id.substring(0,127)+"!":this.id}}const Pe=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],Te=new Array(22);var Ue,Fe,He,Re={util:{},roots:{default:{}}},Ne=(Re.util,Re.roots.default||(Re.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.traceId="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientDeviceId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.userTenantId="",e.prototype.sessionHealthEventName="",e.prototype.source="",e.prototype.reason="",e.prototype.reasonDependency="",e.prototype.subReason="",e.prototype.impact="",e.prototype.success=!1,e.prototype.durationMs=0,e.prototype.count=0,e.prototype.message="",e.prototype.affectedWorkflows="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.resultDescription="",e.prototype.resultSignature="",e.prototype.joinContextId="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/SessionHealthEvent"},e}());!function(e){e[e.Unknown=0]="Unknown",e[e.Core=1]="Core",e[e.Workflow=2]="Workflow",e[e.SessionExtension=3]="SessionExtension",e[e.Client=4]="Client",e[e.ClientRuntime=5]="ClientRuntime"}(Ue||(Ue={})),function(e){e[e.Unknown=0]="Unknown",e[e.Core=1]="Core",e[e.Workflow=2]="Workflow",e[e.SessionExtension=3]="SessionExtension",e[e.Client=4]="Client",e[e.Network=5]="Network",e[e.AugLoopDependency=6]="AugLoopDependency",e[e.WorkflowDependency=7]="WorkflowDependency",e[e.ClientRuntime=8]="ClientRuntime"}(Fe||(Fe={})),function(e){e[e.Unknown=0]="Unknown",e[e.None=1]="None",e[e.MissingInput=2]="MissingInput",e[e.MissingOutput=3]="MissingOutput"}(He||(He={}));class Be extends Ne{constructor(e,t){var n,a;super({source:Ue[e.source],reason:Fe[e.reason],reasonDependency:e.reasonDependency,subReason:e.subReason,sessionHealthEventName:e.sessionHealthEventName,impact:He[e.impact],success:e.success,durationMs:null!==(n=e.durationMs)&&void 0!==n?n:0,count:"number"==typeof e.count?e.count:1,message:e.message,affectedWorkflows:(null!==(a=e.affectedWorkflows)&&void 0!==a?a:[]).join(","),resourceId:e.resourceId,dimension0:e.dimension0,dimension1:e.dimension1,dimension2:e.dimension2,dimension3:e.dimension3,cv:e.cv,resultSignature:e.resultSignature,resultDescription:e.resultDescription,joinContextId:e.joinContextId}),this.eventName="SessionHealth",t&&this.setClientMetadata(t),this.metricCount=e.metricCount,this.metricDuration=e.metricDuration}getMetrics(){const e={};return(void 0===this.metricCount||this.metricCount)&&(e[`${this.sessionHealthEventName}.CountV2`]={dimensionNames:()=>Be.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.count}),(void 0===this.metricDuration||this.metricDuration)&&(e[`${this.sessionHealthEventName}.DurationMsV2`]={dimensionNames:()=>Be.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.durationMs}),e}setClientMetadata(e){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,this.clientFlights=e.flights,this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientUserAgent=e.userAgent,this.clientDeviceId=e.deviceId),this}setUserContext(e){return e&&(this.userId=e.puid||e.oid,this.userType=e.userType&&e.userType.toString(),this.userTenantId=e.tid),this}setReason(e){return this.reason=Fe[e],this}setSource(e){return this.source=Ue[e],this}setImpact(e){return this.impact=He[e],this}setAffectedWorkflows(e){return this.affectedWorkflows=(null!=e?e:[]).join(","),this}getAffectedWorkflows(){return this.affectedWorkflows.split(",")}start(){return this.startTime=j(),this}stop(){const e=j();return this.durationMs=Math.round(e-this.startTime),this}getDimensionValues(){var e;return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0",`${this.reason}_${this.reasonDependency}`,this.impact,null!==(e=this.getAffectedWorkflows()[0])&&void 0!==e?e:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}Be.dimensionNames=["ClientAppName","ClientAppPlatform","ClientAppVersion","Success","Reason","Impact","FirstAffectedWorkflow","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];var je=c(209),Ve=c.n(je);class ze{constructor(){this.listeners=new Map,this.lastId=0}addListener(e){if(!e)throw new Error("No callback provided for data listener");return this.listeners.set(this.lastId,e),this.lastId++}removeListener(e){this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(t=>{t(e)})}}var Ge=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};class Ke extends ze{constructor(e){super(),this.name=e}static initEcsSettingsProvider(e){Ke.ecsSettingsProvider=e}static getInstance(e){let t=this.allSettings.get(e);if(!t){t=new Ke(e);const n=Ke.tryGetConfigProperty(Ke.currentConfig,e);n.success&&t.updateValue(n.value),this.allSettings.set(e,t)}return t}static getPatternInstance(e){let t=this.allPatternSettings.get(e);if(!t){t={regex:new RegExp(e),setting:new Ke(e)};const n=Ke.tryGetConfigPropertyByPattern(Ke.currentConfig,t.regex);t.setting.updateValue(n),this.allPatternSettings.set(e,t)}return t.setting}static setNewConfig(e){Ke.currentConfig=e,ae.info(572837966,ge.CoreDefault,`New config: ${JSON.stringify(e)}`),Ke.allSettings.forEach((e,t)=>{const n=Ke.tryGetConfigProperty(Ke.currentConfig,t).value;e.updateValue(n)&&(ae.info(572837967,ge.CoreDefault,`Setting new value for ${t}: ${n instanceof Object?JSON.stringify(n):n}`),e.notifyListeners(n))}),Ke.allPatternSettings.forEach((t,n)=>{const a=Ke.tryGetConfigPropertyByPattern(e,t.regex);t.setting.updateValue(a)&&(ae.info(508432774,ge.CoreDefault,`Setting new value for pattern ${n}: ${JSON.stringify(a)}`),t.setting.notifyListeners(a))})}static tryGetConfigProperty(e,t){return e&&e.hasOwnProperty(t)?{success:!0,value:Ke.selectApplicableValue(e[t])}:{success:!1,value:void 0}}static tryGetConfigPropertyByPattern(e,t){const n=[];if(e){const a=Object.getOwnPropertyNames(e).filter(e=>t.test(e));for(const t of a)n.push({name:t,value:Ke.selectApplicableValue(e[t])})}return n}static setGlobalFilter(e){Ke.globalFilter=e}static setLocalConfig(e){Ke.localConfig=e,ae.info(506053841,ge.CoreDefault,`Setting localConfig field in Setting class: ${JSON.stringify(Ke.localConfig)}`)}static clear(){Ke.currentConfig=void 0,Ke.allSettings.clear(),Ke.allPatternSettings.clear()}static selectApplicableValue(e){let t;if(e){const n=e.find(e=>!Ke.globalFilter||Ke.globalFilter(e));n&&(t=n.value)}return t}getName(){return this.name}getValue(){if(function(){var e;return void 0!==globalThis.process&&"true"===(null===(e=globalThis.process.env)||void 0===e?void 0:e.VALIDATE_CORRECT_USAGE_OF_GET_VALUE)}()&&0===this.listeners.size){const e=new Error("getValue() has been invoked incorrectly for ModuleSettings. Make sure getValue() is called during runtime or there is a listener set up on the setting.");throw e.name="Incorrect usage of getValue()",e}return this.value}getValueAdvancedAsync(e){return Ge(this,void 0,void 0,function*(){const t=new V({operationName:"ECSGetValueAsync"},{metricDuration:!0}).start();try{const n=yield Ke.ecsSettingsProvider.getSettingValue(this.name,e);return t.dimension0=n.userAuthenticated?"Authenticated":"Anonymous",n.value||Ke.tryGetConfigProperty(Ke.localConfig,this.name).value}catch(e){return Ke.tryGetConfigProperty(Ke.localConfig,this.name).value}finally{ae.info(506053839,ge.CoreDefault,t.stop())}})}updateValue(e){return!Ve()(this.value,e)&&(ae.info(572837968,ge.CoreDefault,`Received new property value for ${this.getName()}:`,e),this.value=e,!0)}}Ke.allSettings=new Map,Ke.allPatternSettings=new Map;const We=new class extends ze{constructor(e,t){super(),this.listenerId=NaN,this.defaultValue=t,this.setting=Ke.getInstance(e)}getDefaultValue(){return this.defaultValue}addListener(e){return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(()=>{this.notifyListeners(this.getValue())})),super.addListener(e)}removeListener(e){super.removeListener(e),0!=this.listeners.size||Number.isNaN(this.listenerId)||(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}getValue(){const e=this.setting.getValue();return void 0===e?this.defaultValue:e}getValueAdvancedAsync(e){return Ge(this,void 0,void 0,function*(){const t=yield this.setting.getValueAdvancedAsync(e);return void 0===t?this.defaultValue:t})}}("disabledChangeGates",[]),qe=(e,t,...n)=>{const a=-1===We.getValue().indexOf(e);return t?a?t(...n):void 0:a};var Qe,Ye,Je,Xe,Ze,$e,et,tt,nt;!function(e){e[e.ServerError=0]="ServerError",e[e.WorkflowDisabled=100]="WorkflowDisabled",e[e.TokenNotReady=101]="TokenNotReady",e[e.FlightNotReady=102]="FlightNotReady",e[e.ContextNotReady=103]="ContextNotReady",e[e.WorkflowExcluded=104]="WorkflowExcluded",e[e.WorkflowExecutionTimeout=105]="WorkflowExecutionTimeout",e[e.LambdaExecutionError=106]="LambdaExecutionError",e[e.UnexpectedOutput=107]="UnexpectedOutput"}(Qe||(Qe={})),function(e){e[e.Unknown=0]="Unknown",e[e.InvalidRequest=1]="InvalidRequest",e[e.InvalidResponse=2]="InvalidResponse",e[e.RuntimeNotInitialized=3]="RuntimeNotInitialized",e[e.RequestCancelled=4]="RequestCancelled",e[e.ResponseReceivedAfterFinalResponse=5]="ResponseReceivedAfterFinalResponse"}(Ye||(Ye={})),function(e){e[e.Unknown=0]="Unknown",e[e.Found=302]="Found",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.RequestEntityTooLarge=413]="RequestEntityTooLarge",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.UnprocessableContent=422]="UnprocessableContent",e[e.TooManyRequests=429]="TooManyRequests",e[e.SocketDisconnect=499]="SocketDisconnect",e[e.InternalServerError=500]="InternalServerError",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.UnsupportedMessage=1e3]="UnsupportedMessage",e[e.Cancelled=1001]="Cancelled",e[e.EgressError=1002]="EgressError",e[e.SyncMessageException=2e3]="SyncMessageException",e[e.SyncMessageUnsupported=2001]="SyncMessageUnsupported",e[e.SyncMessageUnexpectedSeed=2002]="SyncMessageUnexpectedSeed",e[e.SyncMessageUnsupportedBatch=2003]="SyncMessageUnsupportedBatch",e[e.SyncMessageQueueFull=2004]="SyncMessageQueueFull",e[e.SyncMessageTooLateOrDuplicate=2005]="SyncMessageTooLateOrDuplicate",e[e.SyncMessageGroupIdMismatch=2006]="SyncMessageGroupIdMismatch",e[e.SyncMessageGroupStop=2007]="SyncMessageGroupStop",e[e.SyncMessageLost=2008]="SyncMessageLost",e[e.SyncMessageUnprocessedDuplicate=2009]="SyncMessageUnprocessedDuplicate",e[e.SyncMessageSessionClosed=2010]="SyncMessageSessionClosed",e[e.SyncMessageAbandoned=2011]="SyncMessageAbandoned",e[e.SyncMessageTooManyDeltaOperations=2012]="SyncMessageTooManyDeltaOperations",e[e.SyncMessageSessionSizeLimitExceeded=2013]="SyncMessageSessionSizeLimitExceeded",e[e.TokenValidationError=2100]="TokenValidationError",e[e.TokenDecryptError=2101]="TokenDecryptError",e[e.TokenTypeError=2102]="TokenTypeError",e[e.TokenUserBlocked=2103]="TokenUserBlocked",e[e.AnnotationActivationInvalidType=2200]="AnnotationActivationInvalidType",e[e.AnnotationReleaseTokenNotFound=2300]="AnnotationReleaseTokenNotFound"}(Je||(Je={})),function(e){e[e.UnKnown=0]="UnKnown",e[e.Start=1]="Start",e[e.Regular=2]="Regular",e[e.CheckConnection=3]="CheckConnection",e[e.PostEgress=4]="PostEgress",e[e.TimeoutResend=5]="TimeoutResend",e[e.FailResend=6]="FailResend"}(Xe||(Xe={})),function(e){e[e.IdentityChange=0]="IdentityChange"}(Ze||(Ze={})),function(e){e[e.Idle=0]="Idle",e[e.Pending=1]="Pending"}($e||($e={})),function(e){e[e.NotStarted=0]="NotStarted",e[e.Started=1]="Started",e[e.Incomplete=2]="Incomplete",e[e.Finished=3]="Finished"}(et||(et={}));class at{constructor(e){t.assign(at,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[at.getTypeName()])}}at.H_={T_:at.getTypeName(),B_:at.getBaseTypes()};class it{constructor(e){t.assign(it,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Response"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[it.getTypeName()])}}it.H_={T_:it.getTypeName(),B_:it.getBaseTypes()};class rt{constructor(e){t.assign(rt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_StreamingResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[rt.getTypeName()])}}rt.H_={T_:rt.getTypeName(),B_:rt.getBaseTypes()};class ot{constructor(e){t.assign(ot,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_StreamingRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[ot.getTypeName()])}}ot.H_={T_:ot.getTypeName(),B_:ot.getBaseTypes()};class st{constructor(e){t.assign(st,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ExecutionError"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[st.getTypeName()])}}st.H_={T_:st.getTypeName(),B_:st.getBaseTypes()};class ct{constructor(e){t.assign(ct,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetAnnotationsClientError"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[ct.getTypeName()])}}ct.H_={T_:ct.getTypeName(),B_:ct.getBaseTypes()};class dt{constructor(e){t.assign(dt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetAnnotationsErrorInfo"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[dt.getTypeName()])}}dt.H_={T_:dt.getTypeName(),B_:dt.getBaseTypes()};class lt{constructor(e){t.assign(lt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[lt.getTypeName()])}}lt.H_={T_:lt.getTypeName(),B_:lt.getBaseTypes()};class ut{constructor(e){t.assign(ut,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TimeoutErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[ut.getTypeName()])}}ut.H_={T_:ut.getTypeName(),B_:ut.getBaseTypes()};class ft{constructor(e){t.assign(ft,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_RateLimitErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[ft.getTypeName()])}}ft.H_={T_:ft.getTypeName(),B_:ft.getBaseTypes()};class pt{constructor(e){t.assign(pt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[pt.getTypeName()])}}pt.H_={T_:pt.getTypeName(),B_:pt.getBaseTypes()};class mt{constructor(e){t.assign(mt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[mt.getTypeName()])}}mt.H_={T_:mt.getTypeName(),B_:mt.getBaseTypes()};class _t{constructor(e){t.assign(_t,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionLongPollMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[_t.getTypeName()])}}_t.H_={T_:_t.getTypeName(),B_:_t.getBaseTypes()};class ht{constructor(e){t.assign(ht,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionLongPollResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[ht.getTypeName()])}}ht.H_={T_:ht.getTypeName(),B_:ht.getBaseTypes()};class bt{constructor(e){t.assign(bt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseReason"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[bt.getTypeName()])}}bt.H_={T_:bt.getTypeName(),B_:bt.getBaseTypes()};class gt{constructor(e){t.assign(gt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionSwapOnClose"}static getBaseTypes(){return["AugLoop_Session_Protocol_SessionCloseReason"]}static typeGuard(e){return t.matchesTypesFor(e,[gt.getTypeName()])}}gt.H_={T_:gt.getTypeName(),B_:gt.getBaseTypes()};class vt{constructor(e){t.assign(vt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[vt.getTypeName()])}}vt.H_={T_:vt.getTypeName(),B_:vt.getBaseTypes()};class yt{constructor(e){t.assign(yt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[yt.getTypeName()])}}yt.H_={T_:yt.getTypeName(),B_:yt.getBaseTypes()};class St{constructor(e){t.assign(St,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[St.getTypeName()])}}St.H_={T_:St.getTypeName(),B_:St.getBaseTypes()};class Dt{constructor(e){t.assign(Dt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Dt.getTypeName()])}}Dt.H_={T_:Dt.getTypeName(),B_:Dt.getBaseTypes()};class It{constructor(e){t.assign(It,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[It.getTypeName()])}}It.H_={T_:It.getTypeName(),B_:It.getBaseTypes()};class xt{constructor(e){t.assign(xt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultStateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[xt.getTypeName()])}}xt.H_={T_:xt.getTypeName(),B_:xt.getBaseTypes()};class Ct{constructor(e){t.assign(Ct,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Ct.getTypeName()])}}Ct.H_={T_:Ct.getTypeName(),B_:Ct.getBaseTypes()};class Ot{constructor(e){t.assign(Ot,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Ot.getTypeName()])}}Ot.H_={T_:Ot.getTypeName(),B_:Ot.getBaseTypes()};class wt{constructor(e){t.assign(wt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[wt.getTypeName()])}}wt.H_={T_:wt.getTypeName(),B_:wt.getBaseTypes()};class Et{constructor(e){t.assign(Et,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Et.getTypeName()])}}Et.H_={T_:Et.getTypeName(),B_:Et.getBaseTypes()};class At{constructor(e){t.assign(At,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_BatchedMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[At.getTypeName()])}}At.H_={T_:At.getTypeName(),B_:At.getBaseTypes()};class Lt{constructor(e){t.assign(Lt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Lt.getTypeName()])}}Lt.H_={T_:Lt.getTypeName(),B_:Lt.getBaseTypes()};class kt{constructor(e){t.assign(kt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[kt.getTypeName()])}}kt.H_={T_:kt.getTypeName(),B_:kt.getBaseTypes()};class Mt{constructor(e){t.assign(Mt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SyncResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Mt.getTypeName()])}}Mt.H_={T_:Mt.getTypeName(),B_:Mt.getBaseTypes()};class Pt{constructor(e){t.assign(Pt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionDeleteMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Pt.getTypeName()])}}Pt.H_={T_:Pt.getTypeName(),B_:Pt.getBaseTypes()};class Tt{constructor(e){t.assign(Tt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultsMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Tt.getTypeName()])}}Tt.H_={T_:Tt.getTypeName(),B_:Tt.getBaseTypes()};class Ut{constructor(e){t.assign(Ut,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Ut.getTypeName()])}}Ut.H_={T_:Ut.getTypeName(),B_:Ut.getBaseTypes()};class Ft{constructor(e){t.assign(Ft,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenFailureMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Ft.getTypeName()])}}Ft.H_={T_:Ft.getTypeName(),B_:Ft.getBaseTypes()};class Ht{constructor(e){t.assign(Ht,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Ht.getTypeName()])}}Ht.H_={T_:Ht.getTypeName(),B_:Ht.getBaseTypes()};class Rt{constructor(e){t.assign(Rt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_KeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Rt.getTypeName()])}}Rt.H_={T_:Rt.getTypeName(),B_:Rt.getBaseTypes()};class Nt{constructor(e){t.assign(Nt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Nt.getTypeName()])}}Nt.H_={T_:Nt.getTypeName(),B_:Nt.getBaseTypes()};class Bt{constructor(e){t.assign(Bt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Bt.getTypeName()])}}Bt.H_={T_:Bt.getTypeName(),B_:Bt.getBaseTypes()};class jt{constructor(e){t.assign(jt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionCompleteMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[jt.getTypeName()])}}jt.H_={T_:jt.getTypeName(),B_:jt.getBaseTypes()};class Vt{constructor(e){t.assign(Vt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SeedingStatusChangeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Vt.getTypeName()])}}Vt.H_={T_:Vt.getTypeName(),B_:Vt.getBaseTypes()};class zt{constructor(e){t.assign(zt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitV2Message"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[zt.getTypeName()])}}zt.H_={T_:zt.getTypeName(),B_:zt.getBaseTypes()};class Gt{constructor(e){t.assign(Gt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitV2Response"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Gt.getTypeName()])}}Gt.H_={T_:Gt.getTypeName(),B_:Gt.getBaseTypes()};class Kt{constructor(e){t.assign(Kt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Kt.getTypeName()])}}Kt.H_={T_:Kt.getTypeName(),B_:Kt.getBaseTypes()};class Wt{constructor(e){t.assign(Wt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Wt.getTypeName()])}}Wt.H_={T_:Wt.getTypeName(),B_:Wt.getBaseTypes()};class qt{constructor(e){t.assign(qt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2CallbackMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[qt.getTypeName()])}}qt.H_={T_:qt.getTypeName(),B_:qt.getBaseTypes()};class Qt{constructor(e){t.assign(Qt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_BridgeMessage"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[Qt.getTypeName()])}}Qt.H_={T_:Qt.getTypeName(),B_:Qt.getBaseTypes()};class Yt{constructor(e){t.assign(Yt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionConnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Yt.getTypeName()])}}Yt.H_={T_:Yt.getTypeName(),B_:Yt.getBaseTypes()};class Jt{constructor(e){t.assign(Jt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionDisconnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Jt.getTypeName()])}}Jt.H_={T_:Jt.getTypeName(),B_:Jt.getBaseTypes()};class Xt{constructor(e){t.assign(Xt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionReconnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Xt.getTypeName()])}}Xt.H_={T_:Xt.getTypeName(),B_:Xt.getBaseTypes()};class Zt{constructor(e){t.assign(Zt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SubmittedCustomMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Zt.getTypeName()])}}Zt.H_={T_:Zt.getTypeName(),B_:Zt.getBaseTypes()};class $t{constructor(e){t.assign($t,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ServerAuthenticationStateChangeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[$t.getTypeName()])}}$t.H_={T_:$t.getTypeName(),B_:$t.getBaseTypes()};class en{constructor(e){t.assign(en,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ClaimsChallengeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[en.getTypeName()])}}en.H_={T_:en.getTypeName(),B_:en.getBaseTypes()};class tn{constructor(e){t.assign(tn,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_BlobUploadResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[tn.getTypeName()])}}tn.H_={T_:tn.getTypeName(),B_:tn.getBaseTypes()};class nn{constructor(e){t.assign(nn,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetPluginsMetadataMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[nn.getTypeName()])}}nn.H_={T_:nn.getTypeName(),B_:nn.getBaseTypes()};class an{constructor(e){t.assign(an,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetPluginsMetadataResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[an.getTypeName()])}}an.H_={T_:an.getTypeName(),B_:an.getBaseTypes()};class rn{constructor(e){if(this.cache=new Map,this.options=e||{sweepInterval:100},null!=this.options.idleDurationMs&&this.options.idleDurationMs<=0)throw new Error("Idle duration must be positive");if(this.interval=this.options.sweepInterval||100,this.interval<=0)throw new Error("Sweep interval must be a positive number")}static setLogIntervalError(e){rn.logIntervalError=e}put(e,t,n,a,i,r,o){if(null==n||n<=0)throw new Error("Cache timeout must be a positive number");(null==i||i<=0)&&(i=this.options.idleDurationMs);const s={value:t,lastUsed:i?Date.now():void 0,expire:n+Date.now(),idleDurationMs:i,expireCallback:a,expiringTriggerTime:r+Date.now(),expiringCallback:o};return this.cache.set(e,s),this.timeout||(this.timeout=setInterval(this.onInterval.bind(this),this.interval),this.timeout.unref&&this.timeout.unref()),t}del(e){if(this.options.delCallback){const t=this.cache.get(e);t&&this.options.delCallback(e,t.value)}const t=this.cache.delete(e);return 0===this.size()&&this.clear(),t}clear(){this.timeout&&(clearInterval(this.timeout),this.timeout=void 0),this.cache.clear()}get(e){let t=this.cache.get(e);if(t){if(this.options.idleDurationMs&&(t.lastUsed=Date.now()),t.expire<Date.now()&&(this.del(e),t.expireCallback&&t.expireCallback(e,t.value),t=this.cache.get(e),!t))return;return t.value}}keys(){return this.cache.keys()}forEach(e){this.cache.forEach((t,n)=>{e(t.value,n)})}size(){return this.cache.size}updateExpireTime(e,t){return!!(this.cache.has(e)&&t>=0)&&(this.cache.get(e).expire=t+Date.now(),!0)}onInterval(){const e=Date.now();this.cache.forEach((t,n)=>{try{if(t.idleDurationMs&&t.lastUsed<e-t.idleDurationMs)return this.del(n),void(this.options.idleCallback&&this.options.idleCallback(n,t.value));t.expire<e&&(this.del(n),t.expireCallback&&t.expireCallback(n,t.value)),t.expiringTriggerTime<e&&t.expiringCallback&&(t.expiringCallback(n,t.value),t.expiringCallback=void 0)}catch(e){rn.logIntervalError&&rn.logIntervalError(e)}})}}function on(e){const t=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"];let n;for(const a of t)if(0===e.indexOf(a)){n=a;break}if(!n)return"MalformedMessageName";const a="Message",i=e.indexOf(a,e.length-a.length)===e.length-a.length;return e.slice(n.length,i?-a.length:void 0)}!function(e){e.ClientDisconnected="Client disconnected.",e.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.",e.UnexpectedSeedMessage="Unexpected seed message",e.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.",e.AnnotationTokenNotFound="Token not found",e.TooManyDeltaOperations="SyncMessage with too many delta operations"}(tt||(tt={})),function(e){e.ProvisionTokenValidationError="Token provision message didn't pass token validation.",e.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."}(nt||(nt={}));class sn{constructor(e){this.config=e,this.nextMessageId=1,this.pendingResponseCallbacks=new rn({sweepInterval:5e3}),this.messageCallbacks=new Map,this.messageIdPrefix=e.messageIdPrefix,this.source="c"===e.messageIdPrefix?Ue.ClientRuntime:Ue.Core,this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}setClientMetadata(e){this.clientMetadata=e}setEgress(e){this.egress=e,this.config.resendPendingMessagesOnReconnect&&this.egress&&this.pendingResponseCallbacks.forEach((e,t)=>{e.logOp.dimension1=(e.sendCount++).toString(),this.egress(e.message,t=>this.onEgressError(t,e))})}ingress(e,t){it.typeGuard(e)?(this.processResponse(e),t()):this.processMessage(e,t),vt.typeGuard(e)&&!e.reconnectAllowed&&this.clearAllPendingResponses()}sendMessage(e,n,a,i=0){var r,o;const s=new Be({sessionHealthEventName:"SendMessage",source:this.source,reason:Fe.Client,impact:this.source===Ue.ClientRuntime?He.MissingInput:He.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv,resourceId:on(t.getTypeNameFor(e)),dimension0:i.toString()}).start(),c=()=>{if(s.setClientMetadata(this.clientMetadata),s.success)ae.info(572836e3,ge.CoreDefault,s.stop());else{const e="ErrorWithoutPendingResponse"===s.resultSignature||"ResponseCallbackException"===s.resultSignature||"We called into done callback"!==s.message;s.message=JSON.stringify({errorNotPropagatedToDoneCallback:e}),ae.error(572836001,ge.CoreDefault,s.stop())}};qe("PersistMessageId")?e.messageId=null!==(r=e.messageId)&&void 0!==r?r:`${this.messageIdPrefix}${this.nextMessageId++}`:e.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`,At.typeGuard(e)&&e.messages.forEach((t,n)=>t.messageId=e.messageId+"."+n);const d=t.getTypeNameFor(e)===vt.getTypeName(),l={message:e,logOp:s,logEvent:c,callback:void 0,sendCount:1};if(!a&&!d){l.callback=(a,i)=>{var r;if(a?qe("IgnoreUnsupportedMessageErrorForOldClientVersion")&&a.code===Je.UnsupportedMessage?(s.resultSignature="Success",s.resultDescription=`Ignore error for ${t.getTypeNameFor(e)} message ${e.messageId}${Lt.typeGuard(e)?`, seq ${e.seq}`:""}: ${a.error}`):(s.success=!1,s.resultSignature=a.error,s.resultDescription=`Error for ${t.getTypeNameFor(e)} message ${e.messageId}${Lt.typeGuard(e)?`, seq ${e.seq}`:""}: ${a.error}`):s.resultSignature="Success",n)try{s.message="We called into done callback",n(a,i)}catch(e){s.success=!1,s.resultSignature="ResponseCallbackException",s.resultDescription="Web"===(null===(r=this.clientMetadata)||void 0===r?void 0:r.appPlatform)?JSON.stringify({message:e.message,stack:e.stack}):JSON.stringify({message:e.message})}c(),this.updateSendMessageStats(s.success,s.durationMs,a?new Error(a.error):void 0)};const a=()=>{l.callback(new ut({code:Je.RequestTimeout,error:"Timeout waiting for response"}),void 0)};let i=this.config.responseTimeoutMs;if(_t.typeGuard(e)){const t=e;i=t.longPollTimeoutHint>=15e3&&t.longPollTimeoutHint<=3e5?t.longPollTimeoutHint+5e3:12e4}else ot.typeGuard(e)&&(i=null!==(o=e.maxDelayMs)&&void 0!==o?o:12e4);this.pendingResponseCallbacks.put(e.messageId,l,i,a)}this.egress&&this.egress(e,e=>this.onEgressError(e,l),i)}onEgressError(e,n){var a,i;if(e){const r=n.message,o=this.pendingResponseCallbacks.get(n.message.messageId);o?(this.pendingResponseCallbacks.del(r.messageId),o.callback(new lt({messageId:r.messageId,code:Je.EgressError,error:e.message}))):vt.typeGuard(r)?(n.logOp.success=null!==(i=null===(a=e.message)||void 0===a?void 0:a.endsWith("Client disconnected."))&&void 0!==i&&i,n.logOp.resultSignature="ErrorSendingSessionCloseMessage",n.logOp.resultDescription=`Error for ${t.getTypeNameFor(r)} message ${r.messageId}: ${e.message}`,n.logEvent()):(n.logOp.success=!1,n.logOp.resultSignature="ErrorWithoutPendingResponse",n.logOp.resultDescription=`Error for ${t.getTypeNameFor(r)} message ${r.messageId}: ${e.message}`,n.logEvent())}}queryEgressCacheSize(){return this.pendingResponseCallbacks.size()}onMessage(e,t){this.messageCallbacks.set(e,t)}onMessageAsync(e,t){this.messageCallbacks.set(e,(e,n)=>{return a=this,void 0,r=function*(){try{const a=yield t(e);lt.typeGuard(a)?n(a,void 0):n(void 0,a)}catch(e){n(e)}},new((i=void 0)||(i=Promise))(function(e,t){function n(e){try{s(r.next(e))}catch(e){t(e)}}function o(e){try{s(r.throw(e))}catch(e){t(e)}}function s(t){var a;t.done?e(t.value):(a=t.value,a instanceof i?a:new i(function(e){e(a)})).then(n,o)}s((r=r.apply(a,[])).next())});var a,i,r})}getStats(){return this.stats}hasMessageCallback(e){return this.messageCallbacks.has(e)}cancelPendingResponseCallbacks(){this.pendingResponseCallbacks.forEach((e,t)=>{e&&(this.pendingResponseCallbacks.del(t),e.callback(new lt({messageId:t,code:Je.Cancelled,error:"Cancelled"})))})}clearAllPendingResponses(){if(0==this.pendingResponseCallbacks.size())return;const e=new V({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});ae.info(572836002,ge.CoreDefault,e),this.pendingResponseCallbacks.clear()}processMessage(e,n){const a=new Be({sessionHealthEventName:"ProcessMessage",source:this.source,reason:Fe.Client,impact:this.source===Ue.ClientRuntime?He.MissingOutput:He.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv}).start(),i=()=>{if(a.setClientMetadata(this.clientMetadata),a.success)ae.info(572836003,ge.CoreDefault,a.stop());else{const e="UnsupportedMessage"===a.resourceId||"Timeout"===a.resultSignature||"OnResponseInvokedMoreThanOnce"===a.resultSignature||"MessageCallbackException"===a.resultSignature||"We called into messageCallback"!==a.message;a.message=JSON.stringify({errorHappenedOutsideRegisteredMessageCallback:e}),ae.error(572836032,ge.CoreDefault,a.stop())}};let r=this.messageCallbacks.get(t.getTypeNameFor(e));r?a.resourceId=on(t.getTypeNameFor(e)):r=(e,n)=>{a.resourceId=on(t.getTypeNameFor(e)),"MalformedMessageName"!==a.resourceId&&(a.resourceId="UnsupportedMessage"),n(new lt({messageId:e.messageId,code:Je.UnsupportedMessage,error:`Message type ${t.getTypeNameFor(e)} is not supported`}))};let o=!1;const s=(r,s)=>{o?(a.success=!1,a.resultSignature="OnResponseInvokedMoreThanOnce",a.resultDescription=`Invoked onResponse for ${t.getTypeNameFor(e)} message ${e.messageId} more than once`):r?(a.success=!1,a.resultSignature=r.error,void 0!==r.code&&(a.dimension0=Je[r.code]),a.resultDescription=`Error for ${t.getTypeNameFor(e)} message ${e.messageId}: ${r.error}`):a.resultSignature="Success",o=!0,i(),r&&!t.matchesTypesFor(r,[lt.getTypeName()])&&(r=new lt({error:"Internal Server Error"})),this.updateProcessMessageStats(a.success,a.durationMs,r?new Error(r.error):void 0),r?(r.messageId=e.messageId,n(r)):s?(s.messageId=e.messageId,n(void 0,s)):n()};try{a.message="We called into messageCallback",r(e,s)}catch(e){a.success=!1,a.resultSignature="MessageCallbackException",a.resultDescription=JSON.stringify({message:e.message,stack:e.stack}),i(),this.updateProcessMessageStats(!1,a.durationMs,e),n()}}processResponse(e){var n;const a=new V({operationName:"ProcessResponse"});if(a.success=!0,a.setClientMetadata(this.clientMetadata),a.start(),e.messageId){const n=this.pendingResponseCallbacks.get(e.messageId),i=null==n?void 0:n.callback;if(i){if(rt.typeGuard(e)&&!e.finalResponse){const t=n.message.maxDelayMs;this.pendingResponseCallbacks.updateExpireTime(e.messageId,t)}else this.pendingResponseCallbacks.del(e.messageId);t.matchesTypesFor(e,[lt.getTypeName()])?i(e):i(void 0,e)}else a.resultSignature="NoPendingMessage",a.resultDescription=`${e.messageId}`,a.success=!1}else a.resultSignature="NoMessageIdSetInResponse",lt.typeGuard(e)?a.resultDescription=e.error:a.resultDescription="MessageId is not available",a.success=!1;"Production"!==(null===(n=this.clientMetadata)||void 0===n?void 0:n.releaseAudienceGroup)&&(a.resourceId=on(t.getTypeNameFor(e)),ae.info(572836034,ge.CoreDefault,a.stop()))}updateSendMessageStats(e,t,n){this.stats.sendMessageCount++,this.stats.sendMessageDurationMsMax=Math.max(t,this.stats.sendMessageDurationMsMax),e||n?e&&n&&ae.warn(572836036,ge.CoreDefault,"Succeeded send message provided error object."):ae.warn(572836035,ge.CoreDefault,"Failed send message did not provide error object."),e||(n&&n.message===tt.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}updateProcessMessageStats(e,t,n){this.stats.processMessageCount++,this.stats.processMessageDurationMsMax=Math.max(t,this.stats.processMessageDurationMsMax),e||n?e&&n&&ae.warn(572836038,ge.CoreDefault,"Succeeded process message provided error object."):ae.warn(572836037,ge.CoreDefault,"Failed process message did not provide error object."),e||(n&&n.message===nt.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}var cn,dn=c(230);!function(e){e[e.Undefined=0]="Undefined",e[e.Schema=1]="Schema",e[e.Boolean=2]="Boolean",e[e.Number=3]="Number",e[e.String=4]="String",e[e.Buffer=5]="Buffer",e[e.Function=6]="Function"}(cn||(cn={}));class ln{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(ln,this,e)}static getTypeName(){return"AugLoop_Core_Annotation"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[ln.getTypeName()])}}ln.H_={T_:ln.getTypeName(),B_:ln.getBaseTypes()};class un{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(un,this,e)}static getTypeName(){return"AugLoop_Core_BinaryClassificationAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[un.getTypeName()])}}un.H_={T_:un.getTypeName(),B_:un.getBaseTypes()};class fn{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(fn,this,e)}static getTypeName(){return"AugLoop_Core_StreamAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[fn.getTypeName()])}}fn.H_={T_:fn.getTypeName(),B_:fn.getBaseTypes()};class pn{constructor(e){t.assign(pn,this,e)}static getTypeName(){return"AugLoop_Signals_Signal"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[pn.getTypeName()])}}pn.H_={T_:pn.getTypeName(),B_:pn.getBaseTypes()};class mn{constructor(e){t.assign(mn,this,e)}static getTypeName(){return"AugLoop_Core_DirtyAreaSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[mn.getTypeName()])}}mn.H_={T_:mn.getTypeName(),B_:mn.getBaseTypes()};class _n{constructor(e){t.assign(_n,this,e)}static getTypeName(){return"AugLoop_Core_DirtyDocumentSignal"}static getBaseTypes(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[_n.getTypeName()])}}_n.H_={T_:_n.getTypeName(),B_:_n.getBaseTypes()};class hn{static createHealthCheckRequest(e){return{payload:{},payloadSchema:{category:cn.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:cn.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:e}}static isFeatureEnabled(e,t,n=!1,a="None"){return e&&e.isFeatureEnabled?e.isFeatureEnabled("Microsoft.Office.AugLoop."+t,a).catch(()=>Promise.resolve(n)):Promise.resolve(n)}static isChangeGateEnabled(e,t){return e&&e.isChangeGateEnabled?e.isChangeGateEnabled(t):Promise.resolve(!1)}static convertWebSocketUrlToHttp(e){return this.convertUrl(e,!1)}static convertServiceUrlToWebSocket(e){return this.convertUrl(e,!0)}static convertUrl(e,t){if(!e)return e;const n=e.split(":");let a=n[0].toLowerCase();return 0==a.indexOf(t?"http":"ws")?(a=t?a.replace("http","ws"):a.replace("ws","http"),n[0]=a,n.join(":")):e}static deepEquals(e,t){return Ve()(e,t)}static collectTelemetry(e,t,n,a,i,r){var o,s,c,d;e.start(),e.resultSignature=null!=a?a:"",e.resultDescription=null!=i?i:"",e.success=n,r?(e.dimension0=null!==(o=r[0])&&void 0!==o?o:"",e.dimension1=null!==(s=r[1])&&void 0!==s?s:"",e.dimension2=null!==(c=r[2])&&void 0!==c?c:"",e.dimension3=null!==(d=r[3])&&void 0!==d?d:""):(e.dimension0="",e.dimension1="",e.dimension2="",e.dimension3=""),t.log(()=>ae.info(508367457,ge.CoreDefault,e.stop()))}}hn.getCurrentTimeMs=()=>Date.now?Date.now():(new Date).getTime();class bn{constructor(e){this.maxNumberOfLogs=40,this.numberOfLogs=0,this.id=e}log(e){if(this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,e(),this.numberOfLogs===this.maxNumberOfLogs)){const e=new V({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:`Limit for number of logs for id: ${this.id} reached - all next logs will be dropped`});ae.warn(572838107,ge.CoreDefault,e)}}}t.getTypeName(),ln.getTypeName(),pn.getTypeName();const gn=(e,t=0)=>Number.isFinite(e)?e:t;var vn,yn,Sn=c(126),Dn=c.n(Sn);!function(e){e.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started",e.DroppedAsOldestInQueue="Message is dropped as oldest in full queue",e.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"}(vn||(vn={}));class In{constructor(e){this.logOp=new V({operationName:"MessageQueue",success:!0}),this.queue=new(Dn())(1e3),this.callbacks=e}clear(){this.queue.clear()}size(){return this.queue.length}push(e,t,n){const a=this.queue;if(1e3===a.length){this.logOp.resourceId="QueueFull",this.logOp.durationMs=0,this.logOp.success=!1,ae.warn(508843746,ge.CoreDefault,this.logOp);const e=a.shift();e.onResponse&&e.onResponse(new lt({error:vn.DroppedAsOldestInQueue}))}a.push({message:e,onResponse:t,timeQueued:hn.getCurrentTimeMs(),attemptNumber:n})}sendOnSessionInitialized(e){const t=this.queue.length;let n=0;if(t>0){const a=hn.getCurrentTimeMs()-this.queue.get(0).timeQueued;for(;this.queue.length>0&&this.callbacks.canSendMessage();){const t=this.queue.shift();e&&this.containSequencedSyncMessage(t)?(n++,t.onResponse&&t.onResponse(new lt({error:vn.ArrivedBeforeReseeding}))):t.message instanceof Uint8Array?this.callbacks.sendBytes(t.message):this.callbacks.sendMessage(t.message,t.onResponse,t.attemptNumber)}this.logOp.resourceId="SendOnSessionInitialized",this.logOp.resultDescription=`Queue size before: ${t}, after: ${this.queue.length}. droppedSyncMessages: ${n}`,this.logOp.durationMs=a,this.logOp.success=!0,ae.warn(508843745,ge.CoreDefault,this.logOp)}}containSequencedSyncMessage(e){return e.message instanceof Lt&&t.matchesTypesFor(e.message,[Lt.getTypeName()])&&e.message.seq>=0||e.message instanceof At&&t.matchesTypesFor(e.message,[At.getTypeName()])}}!function(e){e[e.Initing=0]="Initing",e[e.Running=1]="Running",e[e.Disconnected=2]="Disconnected",e[e.Closed=3]="Closed"}(yn||(yn={}));const xn=(e,n,a,i)=>{n&&(n.cv||(n.cv=e.cvParent.newChild().toString()),e.messageEndpoint.sendMessage(n,(n,i)=>{n||t.getTypeNameFor(i)!==Mt.getTypeName()||(e.stats.lastSyncMessage=Date.now()),a&&a(n,i)},void 0,i))},Cn=(e,t,n,a)=>{t&&(e.messageQueue.push(t,n,a),e.networkWorkerManager.init(void 0,e.customInitPromise).catch(e=>{const t=new V({operationName:"WorkerManagerInit",success:!1,resultDescription:`${e}`});ae.error(508843789,ge.CoreDefault,t)}))},On=(e,t)=>{t&&(e.messageQueue.push(t),e.networkWorkerManager.init(void 0,e.customInitPromise).catch(e=>{ae.error(508843788,ge.CoreDefault,`Init failed: ${e}`)}))};class wn{constructor(e){this.context=e}onEnter(e){}sendMessage(e,t,n,a){}sendBytes(e){}canSendMessage(){return!1}onConnectionClose(){}}class En extends wn{constructor(){super(...arguments),this.stateName=yn.Initing,this.possibleNextStates=[yn.Running,yn.Disconnected,yn.Closed]}sendMessage(e,n,a){t.matchesTypesFor(e,[pt.getTypeName()])?xn(this.context,e,n,a):Cn(this.context,e,n)}sendBytes(e){On(this.context,e)}onConnectionClose(){this.context.setState(yn.Disconnected)}}class An extends wn{constructor(){super(...arguments),this.stateName=yn.Running,this.possibleNextStates=[yn.Disconnected,yn.Closed]}onEnter(e){e&&e.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId(),this.context.messageQueue.sendOnSessionInitialized(e&&e.isSessionReseedingStarted)}sendMessage(e,t,n,a){xn(this.context,e,t,n)}sendBytes(e){e&&this.context.networkWorkerManager.egressBytes(e)}canSendMessage(){return!0}onConnectionClose(){this.context.setState(yn.Disconnected)}}class Ln extends wn{constructor(){super(...arguments),this.stateName=yn.Disconnected,this.possibleNextStates=[yn.Initing,yn.Closed]}onEnter(e){this.context.messageEndpoint.cancelPendingResponseCallbacks()}sendMessage(e,n,a,i){if(t.matchesTypesFor(e,[pt.getTypeName()]))this.context.setState(yn.Initing),xn(this.context,e,n,a);else if(t.matchesTypesFor(e,[vt.getTypeName()]))this.context.setState(yn.Closed);else{if(!i)return void Cn(this.context,e,n,a);n&&n(new lt({messageId:e.messageId,error:vn.DroppedBecauseClientDisconnected}))}}sendBytes(e){On(this.context,e)}}class kn extends wn{constructor(){super(...arguments),this.stateName=yn.Closed,this.possibleNextStates=[]}onEnter(e){this.context.messageEndpoint.cancelPendingResponseCallbacks()}}const{AugLoopTextEncoder:Mn,AugLoopTextDecoder:Pn}=(()=>{if("undefined"==typeof TextEncoder){c(664);const e={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};return TextEncoder=void 0,TextDecoder=void 0,e}return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}})();class Tn{static deserialize(e,t=(e=>e)){if(e[0]!==Tn.IDENTIFIERBYTE)throw new Error("Invalid Binary: Incorrect Identifier");let n=1;const a=[],i=new DataView(e.buffer,e.byteOffset,e.byteLength);for(;n<e.byteLength;){if(n+4>e.byteLength)throw new Error("Invalid Binary: Error reading fragment length");const t=i.getUint32(n);if(n+t+4>e.byteLength)throw new Error("Invalid Binary: Fragment out of range");"undefined"!=typeof Buffer&&Buffer.from?a.push(Buffer.from(e.buffer,e.byteOffset+n+4,t)):a.push(new Uint8Array(e.buffer,e.byteOffset+n+4,t)),n+=4+t}if(a.length<1)throw new Error("Invalid Binary: No fragments found");const r=Tn.textDecoder.decode(a[0]);return JSON.parse(r,(e,n)=>{if("string"==typeof n){if(n.substring(0,Tn.BINARYKEYWORD.length)===Tn.BINARYKEYWORD){const e=parseInt(n.substring(Tn.BINARYKEYWORD.length),10);if("number"!=typeof e||e>=a.length-1)throw new Error("Invalid Binary: Binary index out of range");return t(a[e+1])}if(n.substring(0,Tn.ESCAPEKEYWORD.length)===Tn.ESCAPEKEYWORD)return n.substring(Tn.ESCAPEKEYWORD.length)}return n})}static serialize(e){const t=[void 0],n=JSON.stringify(e,(e,n)=>ArrayBuffer.isView(n)?(t.push(n),`${Tn.BINARYKEYWORD}${t.length-2}`):n&&"Buffer"===n.type&&Array.isArray(n.data)?(t.push(new Uint8Array(n.data)),`${Tn.BINARYKEYWORD}${t.length-2}`):"string"==typeof n&&n.substring(0,Tn.ESCAPEKEYWORD.length)===Tn.ESCAPEKEYWORD?Tn.ESCAPEKEYWORD+n:n);t[0]=Tn.textEncoder.encode(n);const a=t.reduce((e,t)=>e+4+t.byteLength,0),i=new Uint8Array(a+1);i[0]=Tn.IDENTIFIERBYTE;let r=1;const o=new DataView(i.buffer,i.byteOffset,i.byteLength);for(const e of t)o.setUint32(r,e.byteLength),i.set(e,r+4),r+=4+e.byteLength;return i}}Tn.IDENTIFIERBYTE=3,Tn.BINARYKEYWORD=":b",Tn.ESCAPEKEYWORD=":",Tn.textDecoder=new Pn,Tn.textEncoder=new Mn;var Un=c(42);const Fn="Request timed out";function Hn(e,t,n){const a=new Un.Request(e,t);return Rn.add(a,n)}const Rn=new class{constructor(e,t,n){if(this.requestInProgress=!1,this.queuedRequests=[],null==e)throw new Error("No request.");this.fetch=e,this.fetchTimeout=t,this.queueTimeout=n}tryProcessNextRequest(){if(this.requestInProgress=!1,this.queuedRequests.length>0){const[e,t,n]=this.queuedRequests.shift();clearTimeout(n),this.add(e,t)}}add(e,t){if(this.requestInProgress){const n=setTimeout(()=>{t(new Error("Timed out waiting in queue"),null),this.queuedRequests.shift()},this.queueTimeout);this.queuedRequests.push([e,t,n])}else this.requestInProgress=!0,new Promise((t,n)=>{let a=!1;const i=setTimeout(()=>{a=!0,n(new Error("Fetch timed out"))},this.fetchTimeout);this.fetch(e).then(e=>{a||(clearTimeout(i),t(e))}).catch(e=>{a||(clearTimeout(i),n(e))})}).then(e=>{t(null,e),this.tryProcessNextRequest()}).catch(e=>{t(e,null),this.tryProcessNextRequest()})}}(Un.fetch,2e4,12e4);class Nn{constructor(e,t,n){this.lastPingTime=0,this.lastPongTime=0,this.lastEgressTime=0,this.remainingPingFailures=3,this.isPingPongSuccessful=!1,this.pingPongLogOp=new V({operationName:"WebSocketReliabilityManager",success:!0}).start(),this.pingPongLogOp.setClientMetadata(n,!0),this.worker=e,this.rateControllerClose=t}start(){this.logOperation(!0,"ping","initial ping"),this.ping(),this.isPingPongSuccessful=!0,this.startInterval()}onResponse(){this.lastPongTime=Date.now()}isReliabilityResponse(e){return"string"==typeof e&&1===e.length&&e===Nn.pingPongMessage}close(){this.logOperation(!0,"ping","close"),this.lastPingTime=0,this.lastPongTime=0,this.isPingPongSuccessful=!1,this.clearPingInterval(),this.worker=void 0}checkConnection(){return this.isPingPongSuccessful}postEgress(){this.lastEgressTime=Date.now()}needsParsedResponses(){return!1}ping(){this.lastPingTime=Date.now(),this.worker&&this.worker.egress({obj:Nn.pingPongMessage})}startInterval(){this.pingInterval=setInterval(()=>{if(this.isPingPongSuccessful=this.lastPongTime>=this.lastPingTime&&this.lastPongTime-this.lastPingTime<=3e4,this.lastPongTime>this.lastEgressTime)return;const e=this.lastPongTime-this.lastPingTime;this.isPingPongSuccessful?(this.remainingPingFailures=3,this.ping()):this.remainingPingFailures>0?(--this.remainingPingFailures,this.ping()):(this.logOperation(!1,"ping","Pong still not received after all retry attempts",[`${e}`,`${this.remainingPingFailures}`]),this.worker?this.worker.close():this.rateControllerClose())},3e4)}clearPingInterval(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0)}logOperation(e,t,n,a){var i,r,o,s;this.pingPongLogOp.start(),this.pingPongLogOp.success=e,this.pingPongLogOp.resultSignature=t,this.pingPongLogOp.resultDescription=n,a&&(this.pingPongLogOp.dimension0=null!==(i=a[0])&&void 0!==i?i:"",this.pingPongLogOp.dimension1=null!==(r=a[1])&&void 0!==r?r:"",this.pingPongLogOp.dimension2=null!==(o=a[2])&&void 0!==o?o:"",this.pingPongLogOp.dimension3=null!==(s=a[3])&&void 0!==s?s:""),ae.info(507320073,ge.CoreDefault,this.pingPongLogOp.stop())}}Nn.pingPongMessage="~";class Bn{constructor(e,t,n){this.remainingRetryAttempts=4,this.isAsleep=!1,this.isLongPollSuccessful=!1,this.isActiveLongPoll=!1,this.isResponseReceived=!1,this.lastEgressTime=0,this.longPollLogOp=new V({operationName:"OnLongPollMessage",success:!0}),this.clientMetadata=t,this.sessionCorrelationVector=n,this.longPollLogOp.setClientMetadata(this.clientMetadata,!0),this.worker=e}start(){const e=new V({operationName:"StartHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),ae.info(508163399,ge.CoreDefault,e.stop()),this.trySendLongPoll(!0),this.isLongPollSuccessful=!0}onResponse(e){if(!e||this.isResponseReceived){const e=new V({operationName:"HttpReliabilityManagerFailure",success:!1}).start();return e.setClientMetadata(this.clientMetadata,!0),void ae.info(508162497,ge.CoreDefault,e.stop())}this.isResponseReceived=!0,this.isActiveLongPoll=!1;const t=e;t.error?(this.isLongPollSuccessful=!1,--this.remainingRetryAttempts,this.remainingRetryAttempts>0?(this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription=`Retry attempts left : ${this.remainingRetryAttempts}`,this.longPollLogOp.resultSignature=t.error,ae.info(508163398,ge.CoreDefault,this.longPollLogOp.stop()),"Request timed out"===t.error||3===this.remainingRetryAttempts?this.trySendLongPoll(!0):this.enqueueSendLongPoll()):(this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription="Long poll still not received after all retry attempts",ae.info(508163397,ge.CoreDefault,this.longPollLogOp.stop()),this.worker&&this.worker.close())):(this.longPollLogOp.success=!0,this.longPollLogOp.resultDescription="Long poll received",ae.info(508163401,ge.CoreDefault,this.longPollLogOp.stop()),this.remainingRetryAttempts=4,this.isLongPollSuccessful=!0,this.trySendLongPoll())}close(){const e=new V({operationName:"CloseHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),ae.info(508162467,ge.CoreDefault,e.stop()),this.sendLongPollTimer&&(clearTimeout(this.sendLongPollTimer),this.sendLongPollTimer=void 0),this.isActiveLongPoll=!1,this.isLongPollSuccessful=!1,this.worker=void 0}checkConnection(){if(this.isAsleep){this.isAsleep=!1;const e=new V({operationName:"AwakenHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),ae.info(508162496,ge.CoreDefault,e.stop()),this.trySendLongPoll(!0)}return this.isLongPollSuccessful}isReliabilityResponse(e){return"string"!=typeof e&&ht.typeGuard(e)}postEgress(){this.lastEgressTime=Date.now(),this.trySendLongPoll()}needsParsedResponses(){return!0}enqueueSendLongPoll(){this.sendLongPollTimer=setTimeout(()=>{this.trySendLongPoll(!0)},2e4)}trySendLongPoll(e){if(!this.worker){const e=new V({operationName:"LongPollNoOp",success:!0}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Worker is undefined",void ae.info(507281438,ge.CoreDefault,e.stop())}if(!0===this.isActiveLongPoll){const e=new V({operationName:"LongPollNoOp",success:!0}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Already active long poll",void ae.info(508163396,ge.CoreDefault,e.stop())}if(this.isActiveLongPoll=!0,Date.now()-this.lastEgressTime>6e4&&!e){this.isActiveLongPoll=!1,this.isAsleep=!0;const e=new V({operationName:"LongPollSleep",success:!0}).start();return e.setClientMetadata(this.clientMetadata),e.resultDescription=`isAsleep: ${this.isAsleep}, isActiveLongPoll: ${this.isActiveLongPoll}`,void ae.info(507278739,ge.CoreDefault,e.stop())}this.longPollLogOp.start(),this.isResponseReceived=!1,this.worker.egress({obj:this.getLongPollMessageString(),isHttpSessionLongPollMessage:!0,isHttpSessionInitMessage:!1})}getLongPollMessageString(){const e=new _t({longPollTimeoutHint:15e3});return this.sessionCorrelationVector&&(e.cv=this.sessionCorrelationVector().newChild().toString()),JSON.stringify(e)}}const jn=JSON.stringify(new ht({error:Fn}));class Vn{constructor(){this.isClosed=!1,this.pendingEgress=[]}init(e,t,n,a){const i=new V({operationName:"HttpWorkerInit",success:!0}).start(),r=e.split("/?x-origin=");2===r.length?(this.url=hn.convertWebSocketUrlToHttp(r[0]),this.origin=r[1]):(this.url=hn.convertWebSocketUrlToHttp(e),this.origin=void 0),this.ingress=t,this.onOpen=n,this.onClose=a,ae.info(507839180,ge.CoreDefault,i.stop())}egress(e){const t=new V({operationName:"HttpEgress",success:!0}).start();if(!this.isConnectedToSession()&&!e.isHttpSessionInitMessage)return this.pendingEgress.push(e),t.success=!1,t.resultDescription="NotConnected, pendingQueueSize:  "+this.pendingEgress.length.toString(),void ae.info(508163394,ge.CoreDefault,t.stop());const n=this.getRequestInfo(e,t);if(!n.url)return t.success=!1,t.resultDescription="Could not generate HTTP request",void ae.error(508163393,ge.CoreDefault,t.stop());e.isHttpSessionLongPollMessage?this.egressLongPoll(n,t):Hn(n.url,n.request,(e,n)=>{e?this.onEgressError(t,"OnEgressError:"+(null==e?void 0:e.message)):n&&n.ok?n.text().then(e=>{t.success=!0,ae.info(508163362,ge.CoreDefault,t.stop()),this.ingressInternal(e)}).catch(e=>{this.onEgressError(t,"OnEgressParseError: "+(null==e?void 0:e.message))}):this.onEgressError(t,"OnEgressResponseError: "+(null==e?void 0:e.message)+`, Status ${null==n?void 0:n.status}: ${null==n?void 0:n.statusText}`)})}close(){const e=new V({operationName:"HttpWorkerClose",success:!0}).start();if(this.isClosed)return e.resultDescription="AlreadyClosed",void ae.info(508163360,ge.CoreDefault,e.stop());ae.info(508163359,ge.CoreDefault,e.stop()),this.isClosed=!0,this.sessionSettings=void 0,this.onClose&&(this.onClose(void 0),this.onClose=void 0)}onEgressError(e,t){e.success=!1,e.resultDescription=t,ae.error(508163358,ge.CoreDefault,e.stop()),this.isClosed||this.close()}ingressInternal(e,t){let n=e;t||(n=this.formatServerInput(e)),n&&(this.logIngressCount(n),this.ingress(n,e=>{mt.typeGuard(e)&&this.onSessionInitResponse(e)}))}onSessionInitResponse(e){const t=new V({operationName:"HttpWorkerOpen",success:!0}).start();if(!(e.sessionKey&&e.origin&&e.anonymousToken&&e.sessionUrlBase))return t.success=!1,t.resultDescription="SessionInitResponse missing information",void ae.error(507809949,ge.CoreDefault,t.stop());ae.info(508163357,ge.CoreDefault,t.stop()),this.setSessionSettings(e.sessionKey,e.origin,e.anonymousToken,e.sessionUrlBase),this.onOpen(),this.pendingEgress.forEach(e=>{this.egress(e)}),this.pendingEgress=[]}egressLongPoll(e,t){var n,a;(n=e.url,a=e.request,new Promise((e,t)=>{const i=setTimeout(()=>{t(new Error(Fn))},2e4);(0,Un.fetch)(n,a||{}).then(t=>{clearTimeout(i),e(t)}).catch(e=>{clearTimeout(i),t(e)})})).then(e=>{e&&e.ok?e.text().then(e=>{t.success=!0,t.resourceId="LongPoll",ae.info(508163355,ge.CoreDefault,t.stop()),this.ingressInternal(e)}).catch(e=>{this.onEgressError(t,"LongPollFetchParseError: "+(null==e?void 0:e.message))}):this.onEgressError(t,"LongPollFetchStatusFailure: "+(null==e?void 0:e.statusText))}).catch(e=>{e.message===Fn?(t.success=!1,t.resultDescription="LongPollFetchResponseTimeout:"+(null==e?void 0:e.message),ae.error(508163353,ge.CoreDefault,t.stop()),this.ingressInternal(jn,!0)):this.onEgressError(t,"LongPollFetchResponseError: "+(null==e?void 0:e.message))})}getRequestInfo(e,t){const n=this.getUrl(null==e?void 0:e.isHttpSessionInitMessage),a=this.getHeader(e,t);return t.resultSignature=n,{url:n,request:{method:"POST",headers:a,body:e.obj}}}getUrl(e){const t=this.sessionSettings&&this.sessionSettings.sliceUrl?this.sessionSettings.sliceUrl:this.url;return e?t+"/sessioninit":this.isConnectedToSession()?t+"/session/"+this.sessionSettings.sessionKey:""}getHeader(e,t){if(null==e?void 0:e.isHttpSessionInitMessage){const e=new Un.Headers({"Content-Type":"application/json"});return this.origin&&e.set("x-origin",this.origin),e}if(this.isConnectedToSession()){let n;return e.obj instanceof Uint8Array||e.obj instanceof ArrayBuffer?(n=new Un.Headers({"Content-Type":"application/jsond2"}),t.dimension0=e.obj.byteLength.toString().length.toString()):n=new Un.Headers({"Content-Type":"application/json"}),n.append("Authorization",`Bearer ${this.sessionSettings.anonymousToken}`),n.set("x-origin",this.sessionSettings.origin),n}return new Un.Headers}setSessionSettings(e,t,n,a){const i=a.replace("/session","");this.sessionSettings={sessionKey:e,origin:t,anonymousToken:n,sliceUrl:i}}isConnectedToSession(){return this.sessionSettings&&this.sessionSettings.sessionKey.length>0&&this.sessionSettings.anonymousToken.length>0&&this.sessionSettings.origin.length>0&&this.sessionSettings.sliceUrl.length>0&&!this.isClosed}formatServerInput(e){return e.length>1?e.substring(1,e.length-1):""}logIngressCount(e){const t=e.length;if(t>1e5){const e=new V({operationName:"HttpIngressByteOrderOfMagnitude",success:!0}).start();e.dimension2=t.toString().length.toString(),ae.info(508409622,ge.CoreDefault,e.stop())}}}var zn=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};const Gn=1e5,Kn=1e4,Wn=1e3;class qn{constructor(e){var t;this.emptyMessageId=0,this.egressMessageCount=0,this.egressByteCount=0,this.prevSeq=-1,this.pendingQueue=[],this.rpsThreshold=150,this.bpsThreshold=5e8,this.isClosing=!1,this.messageQueue=void 0,this.egressRateLogOp=new V({operationName:"NetworkEgressRate",success:!0}),this.egressedCache=new Map,this.initPromise=new Promise(e=>{this.resolveInitPromise=e}),this.dynamicRateControllerEnabled=null!==(t=null==e?void 0:e.dynamicRateControllerEnabled)&&void 0!==t&&t,this.dynamicRateControllerEnabled&&(this.messageQueue=new(Dn()))}init(e,t,n,a,i,r){this.worker=e,this.ingress=t,this.queryEgressCacheSize=n,this.clientMetadata=i,this.networkMode=a,this.reliabilityManager=((e,t,n,a)=>e instanceof Vn?new Bn(e,n,a):new Nn(e,t,n))(this.worker,this.close.bind(this),void 0,r),this.egressRateLogOp.setClientMetadata(this.clientMetadata,!0),this.dynamicRateControllerEnabled&&(this.resetRateLimiter(),this.onCloseController=new Promise(e=>{this.resolveCloseControllerPromise=e}),this.queueProcessingCompletePromise=new Promise(e=>{this.resolveQueueProcessingCompletePromise=e}),this.processQueue()),this.resolveInitPromise()}open(){const e=new V({operationName:"NetworkRateControllerOpen",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata,!0),this.initPromise.then(()=>{if(!this.reliabilityManager)return e.success=!1,void(e.resultDescription="Reliability Manager is undefined");this.egressRateControlIntervalStart=Date.now(),this.reliabilityManager.start(),this.dynamicRateControllerEnabled||(this.egressRateControlTimer=setInterval(()=>this.flush(),1e3),this.flush())}).catch(t=>{var n;e.success=!1,e.resultDescription=null!==(n="Catch: "+(null==t?void 0:t.message))&&void 0!==n?n:""}).finally(()=>{ae.info(507834384,ge.CoreDefault,e.stop())})}ingressFromWorker(e,t){this.reliabilityManager?this.reliabilityManager.needsParsedResponses()||!this.reliabilityManager.isReliabilityResponse(e)?this.ingress(e,e=>{null==t||t(e),this.reliabilityManager.needsParsedResponses()&&this.reliabilityManager.isReliabilityResponse(e)&&this.reliabilityManager.onResponse(e)}):this.reliabilityManager.onResponse():this.ingress(e,t)}onRateLimitErrorResponse(e){if(this.dynamicRateControllerEnabled){const t=new V({operationName:"NetworkRateControllerOnRateLimitResponse",success:!0}).start();t.setClientMetadata(this.clientMetadata,!0),t.resultSignature=`rateLimitAlreadyStarted: ${void 0!==this.rateLimitTimeout}`,t.setDataField("RetryAfterMs",e.retryAfterMs),t.setDataField("QueueSize",this.messageQueue.length),this.startRateLimiting(e.retryAfterMs),ae.info(507388684,ge.CoreDefault,t.stop())}}setRpsBps(e,t){const n=new V({operationName:"NetworkRateControllerRateLimitsSet",success:!0}).start();n.setClientMetadata(this.clientMetadata,!0),e&&(this.rpsThreshold=.9*e,n.resultDescription+=`maxRPS: ${e}, rpsThreshold: ${this.rpsThreshold}; `),t&&(this.bpsThreshold=.9*t,n.resultDescription+=`maxRPS: ${t}, rpsThreshold: ${this.bpsThreshold}; `),ae.info(507388683,ge.CoreDefault,n.stop())}close(){var e,t;return zn(this,void 0,void 0,function*(){const n=new V({operationName:"NetworkRateControllerClose",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();if(n.setClientMetadata(this.clientMetadata,!0),this.isClosing=!0,this.dynamicRateControllerEnabled){null===(e=this.resolveCloseControllerPromise)||void 0===e||e.call(this);const a=null===(t=this.reliabilityManager)||void 0===t?void 0:t.checkConnection();n.setDataField("QueueSizeBeforeFlush",this.messageQueue.length),0!=this.messageQueue.length&&a&&(yield this.queueProcessingCompletePromise),n.setDataField("QueueSizeAfterFlush",this.messageQueue.length),n.setDataField("IsConnected",a)}this.reliabilityManager?this.reliabilityManager.close():n.resultDescription="Reliability Manager is undefined",this.worker=void 0,this.prevSeq=-1,this.clearEgressControlTimeout(),this.reliabilityManager=void 0,ae.info(507834381,ge.CoreDefault,n.stop())})}clearMessageQueues(){this.pendingQueue=[],this.egressedCache.clear(),this.messageQueue=void 0}egress(e,t=0){var n,a,i;if(!this.reliabilityManager)return void this.logEgressActivity(!1,"Reliability Manager is undefined","");const r=this.getMessageSize(e);if(r>=3e6)this.logEgressActivity(!1,"Message size exceeded 3000000",`Message size: ${r}`);else{if((e.obj instanceof ArrayBuffer||e.isHttpSessionInitMessage)&&this.worker)return this.logEgressActivity(!0,`isArrayBuffer: ${e.obj instanceof ArrayBuffer}, isHttpSessionInitMessage: ${e.isHttpSessionInitMessage}`,""),void this.worker.egress(e);if(this.validateSyncMessage(e.messageId,e.seqId),this.dynamicRateControllerEnabled){const i=null!==(n=e.messageId)&&void 0!==n?n:"id"+this.emptyMessageId++,r={obj:e.obj,seqId:null==e?void 0:e.seqId,messageId:i,isHttpSessionInitMessage:null==e?void 0:e.isHttpSessionInitMessage},o=t>0,s=new V({operationName:"NetworkRateControllerQueueItem",success:!0,dimension3:`isRetry: ${o}`}).start();s.setClientMetadata(this.clientMetadata,!0);const c={message:r,logOp:s};if(s.dimension0="Enqueue",o?this.messageQueue.unshift(c):this.messageQueue.push(c),this.messageQueue.length>1e4)throw this.messageQueue.shift(),new Error("MessageQueue max size reached.");ae.info(507388547,ge.CoreDefault,s.stop()),null===(a=this.resolveQueueNotEmptyPromise)||void 0===a||a.call(this)}else{const t=this.queryEgressCacheSize(),n=this.egressMessageCount>=this.rpsThreshold,a=this.egressByteCount>=this.bpsThreshold,r=t>Kn,o=this.reliabilityManager.checkConnection(),s=0!==this.pendingQueue.length,c=this.pendingQueue.length>=1e4;if(!o||n||a||s||c||r){let d="";const l=[];(s||c)&&(d+=c?"Pending queue max exceeded. ":"Pending queue not empty. ",l.push(this.pendingQueue.length.toString().length.toString())),r&&(d+=t>=Kn?"Egressed cache max exceeded. ":"",l.push(t.toString().length.toString())),n&&(d+="RPS exceeded. ",l.push(this.egressMessageCount.toString().length.toString())),a&&(d+="BPS exceeded. ",l.push(this.egressByteCount.toString().length.toString())),d+=o?"":"Not connected. ",this.logEgressActivity(!0,`networkMode: ${this.networkMode}`,d,l);const u=null!==(i=e.messageId)&&void 0!==i?i:"id"+this.emptyMessageId++;return void this.pendingQueue.push({obj:e.obj,seqId:null==e?void 0:e.seqId,messageId:u,isHttpSessionInitMessage:null==e?void 0:e.isHttpSessionInitMessage})}this.sendToNetworkWorker(e)}}}getMessageSize(e){return e.obj instanceof ArrayBuffer?e.obj.byteLength:e.obj.length}sendToNetworkWorker(e){try{if(!this.worker)return void this.logEgressActivity(!1,"NetworkWorker is undefined","SendToNetworkWorkerFailure");if(!this.reliabilityManager)return void this.logEgressActivity(!1,"Reliability Manager is undefined","SendToNetworkWorkerFailure");this.worker.egress(e),this.reliabilityManager.postEgress();const t=this.getMessageSize(e);this.logEgressCount(t)}catch(e){this.logEgressActivity(!1,"SendToNetworkWorkerFailure",e?e.message:"")}}flush(){if(!this.reliabilityManager){const e=new V({operationName:"NetworkRateControllerFlushFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Reliability Manager is undefined",void ae.info(507834373,ge.CoreDefault,e.stop())}let e=0,t=0;for(;this.pendingQueue.length>0&&this.queryEgressCacheSize()<Kn&&e<this.rpsThreshold&&t<this.bpsThreshold&&this.reliabilityManager.checkConnection();){const n=this.pendingQueue.shift();this.sendToNetworkWorker(n),e++,t+=this.getMessageSize(n)}}processQueue(){var e,t;return zn(this,void 0,void 0,function*(){if(!this.reliabilityManager){const e=new V({operationName:"NetworkRateControllerProcessQueueFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Reliability Manager is undefined",void ae.info(507573643,ge.CoreDefault,e.stop())}const n=new V({operationName:"NetworkRateControllerProcessQueue",success:!0}).start();for(;;){if(0===this.messageQueue.length){if(this.isClosing){n.setDataField("ExitReason","Stage#1 Closing");break}yield Promise.race([this.queueNotEmpty(),this.onCloseController])}if(this.rateLimitTimeout){const e=new V({operationName:"NetworkRateControllerRateLimitBackoff",dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata,!0),e.setDataField("QueueLengthBeforeBackoff",this.messageQueue.length),yield Promise.race([this.rateLimitTimeout,this.onCloseController]),e.setDataField("QueueLengthAfterBackoff",this.messageQueue.length),e.setDataField("IsClosing",this.isClosing),e.success=!0,this.rateLimitTimeout=void 0,this.resetRateLimiter(),ae.info(507281410,ge.CoreDefault,e.stop())}if(!(null===(e=this.reliabilityManager)||void 0===e?void 0:e.checkConnection())){if(this.isClosing){n.setDataField("ExitReason","Stage#2 Closing");break}yield this.checkConnectionPromise(),this.connectionPromise=void 0}if(!this.reliabilityManager){n.setDataField("ExitReason","Stage#2 ReliabilityManager null");break}for(;this.messageQueue.length>0&&this.reliabilityManager.checkConnection();){if(Date.now()-this.egressRateControlIntervalStart>=Wn)this.resetRateLimiter();else if(this.egressMessageCount>=this.rpsThreshold||this.egressByteCount>=this.bpsThreshold){const e=Date.now()-this.egressRateControlIntervalStart,t=Wn-e+100;let n="";this.egressMessageCount>=this.rpsThreshold&&(n+="RPS exceeded."),this.egressByteCount>=this.bpsThreshold&&(n+="BPS exceeded.");const a="rateLimitHit",i=new V({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();i.setClientMetadata(this.clientMetadata,!0),i.success=!0,i.resultDescription=a,i.resultSignature=n,i.dimension0=this.messageQueue.length.toString().length.toString(),i.dimension1="rateLimitHit",i.setDataField("QueueLength",this.messageQueue.length),i.setDataField("RateLimitDelayMs",t),ae.info(507281409,ge.CoreDefault,i.stop()),this.startRateLimiting(t);break}const e=this.messageQueue.shift();e.logOp.dimension0="Dequeue",this.sendToNetworkWorker(e.message),ae.info(507388682,ge.CoreDefault,e.logOp.stop())}this.onQueueNotEmpty=void 0,this.resolveQueueNotEmptyPromise=void 0}this.resolveQueueProcessingCompletePromise(),this.resolveQueueProcessingCompletePromise=void 0,n.setClientMetadata(this.clientMetadata,!0),n.setDataField("QueueSize",this.messageQueue.length),n.setDataField("IsConnected",null===(t=this.reliabilityManager)||void 0===t?void 0:t.checkConnection()),n.setDataField("IsClosing",this.isClosing),ae.info(507368671,ge.CoreDefault,n.stop())})}queueNotEmpty(){return this.onQueueNotEmpty||(this.onQueueNotEmpty=new Promise(e=>{this.resolveQueueNotEmptyPromise=e})),this.onQueueNotEmpty}checkConnectionPromise(){return this.connectionPromise||(this.connectionPromise=new Promise(e=>{setTimeout(e,1e3)})),this.connectionPromise}startRateLimiting(e){this.rateLimitTimeout||(this.rateLimitTimeout=new Promise(t=>{setTimeout(t,e)}))}resetRateLimiter(){this.egressRateControlIntervalStart=Date.now(),this.egressMessageCount=0,this.egressByteCount=0}clearEgressControlTimeout(){this.egressRateControlTimer&&(clearInterval(this.egressRateControlTimer),this.egressRateControlTimer=void 0)}validateSyncMessage(e,t){if(!(void 0===t||void 0===e||t<=this.prevSeq)){if(t&&t!==this.prevSeq+1){const e=new V({operationName:"NetworkRateControllerAbandonedSyncMessage",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Gap in sync message",e.dimension0=`${this.prevSeq}`,e.dimension1=`${t}`,e.dimension2=""+(t-this.prevSeq),ae.info(507834370,ge.CoreDefault,e.stop())}this.prevSeq=t}}logEgressActivity(e,t,n,a){var i,r,o,s;const c=new V({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();c.setClientMetadata(this.clientMetadata,!0),c.success=e,c.resultDescription=t,c.resultSignature=n,a&&(c.dimension0=null!==(i=a[0])&&void 0!==i?i:"",c.dimension1=null!==(r=a[1])&&void 0!==r?r:"",c.dimension2=null!==(o=a[2])&&void 0!==o?o:"",c.dimension3=null!==(s=a[3])&&void 0!==s?s:""),ae.info(507626007,ge.CoreDefault,c.stop())}logEgressCount(e){const t=Date.now();t-this.egressRateControlIntervalStart>Wn&&((this.egressMessageCount>50||this.egressByteCount>Gn)&&(this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=this.egressMessageCount>50?"rps logging threshold exceeded":"",this.egressRateLogOp.resultDescription=this.egressByteCount>Gn?"bps logging threshold exceeded":"",this.egressRateLogOp.dimension0=(t-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1=`${this.egressMessageCount}`,this.egressRateLogOp.dimension2=`${this.egressByteCount}`,this.egressRateLogOp.dimension3=`networkMode: ${this.networkMode}`,ae.info(508843792,ge.CoreDefault,this.egressRateLogOp.stop())),this.egressRateControlIntervalStart=t,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=null!=e?e:0}}var Qn,Yn,Jn,Xn,Zn,$n,ea,ta,na,aa,ia,ra,oa,sa,ca,da,la,ua,fa,pa,ma,_a,ha,ba,ga,va,ya,Sa;!function(e){e[e.JSWebSockets=0]="JSWebSockets",e[e.LocalWorkflowsOnly=1]="LocalWorkflowsOnly",e[e.HostWebSockets=2]="HostWebSockets",e[e.HttpFallback=3]="HttpFallback"}(Qn||(Qn={}));class Da{constructor(e,t,n,a,i,r,o,s,c,d,l){this.logCountLimiter=new bn(Da.className),this.isWorkerReady=!1,this.permanentlyClosed=!1,this.currentReconnectAttempt=0,this.lastInitializationAttemptTimeMs=0,this.offlineInterval=void 0,this.alreadyLoggedReconnectAttempt=!1,this.httpTestsLeft=5,this.httpTestsSuccessCount=0,this.workerOpenCount=0,this.testHttpConnection=e=>{const t=hn.convertWebSocketUrlToHttp(this.globalUrl),n=!e,a=null!=e?e:new V({operationName:"HttpsTest",resourceId:we(t),success:!1,resultDescription:"",resultSignature:"HttpResponse:"}).start();Hn(t,{method:"POST",headers:{"content-type":"application/json","X-CorrelationId":a.cv},body:JSON.stringify(hn.createHealthCheckRequest(this.clientMetadata))},(e,t)=>{e?(a.dimension1="HttpErr",a.resultDescription+=`HttpErr: ${e.message}`):t&&t.ok?(a.dimension1="HttpOK",this.leaveOfflineMode(),this.httpTestsSuccessCount++,n&&(a.success=!0)):(a.dimension1="HttpNoResp",a.resultDescription+=`HttpStatus: ${null==t?void 0:t.status}`),n&&a.stop(),this.logCountLimiter.log(()=>{ae.info(508843780,ge.CoreDefault,a)})})},this.globalUrl=e,this.clientMetadata=t,this.workerFactory=n,this.sessionInitializer=a,this.ingress=i,this.queryEgressCacheSize=r,this.onConnectionClose=o,this.onDetectedWSBlock=s,this.sessionCorrelationVector=c,this.httpFallbackEnabled=d.httpFallbackEnabled,this.dynamicRateControllerEnabled=d.dynamicRateControllerEnabled,this.networkWorkerLogOp=new V({operationName:"CreateNetworkWorker",success:!0}),this.networkMode=l||Qn.JSWebSockets,this.initNetworkMode=this.networkMode}init(e,t,n=!1){if(this.permanentlyClosed)return Promise.reject(new Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=e||this.extensionConfigs;const a=()=>{if(n||!this.alreadyLoggedReconnectAttempt){const e=n?Da.initialAttemptTimeout:Da.reconnectAttemptTimeout;this.connTimeout=setTimeout(()=>{const t=new V({operationName:"ConnectionFailingOrSlow",dimension0:n?"Initial":"Reconnect",dimension1:e.toString(),dimension2:this.currentReconnectAttempt.toString()});ae.info(508843787,ge.CoreDefault,t),this.alreadyLoggedReconnectAttempt=!n,this.connTimeout=void 0},e)}};return t?this.pendingInitPromise=t().catch(e=>{const t=new V({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:`${e}`});ae.error(508843786,ge.CoreDefault,t)}).then(()=>{a(),this.initInternal()}):(this.pendingInitPromise=Promise.resolve(),a(),this.initInternal()),this.pendingInitPromise}egress(e,t){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(()=>{this.egressInternal(e,t)}):(this.egressInternal(e,t),Promise.resolve())}egressBytes(e){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(()=>{this.egressBytesInternal(e)}):(this.egressBytesInternal(e),Promise.resolve())}getNetworkMode(){return this.networkMode}getInitNetworkMode(){return this.initNetworkMode}onRateLimitErrorResponse(e){this.dynamicRateControllerEnabled&&this.getNetworkRateController().onRateLimitErrorResponse(e)}close(e){this.isWorkerReady=!1,this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close(),this.worker&&(this.worker.close(),this.worker=null),!this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close(),this.networkRateController=null,this.permanentlyClosed=e||this.permanentlyClosed,this.permanentlyClosed&&(this.leaveOfflineMode(),clearTimeout(this.connTimeout))}initInternal(){if(this.isWorkerReady=!1,this.permanentlyClosed||this.isOffline()){const e=new V({operationName:"WorkerManagerInitOffline",success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});ae.info(508843785,ge.CoreDefault,e)}else this.currentReconnectAttempt>0?setTimeout(()=>{this.tryToConnectAndInitializeSession()},((e,t,n)=>{let a=0;const i=hn.getCurrentTimeMs()?hn.getCurrentTimeMs()-t:0,r=[1e3,2e3,5e3,1e4,6e4];return a=r[Math.max(0,Math.min(r.length-1,e-1))],a=Math.max(a-i,1e3),a=n&&n>0?Math.min(5e3,a):a,a})(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs,this.httpFallbackEnabled?this.httpTestsSuccessCount:void 0)):this.getNetworkMode()===Qn.HttpFallback?setTimeout(()=>{this.tryToConnectAndInitializeSession()},100):this.tryToConnectAndInitializeSession()}egressInternal(e,n){if(!this.isWorkerReady&&!t.matchesTypesFor(e,[pt.getTypeName()]))return void(t.matchesTypesFor(e,[it.getTypeName()])||ae.error(508843784,ge.CoreDefault,new V({operationName:"UnexpectedEgressCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`})));let a,i;if(t.matchesTypesFor(e,[kt.getTypeName()])?(this.castBinaryData(e),a=Tn.serialize(e)):a=JSON.stringify(e),Lt.typeGuard(e)&&(i=e.seq),this.bypassRateController(e))return void this.worker.egress({obj:a});const r=pt.typeGuard(e)&&this.getNetworkMode()===Qn.HttpFallback;this.getNetworkRateController().egress({obj:a,isHttpSessionInitMessage:r,messageId:e.messageId,seqId:i},n)}bypassRateController(e){return vt.typeGuard(e)}egressBytesInternal(e){this.isWorkerReady?this.getNetworkRateController().egress({obj:e}):ae.error(508843783,ge.CoreDefault,new V({operationName:"UnexpectedEgressBytesCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}))}tryToConnectAndInitializeSession(){this.currentReconnectAttempt++,this.lastInitializationAttemptTimeMs=hn.getCurrentTimeMs();const e=t=>{if(this.permanentlyClosed||this.isOffline())return;const n=this.sliceUrl?this.sliceUrl:this.globalUrl;t.setDataField("connectionUrl",we(n)),this.connect(n),this.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!this.sliceUrl,extensionConfigs:this.extensionConfigs,onResponse:(n,a)=>{if(t.success=!n,t.resourceId=a?we(a.sliceUrl):"",t.dimension2=this.getNetworkModeLogString(),this.getNetworkMode()===Qn.HttpFallback?(t.resultDescription=n?`HTTP Error: ${n.error}`:"",t.dimension0=t.success?"HTTPOK":"HTTPFail"):(t.resultDescription=n?`WS Error: ${n.error}`:"",t.dimension0=t.success?"WSOK":"WSFail"),n||!this.worker)return this.sliceUrl=void 0,this.close(),this.httpTestsLeft>0?(this.httpTestsLeft--,this.testHttpConnection(t.stop())):(this.httpFallbackEnabled?this.getNetworkMode()===Qn.JSWebSockets?0===this.workerOpenCount&&this.httpTestsSuccessCount>=5?(t.dimension1="WSBlocked",t.dimension3="HTTP Fallback",this.networkMode=Qn.HttpFallback,this.currentReconnectAttempt=0,this.resetHttpTestsCounter()):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="WSOffline"):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="HTTPOffline"):0===this.workerOpenCount&&this.httpTestsSuccessCount>=5?(this.permanentlyClosed=!0,t.dimension1="WSBlocked",this.onDetectedWSBlock()):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="WSOffline"),this.logCountLimiter.log(()=>{ae.info(508843782,ge.CoreDefault,t.stop())})),void this.initInternal();if(this.logCountLimiter.log(()=>{ae.info(508843781,ge.CoreDefault,t.stop())}),a.forceReconnect){this.close();const t=new V({operationName:"ForcedReconnect"}).start();t.resultSignature=`globalUrl: ${this.globalUrl}. sliceUrl: ${this.sliceUrl}`,this.sliceUrl=void 0,setTimeout(()=>{e(t)},1e3)}else clearTimeout(this.connTimeout),this.sliceUrl=a.sliceUrl,this.dynamicRateControllerEnabled&&this.getNetworkRateController().setRpsBps(a.maxRPS,a.maxBPS),this.ready();this.resetHttpTestsCounter()}})},t=new V({operationName:"TryToConnectAndInitializeSession",resultSignature:`Reconnection attempt #${this.currentReconnectAttempt}`}).start();e(t)}getNetworkRateController(){return this.networkRateController||(this.networkRateController=new qn({dynamicRateControllerEnabled:this.dynamicRateControllerEnabled})),this.networkRateController}connect(e){const t=this.getNetworkMode();this.networkWorkerLogOp.start(),this.networkWorkerLogOp.resultDescription=this.getNetworkModeLogString(),this.networkWorkerLogOp.dimension0=t.toString(),this.logCountLimiter.log(()=>ae.info(508372418,ge.CoreDefault,this.networkWorkerLogOp.stop())),this.worker=this.workerFactory(t),this.worker.init(e,this.getNetworkRateController().ingressFromWorker.bind(this.networkRateController),()=>{this.workerOpenCount++,this.getNetworkRateController().open(),this.leaveOfflineMode()},e=>{this.close(),this.onConnectionClose(e)},this.clientMetadata),this.getNetworkRateController().init(this.worker,this.ingress,this.queryEgressCacheSize,t,this.clientMetadata,this.sessionCorrelationVector)}ready(){this.isWorkerReady=!0,this.pendingInitPromise=void 0,this.currentReconnectAttempt=0}castBinaryData(e){if(e){if(Array.isArray(e.__binaryMembers__))for(const t of e.__binaryMembers__)ArrayBuffer.isView(e[t])||(e[t]=new Uint8Array(e[t]));for(const t of Object.keys(e))"object"==typeof e[t]&&null!==e[t]&&this.castBinaryData(e[t])}}isOffline(){return!!this.offlineInterval}startOfflineMode(){this.offlineInterval=setInterval(()=>{this.testHttpConnection()},6e4)}leaveOfflineMode(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}resetHttpTestsCounter(){this.httpTestsLeft=5,this.httpTestsSuccessCount=0}getNetworkModeLogString(){return"NetworkMode: "+(this.getNetworkMode()===Qn.JSWebSockets?"WebSocket":"HTTP")}}Da.initialAttemptTimeout=1e5,Da.reconnectAttemptTimeout=2e4,Da.className="NetworkWorkerManager";class Ia{constructor(e){t.assign(Ia,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Ia.getTypeName()])}}Ia.H_={T_:Ia.getTypeName(),B_:Ia.getBaseTypes()};class xa{constructor(e){t.assign(xa,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[xa.getTypeName()])}}xa.H_={T_:xa.getTypeName(),B_:xa.getBaseTypes()};class Ca{constructor(e){t.assign(Ca,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowCancellationRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Ca.getTypeName()])}}Ca.H_={T_:Ca.getTypeName(),B_:Ca.getBaseTypes()};class Oa{constructor(e){t.assign(Oa,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Oa.getTypeName()])}}Oa.H_={T_:Oa.getTypeName(),B_:Oa.getBaseTypes()};class wa{constructor(e){t.assign(wa,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[wa.getTypeName()])}}wa.H_={T_:wa.getTypeName(),B_:wa.getBaseTypes()};class Ea{constructor(e){t.assign(Ea,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Ea.getTypeName()])}}Ea.H_={T_:Ea.getTypeName(),B_:Ea.getBaseTypes()};class Aa{constructor(e){t.assign(Aa,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Aa.getTypeName()])}}Aa.H_={T_:Aa.getTypeName(),B_:Aa.getBaseTypes()};class La{constructor(e){t.assign(La,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[La.getTypeName()])}}La.H_={T_:La.getTypeName(),B_:La.getBaseTypes()};class ka{constructor(e){t.assign(ka,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[ka.getTypeName()])}}ka.H_={T_:ka.getTypeName(),B_:ka.getBaseTypes()};class Ma{constructor(e){t.assign(Ma,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Ma.getTypeName()])}}Ma.H_={T_:Ma.getTypeName(),B_:Ma.getBaseTypes()};class Pa{constructor(e){t.assign(Pa,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingRequest","AugLoop_Session_Protocol_Message"]}static typeGuard(e){return t.matchesTypesFor(e,[Pa.getTypeName()])}}Pa.H_={T_:Pa.getTypeName(),B_:Pa.getBaseTypes()};class Ta{constructor(e){t.assign(Ta,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsResponseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(e){return t.matchesTypesFor(e,[Ta.getTypeName()])}}Ta.H_={T_:Ta.getTypeName(),B_:Ta.getBaseTypes()};class Ua extends dn.EventEmitter{constructor(e,t,n,a,i,r,o,s,c){super(),this.cvParent=new Me,this.logOp=new V({operationName:"SessionState",success:!0}).start(),this.sessionStateChangeLogCountLimiter=new bn("SessionState"),this.logRetryTelemetry=!0,this.stats=t,this.allStates={[yn.Initing]:new En(this),[yn.Running]:new An(this),[yn.Disconnected]:new Ln(this),[yn.Closed]:new kn(this)},this.setState(yn.Initing),this.messageEndpoint=new sn({messageIdPrefix:"c",responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),this.messageEndpoint.setClientMetadata(i),this.messageEndpoint.setEgress(this.egress.bind(this)),this.messageEndpoint.onMessage(vt.getTypeName(),(e,t)=>{this.onSessionCloseMessage(e,t)}),this.networkWorkerManager=new Da(e,i,n,a,this.ingress.bind(this),this.messageEndpoint.queryEgressCacheSize.bind(this.messageEndpoint),this.onConnectionClose.bind(this),()=>{this.onSessionClose(void 0,"WSNotSupported")},this.getCorrelationVector.bind(this),o,c),this.messageQueue=new In({sendMessage:(e,t,n,a)=>this.state.sendMessage(e,t,n,a),sendBytes:this.sendBytes.bind(this),canSendMessage:()=>this.state.canSendMessage()}),a.on("connect",(e,t,n,a,i,r,o)=>{this.setState(yn.Running,"",{isSessionReseedingStarted:e&&t}),this.emit("connect",e,n,a,i,r,o)}),a.on("reconnect",()=>this.emit("reconnect")),a.on("serverAuthenticationStateChange",e=>this.emit("serverAuthenticationStateChange",e)),this.resetNextSyncSequenceId=()=>this.emit("resetNextSyncSequenceId"),this.tokenRefreshManager=r,this.delayBeforeSocketClose=o.delayBeforeSocketClose,this.gateUtils=s,this.gateUtils&&this.gateUtils.isChangeGateEnabled("LogRetryMessageEvent").then(e=>{this.logRetryTelemetry=e}).catch(()=>{})}setState(e,t,n){if(this.state&&e===this.state.stateName)return;const a=this.state?yn[this.state.stateName]:"undefined",i=this.state?this.state.possibleNextStates.indexOf(e)>=0:e===yn.Initing;this.sessionStateChangeLogCountLimiter.log(()=>{this.logOp.stop(),this.logOp.resourceId=`New state: ${i?yn[e]:a}`,this.logOp.resultDescription=`Previous state: ${a}`,this.logOp.dimension0=`Attempted state: ${yn[e]||"undefined"}`,this.logOp.resultSignature=t+(this.state&&!i?"Unexpected state change":""),this.logOp.success=i,ae.info(508843791,ge.CoreDefault,this.logOp)}),i&&(this.state=this.allStates[e],this.logOp.start(),this.state.onEnter(n))}init(e,t){return this.extensionConfigs=e,this.customInitPromise=t,this.networkWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}sendMessage(e,t,n){this.retrySendMessage(e,t,Ua.maxRetries,n)}sendBytes(e){this.state.sendBytes(e)}onMessage(e,t){this.messageEndpoint.onMessage(e,t)}getCorrelationVector(){return this.cvParent}getNetworkWorkerManager(){return this.networkWorkerManager}forceReconnect(e){return this.extensionConfigs=e||this.extensionConfigs,this.networkWorkerManager.close(!1),new Promise(e=>setTimeout(()=>{e(this.networkWorkerManager.init(this.extensionConfigs))},100))}closeSession(e){if(this.sendMessage(new vt),this.delayBeforeSocketClose)setTimeout(()=>{this.networkWorkerManager.close(!0);const t=e||new bt({reasonDescription:"ClientRequested"});this.onSessionClose(new vt({reconnectAllowed:!1,reason:t}),"ClientRequested")},100);else{this.networkWorkerManager.close(!0);const t=e||new bt({reasonDescription:"ClientRequested"});this.onSessionClose(new vt({reconnectAllowed:!1,reason:t}),"ClientRequested")}}ingress(e,t){let n;try{n=JSON.parse(e)}catch(e){ae.error(508843790,ge.CoreDefault,new V({operationName:"ProcessMessage",resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:e.message,durationMs:0}))}if(n){if(t&&it.typeGuard(n)&&t(n),this.networkWorkerManager.getNetworkMode()===Qn.HttpFallback&&ht.typeGuard(n)){const e=n;if(e.batch)for(const t of e.batch)this.messageEndpoint.ingress(t,(e,t)=>this.egress(e||t,()=>{}));return}this.messageEndpoint.ingress(n,(e,t)=>this.egress(e||t,()=>{}))}}egress(e,t,n){e&&this.networkWorkerManager.egress(e,n).then(()=>t()).catch(e=>t(e))}onSessionCloseMessage(e,t){e.reconnectAllowed?this.networkWorkerManager.close():this.onSessionClose(e,"CloseMessageReceived"),t()}onSessionClose(e,t){this.setState(yn.Closed,t),this.tokenRefreshManager.clearAllTimeouts(),this.onConnectionClose(void 0),e&&this.emit("sessionClose",e)}onConnectionClose(e){this.state.onConnectionClose(),this.stats.lastConnectionClose=hn.getCurrentTimeMs(),this.emit("disconnect",e)}retrySendMessage(e,n,a,i,r){const o=Ua.maxRetries-a;this.state.sendMessage(e,(s,c)=>{var d,l,u,f;r&&(s&&0==a?(r.success=!1,ae.info(507025311,ge.CoreDefault,r.stop())):s&&a>0?(r.dimension0=(o+1).toString(),r.dimension1=null!==(d=s.code.toString())&&void 0!==d?d:"NoErrorCode",r.resultSignature=null!==(l=s.error)&&void 0!==l?l:"NoErrorMessage"):(r.success=!0,ae.info(507025310,ge.CoreDefault,r.stop()))),s&&a>0&&this.canBeRetried(e)&&this.isTransientError(s)?(this.logRetryTelemetry&&!r&&((r=new V({operationName:"RetrySendMessage",success:!0,dimension0:o.toString()}).start()).resourceId=t.getTypeNameFor(e),r.dimension1=null!==(u=s.code.toString())&&void 0!==u?u:"NoErrorCode",r.resultSignature=null!==(f=s.error)&&void 0!==f?f:"NoErrorMessage",r.resultDescription=`Retrying message with messageId: ${e.messageId}${Lt.typeGuard(e)?`, seq: ${e.seq}`:""}`),t.matchesTypesFor(s,[ft.getTypeName()])&&this.networkWorkerManager.onRateLimitErrorResponse(s),this.retrySendMessage(e,n,a-1,i)):n&&n(s,c)},o,i)}canBeRetried(e){return!t.matchesTypesFor(e,[pt.getTypeName(),kt.getTypeName(),Pa.getTypeName()])}isTransientError(e){const t=e.error;return t!==tt.SyncMessageUnsupportedBatch&&t!==tt.UnexpectedSeedMessage&&t!==tt.UnsupportedSyncMessage&&t!==tt.AnnotationTokenNotFound&&t!==vn.ArrivedBeforeReseeding&&t!==vn.DroppedAsOldestInQueue&&t!==vn.DroppedBecauseClientDisconnected}}Ua.maxRetries=2,function(e){e[e.NotAuthenticated=0]="NotAuthenticated",e[e.Pending=1]="Pending",e[e.Authenticated=2]="Authenticated",e[e.WacUserInfoAuthenticated=3]="WacUserInfoAuthenticated",e[e.TokenMissingInteractionRequired=4]="TokenMissingInteractionRequired"}(Yn||(Yn={})),function(e){e[e.None=0]="None",e[e.HttpsGetDownloadUrl=1]="HttpsGetDownloadUrl",e[e.AlCodedLocation=2]="AlCodedLocation",e[e.Token=3]="Token"}(Jn||(Jn={})),function(e){e[e.NewDocument=0]="NewDocument",e[e.EditDocument=1]="EditDocument",e[e.ViewOnlyDocument=2]="ViewOnlyDocument"}(Xn||(Xn={}));class Fa{}Fa.lowerIndexBound=1,Fa.maxNumberOfRows=1048576,Fa.maxNumberOfColumns=16384,Fa.firstColumnName="A",Fa.lastColumnName="XFD",function(e){e[e.Unknown=0]="Unknown",e[e.LiveId=1]="LiveId",e[e.OrgId=2]="OrgId",e[e.ActiveDirectory=3]="ActiveDirectory",e[e.ADAL=4]="ADAL",e[e.SSPI=5]="SSPI",e[e.OAuth2=6]="OAuth2",e[e.Badger=7]="Badger"}(Zn||(Zn={})),function(e){e[e.Augloop=0]="Augloop",e[e.Substrate=1]="Substrate"}($n||($n={})),function(e){e[e.Unknown=0]="Unknown",e[e.TokenMissingInteractionRequired=1]="TokenMissingInteractionRequired"}(ea||(ea={}));class Ha{constructor(e,t,n,a){this.sendMessage=e,this.annotationType=t,this.options=n,this.token=`${t}-${Ha.nextActivationResultBatchId++}`,this.annotationDoesNotExistOnServiceEnabled=a}activate(e,t){return new Promise((n,a)=>{this.sendMessage(new Dt({annotationType:this.annotationType,token:this.token,config:this.options?this.options.config:void 0,ignoreExistingAnnotations:e,sendStateUpdates:this.options?!!this.options.stateUpdateCallback:void 0,forceReturnCachedAnnotations:this.options?this.options.forceReturnCachedAnnotations:void 0,returnAnnotationDoesNotExist:this.annotationDoesNotExistOnServiceEnabled||!1}),(e,t)=>{e?a(new Error(e.error)):(It.typeGuard(t)&&this.annotationDoesNotExistOnServiceEnabled&&(this.annotationDoesNotExistOnService=t.annotationNotExists),n({token:this.token}))},t)})}release(){return new Promise((e,t)=>{this.annotationDoesNotExistOnService&&this.annotationDoesNotExistOnServiceEnabled?e(!1):this.sendMessage(new Ct({token:this.token}),(n,a)=>{n?t(new Error(n.error)):e(a.lastRelease)})})}}Ha.nextActivationResultBatchId=1,function(e){e[e.Input=0]="Input",e[e.Exception=1]="Exception",e[e.WaitOn=2]="WaitOn",e[e.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"}(ta||(ta={})),function(e){e[e.Unknown=0]="Unknown",e[e.NoOutput=1]="NoOutput",e[e.Authentication=2]="Authentication",e[e.JoinTimedOut=3]="JoinTimedOut",e[e.LambdaThrow=4]="LambdaThrow",e[e.LambdaErrorCallback=5]="LambdaErrorCallback"}(na||(na={})),function(e){e[e.ExceedingMaxSize=0]="ExceedingMaxSize",e[e.GroupComplete=1]="GroupComplete",e[e.BatchIntervalElapsed=2]="BatchIntervalElapsed"}(aa||(aa={}));class Ra{constructor(e,t,n,a){this.batchesByGroupingKey=new Map,this.getOrderOfMagnitudeDimension=e=>e<0?"Negative":0===e?"0":1===e?"1":`Magnitude ${e.toString().length}`,this.submit=e,this.onSummary=a,this.reduceBatchOperationsEnabled=t,this.batchMessagesEnabled=n}addBatchItem(e,t,n,a,i,r){const{delayMs:o,delayMsMax:s,maxInputSize:c,estimateSize:d,groupingKeyExtractor:l}=t,u=d(e),f=l(e);if(t.split&&u>c){let o;try{o=t.split(e)}catch(e){const t=new Error("Split error: "+e.message);return void(r?r(t):ae.error(573366352,ge.CoreDefault,t))}if(o&&Array.isArray(o.inputs)&&o.inputs.length>1){let e;const s=[],c=r?(t,n)=>{if(e=e||t,s.push(n),s.length===o.inputs.length){let n;try{n=o.join(s)}catch(t){return void r(new Error("Join error: "+t.message))}r(e,n)}}:void 0;for(let e=0;e<o.inputs.length;e++){const r=o.inputs[e];this.addBatchItem(r,t,n,a,i&&e===o.inputs.length-1,c)}return}}let p=this.batchesByGroupingKey.get(f);if(p&&p.size+u>c&&(this.executeBatch(f,p,t,aa.ExceedingMaxSize),p=void 0),p||(p={items:[],size:0,hasItemsWithCallbacks:!1,context:n,creationTime:Date.now()},this.batchesByGroupingKey.set(f,p)),this.batchMessagesEnabled){const t=p.items[p.items.length-1];t&&t.cv===a&&t.callback===r?(t.input=[...t.input,...e],t.size+=u):p.items.push({input:e,size:u,cv:a,callback:r})}else p.items.push({input:e,size:u,callback:r});p.size+=u,p.hasItemsWithCallbacks=p.hasItemsWithCallbacks||!!r,this.batchMessagesEnabled||(p.cv=a),p.groupComplete=i,p.groupComplete?this.executeBatch(f,p,t,aa.GroupComplete):(Date.now()-p.creationTime+o<s&&(clearTimeout(p.timeout),p.timeout=void 0),p.timeout||(p.timeout=setTimeout(()=>{this.executeBatch(f,p,t,aa.BatchIntervalElapsed)},o)))}removeAllBatchedItems(){this.batchesByGroupingKey.forEach(e=>{e.timeout&&clearTimeout(e.timeout)}),this.batchesByGroupingKey.clear()}reduceBatchOperations(e){const t=new V({operationName:"ReduceBatchOperations"}).start();let n=0,a=0,i=0;const r=new Set,o=[],s=(e,t)=>e.parentPath.toString()+"/"+e.parentRevId+"/"+t.id;for(const t of e.input.reverse()){const e=[];for(const o of t.input.reverse())if(h.typeGuard(o)){const t=[];for(const e of o.items){i++;const c=s(o,e);r.has(c)?a++:(t.push(e),r.add(c),n++)}0!==t.length&&(o.items=t,e.push(o))}else if(p.typeGuard(o)){for(const e of o.items){const t=s(o,e);r.delete(t)}e.push(o)}else e.push(o);0!==e.length&&o.push({input:e.reverse(),size:t.size,cv:t.cv,callback:t.callback})}e.input=o.reverse(),0!=i&&(t.dimension0=`${this.getOrderOfMagnitudeDimension(a)}`,t.dimension1=`noOp: ${0===a}`),t.success=i-a==n,ae.info(507839488,ge.CoreDefault,t.stop())}executeBatch(e,t,n,a){clearTimeout(t.timeout),t.timeout=void 0,this.batchesByGroupingKey.delete(e);const i=t.items,r=new V({operationName:"ExecuteBatch",cv:this.batchMessagesEnabled?"":t.cv,resourceId:t.context.name,resultDescription:`batching duration: ${Date.now()-t.creationTime}ms`,dimension0:`${this.batchMessagesEnabled?"Batched items count":"Batched ops count:"} ${this.getOrderOfMagnitudeDimension(i.length)}`,dimension1:`Size ${this.getOrderOfMagnitudeDimension(t.size)}`,dimension2:a.toString()}).start(),o=(e,n,a)=>{let o;if(n&&n.exceptionType===na.NoOutput)r.success=!0,ae.info(573366353,ge.CoreDefault,r.stop());else{const a=`${e} error: ${n?n.message||n:"Unknown error"}`;o=n||new Error(a),r.success=!1,r.resultDescription=`Batch of ${i.length} items of size ${t.size} with ${a}`,r.resultSignature=`${e} Error`,ae.error(573366354,ge.CoreDefault,r.stop())}if(t.hasItemsWithCallbacks)for(const e of i)e.callback&&e.callback(o,a)};let s;try{s=n.multiplex(this.batchMessagesEnabled?i:i.map(e=>e.input))}catch(e){return void o("Multiplex",e)}this.reduceBatchOperationsEnabled&&this.batchMessagesEnabled&&"operations"==e&&this.reduceBatchOperations(s),this.submit(s.input,t,(e,a)=>{if(e||a&&("exceptionType"in a||a instanceof Error))o("Submit",e||a,a);else if(t.hasItemsWithCallbacks||n.summaryExtractor){let c,d,l;if(t.hasItemsWithCallbacks)try{if(c=s.demultiplex(a),c.length!==i.length)throw new Error("Mismatched output length")}catch(e){return void o("Demultiplex",e)}if(n.summaryExtractor)try{[l,d]=n.summaryExtractor(a)}catch(e){return void o("SummaryExtractor",e)}if(r.success=!0,ae.info(573366342,ge.CoreDefault,r.stop()),t.hasItemsWithCallbacks)for(let e=0;e<i.length;e++)i[e].callback&&i[e].callback(void 0,c[e]);d&&this.onSummary(l,d,t.context)}else r.success=!0,ae.info(573366343,ge.CoreDefault,r.stop())})}}!function(e){e[e.EditorLowPrivilege=0]="EditorLowPrivilege",e[e.AugLoopLowPrivilege=1]="AugLoopLowPrivilege",e[e.Anonymous=2]="Anonymous",e[e.ClientAssertion=3]="ClientAssertion",e[e.ClientAssertionV2=4]="ClientAssertionV2",e[e.AutoClpLowPrivilege=5]="AutoClpLowPrivilege",e[e.AutoClpAppOnlyLowPrivilege=6]="AutoClpAppOnlyLowPrivilege",e[e.Substrate=7]="Substrate",e[e.WacUserInfo=8]="WacUserInfo",e[e.OwaExchange=9]="OwaExchange",e[e.SmartCompose=10]="SmartCompose",e[e.WritingAnalyticsLowPrivilege=11]="WritingAnalyticsLowPrivilege",e[e.DWEngineLowPrivilege=12]="DWEngineLowPrivilege",e[e.SubstrateApp=13]="SubstrateApp",e[e.CortanaAppPop=14]="CortanaAppPop",e[e.OfficeAppsAppOnly=15]="OfficeAppsAppOnly",e[e.PPTFrontdoorAppPop=16]="PPTFrontdoorAppPop",e[e.EditorAppOnlyLowPrivilege=17]="EditorAppOnlyLowPrivilege",e[e.AugLoopApp=18]="AugLoopApp",e[e.MeetingIntelligenceApp=19]="MeetingIntelligenceApp",e[e.GraphApp=20]="GraphApp",e[e.IceServicesApp=21]="IceServicesApp",e[e.AzureMapsApp=22]="AzureMapsApp",e[e.SpoApp=23]="SpoApp",e[e.OneDrive=24]="OneDrive",e[e.GoogleDrive=25]="GoogleDrive",e[e.GettyApp=26]="GettyApp",e[e.Dropbox=27]="Dropbox",e[e.GooglePhotos=28]="GooglePhotos",e[e.EditorApp=29]="EditorApp",e[e.AmazonKindle=30]="AmazonKindle",e[e.ShredderApp=31]="ShredderApp",e[e.FormsLowPrivilege=32]="FormsLowPrivilege",e[e.VivaSalesLowPrivilege=33]="VivaSalesLowPrivilege",e[e.IntentSvcApp=34]="IntentSvcApp",e[e.DcgLowPrivilege=35]="DcgLowPrivilege",e[e.CSALowPrivilege=36]="CSALowPrivilege",e[e.ConsumerSydneyLowPrivilege=37]="ConsumerSydneyLowPrivilege",e[e.CompliantSydneyApp=38]="CompliantSydneyApp",e[e.M365AdminApp=39]="M365AdminApp",e[e.MeetingArtifactsServiceLowPrivilege=40]="MeetingArtifactsServiceLowPrivilege",e[e.AlchemyApp=41]="AlchemyApp",e[e.M365Admin=42]="M365Admin",e[e.ConsumerShellApp=43]="ConsumerShellApp",e[e.PowerQueryLowPrivilege=44]="PowerQueryLowPrivilege",e[e.CIIApp=45]="CIIApp",e[e.ConsumerShell=46]="ConsumerShell",e[e.AssistCopilotLowPrivilege=47]="AssistCopilotLowPrivilege",e[e.Pva=48]="Pva",e[e.TeamsCopilotServiceLowPrivilege=49]="TeamsCopilotServiceLowPrivilege",e[e.CallAnalytics=50]="CallAnalytics",e[e.IncomingPFT=51]="IncomingPFT",e[e.GraphExchange=52]="GraphExchange",e[e.EXOAdmin=53]="EXOAdmin",e[e.InsightsServicesLowPrivilege=54]="InsightsServicesLowPrivilege",e[e.VivaServicesLowPrivilege=55]="VivaServicesLowPrivilege",e[e.EcsAppOnly=56]="EcsAppOnly",e[e.ShredderLowPrivilege=57]="ShredderLowPrivilege",e[e.SpoLowPrivilege=58]="SpoLowPrivilege",e[e.PromptValidationApp=59]="PromptValidationApp",e[e.CompliantSydneyLowPrivilege=60]="CompliantSydneyLowPrivilege",e[e.SubstrateTenantFeedbackApp=61]="SubstrateTenantFeedbackApp",e[e.MonitoringPlatform=62]="MonitoringPlatform",e[e.YammerLowPrivilege=63]="YammerLowPrivilege",e[e.VivaLearningLowPrivilege=64]="VivaLearningLowPrivilege",e[e.VivaInsightsLowPrivilege=65]="VivaInsightsLowPrivilege",e[e.ClientAugLoopApp=66]="ClientAugLoopApp",e[e.AssistAuthLowPrivilege=67]="AssistAuthLowPrivilege",e[e.VivaLearningSearchPreProdLowPrivilege=68]="VivaLearningSearchPreProdLowPrivilege",e[e.SubstrateSearchApp=69]="SubstrateSearchApp",e[e.SparkContentPlatformLowPrivilege=70]="SparkContentPlatformLowPrivilege",e[e.SparkContentPlatformPopApp=71]="SparkContentPlatformPopApp",e[e.ConsumerSydneyApp=72]="ConsumerSydneyApp",e[e.BusinessAssistAuthLowPrivilege=73]="BusinessAssistAuthLowPrivilege",e[e.AzureResourceManager=74]="AzureResourceManager",e[e.AlchemyPortal=75]="AlchemyPortal",e[e.VivaUserSkillsApp=76]="VivaUserSkillsApp",e[e.VivaEngageAppPop=77]="VivaEngageAppPop",e[e.SubstrateAppOnly=78]="SubstrateAppOnly",e[e.PowerAutomateFlowCreationLowPrivilege=79]="PowerAutomateFlowCreationLowPrivilege",e[e.PowerAutomateConnectionCreationLowPrivilege=80]="PowerAutomateConnectionCreationLowPrivilege",e[e.PowerAutomateAuthorizeConnectionLowPrivilege=81]="PowerAutomateAuthorizeConnectionLowPrivilege",e[e.TCAAppPop=82]="TCAAppPop",e[e.BusinessAssistAuthAppPop=83]="BusinessAssistAuthAppPop",e[e.HolmesApp=84]="HolmesApp",e[e.GraphAppOnly=85]="GraphAppOnly",e[e.SimsApp=86]="SimsApp",e[e.VivaOrgInsightsLowPrivilege=87]="VivaOrgInsightsLowPrivilege",e[e.VivaGoalsAppPop=88]="VivaGoalsAppPop",e[e.GCBotAppPop=89]="GCBotAppPop",e[e.ShredderV2App=90]="ShredderV2App",e[e.ShredderV2LowPrivilege=91]="ShredderV2LowPrivilege",e[e.AmplifyProfileService=92]="AmplifyProfileService",e[e.AzureDevopsLowPrivilege=93]="AzureDevopsLowPrivilege",e[e.CommuteServices=94]="CommuteServices",e[e.GCBotAppOnly=95]="GCBotAppOnly",e[e.TCAAppOnly=96]="TCAAppOnly",e[e.MavenAgentLowPrivilege=97]="MavenAgentLowPrivilege",e[e.VivaOrgInsightsAppPop=98]="VivaOrgInsightsAppPop"}(ia||(ia={})),function(e){e[e.Unknown=0]="Unknown",e[e.Consumer=1]="Consumer",e[e.Enterprise=2]="Enterprise"}(ra||(ra={})),function(e){e.AuthorizationCode="authorization_code",e.ClientCredentials="client_credentials",e.RefreshToken="refresh_token"}(oa||(oa={})),function(e){e[e.LoggedIn=0]="LoggedIn",e[e.LoggedOut=1]="LoggedOut"}(sa||(sa={})),function(e){e[e.SingleItem=0]="SingleItem",e[e.Reduce=1]="Reduce",e[e.Grid=2]="Grid",e[e.DynamicText=3]="DynamicText",e[e.Join=4]="Join",e[e.Generic=5]="Generic"}(ca||(ca={})),function(e){e.Default="Default",e.Copilot="Copilot"}(da||(da={})),function(e){e[e.Default=0]="Default",e[e.LocalOnly=1]="LocalOnly",e[e.Exclusive=2]="Exclusive"}(la||(la={})),function(e){e[e.PreActivate=0]="PreActivate",e[e.Default=1]="Default",e[e.DelayActivate=1]="DelayActivate",e[e.NeverActivate=2]="NeverActivate"}(ua||(ua={})),(Sa=fa||(fa={}))[Sa.Required=-3]="Required",Sa[Sa.Optional=-1]="Optional",(ya=pa||(pa={}))[ya.Never=0]="Never",ya[ya.Always=1]="Always",function(e){e[e.PreSeed=1]="PreSeed",e[e.OnSeed=2]="OnSeed",e[e.PostSeed=4]="PostSeed",e[e.All=5]="All"}(ma||(ma={})),(va=_a||(_a={}))[va.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",va[va.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",va[va.DeltaUpdate=2]="DeltaUpdate",va[va.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals",function(e){e[e.Character=1]="Character",e[e.Paragraph=2]="Paragraph"}(ha||(ha={})),function(e){e.Input="Input",e.Delta="Delta",e.UILanguage="UILanguage",e.MaxInputCount="MaxInputCount"}(ba||(ba={})),function(e){e.SetPredefinedAnnotation="SetPredefinedAnnotation",e.ClearAnnotations="ClearAnnotations"}(ga||(ga={}));const Na=(e,t)=>{const n=[];for(const a of null!=e?e:[])if(void 0===t||t===a.cardinality)for(const e of a.contextTypes)n.push([e,a.cardinality,a.producerWaitPolicy]);return n},Ba=(e,t)=>Object.assign(Object.assign({},t),{parentPath:e}),ja=e=>Array.isArray(e)?5===e.length?`${e[0]}\\${e[1]}\\${e[2]}\\${e[3]}\\${e[4]}`:4===e.length?`${e[0]}\\${e[1]}\\${e[2]}\\${e[3]}`:3===e.length?`${e[0]}\\${e[1]}\\${e[2]}`:2===e.length?`${e[0]}\\${e[1]}`:1===e.length?e[0]:e.join("\\"):"(malformed path)";var Va,za,Ga,Ka,Wa,qa,Qa,Ya,Ja,Xa,Za,$a;!function(e){e[e.SingleItem=0]="SingleItem",e[e.Reduce=1]="Reduce",e[e.Grid=2]="Grid",e[e.DynamicText=3]="DynamicText",e[e.Join=4]="Join",e[e.Generic=5]="Generic"}(Va||(Va={})),function(e){e.Default="Default",e.Copilot="Copilot"}(za||(za={})),function(e){e[e.Default=0]="Default",e[e.LocalOnly=1]="LocalOnly",e[e.Exclusive=2]="Exclusive"}(Ga||(Ga={})),function(e){e[e.PreActivate=0]="PreActivate",e[e.Default=1]="Default",e[e.DelayActivate=1]="DelayActivate",e[e.NeverActivate=2]="NeverActivate"}(Ka||(Ka={})),function(e){e[e.Required=-3]="Required",e[e.Optional=-1]="Optional"}(Wa||(Wa={})),function(e){e[e.Never=0]="Never",e[e.Always=1]="Always"}(qa||(qa={})),function(e){e[e.PreSeed=1]="PreSeed",e[e.OnSeed=2]="OnSeed",e[e.PostSeed=4]="PostSeed",e[e.All=5]="All"}(Qa||(Qa={})),function(e){e[e.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",e[e.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",e[e.DeltaUpdate=2]="DeltaUpdate",e[e.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals"}(Ya||(Ya={})),function(e){e[e.Character=1]="Character",e[e.Paragraph=2]="Paragraph"}(Ja||(Ja={})),function(e){e.Input="Input",e.Delta="Delta",e.UILanguage="UILanguage",e.MaxInputCount="MaxInputCount",e.ExtensionLimits="ExtensionLimits"}(Xa||(Xa={})),function(e){e.SetPredefinedAnnotation="SetPredefinedAnnotation",e.ClearAnnotations="ClearAnnotations"}(Za||(Za={})),function(e){e[e.Local=0]="Local",e[e.External=1]="External"}($a||($a={}));class ei{constructor(){this.graphNodeByLocationAndWorkflowId=new Map}getWorkflow(e,t){var n;const a=this.getLocation(t);return null===(n=this.graphNodeByLocationAndWorkflowId.get(a))||void 0===n?void 0:n.get(e)}addWorkflow(e,t=!1){if(this.getWorkflow(e.id,t)){const n=new V({operationName:"AddWorkflowToGraphFailure",success:!1,resourceId:e.id,resultDescription:`Adding a new with workflow with a duplicated workflowId: ${t}`}).start();return void ae.error(524300630,ge.CoreDefault,n.stop())}const n=this.getLocation(t),a=new ti(e,n);this.addWorkflowAsDependency(a);let i=this.graphNodeByLocationAndWorkflowId.get(n);i||(i=new Map,this.graphNodeByLocationAndWorkflowId.set(n,i)),i.set(e.id,a)}getUpstreamRuntimeVisibleWorkflows(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const n of t.values()||[]){const t=this.createWorkflowDefinition(n.workflow);n.workflow.visibility===Ga.LocalOnly?this.compressDownstreamWorkflows(t,n):t.outputTypes.push(...n.workflow.outputTypes),0!==t.inputTypes.length&&e.push(t)}return e}removeWorkflows(e){const t=this.getLocation(e),n=this.graphNodeByLocationAndWorkflowId.get(t),a=Array.from((null==n?void 0:n.values())||[]);for(const e of a){for(const t of e.upstreamWorkflows.values())t.downstreamWorkflows.delete(e);for(const t of e.downstreamWorkflows.values())t.upstreamWorkflows.delete(e);n.delete(e.workflow.id)}}getWorkflowsDefinitions(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const n of t.values()||[])e.push(n.workflow);return e}getWorkflowNodes(e){const t=[];for(const e of this.graphNodeByLocationAndWorkflowId.values())for(const n of e.values())t.push(n);return t}getLocation(e){return e?$a.External:$a.Local}createWorkflowDefinition(e){return Object.assign(Object.assign({},e),{outputTypes:[]})}compressDownstreamWorkflows(e,t){for(const n of t.downstreamWorkflows)if(n.workflow.visibility!==Ga.LocalOnly){if(n.workflow.kind!==Va.Join||-1!==e.inputTypes.indexOf(n.workflow.collectionScopeType))for(const t of n.workflow.outputTypes)-1===e.outputTypes.indexOf(t)&&e.outputTypes.push(t)}else this.compressDownstreamWorkflows(e,n)}addWorkflowAsDependency(e){for(const t of this.graphNodeByLocationAndWorkflowId.values())for(const n of t.values()){for(const t of n.workflow.inputTypes)-1!==e.workflow.outputTypes.indexOf(t)&&this.addWorkflowChain(e,n);for(const t of n.workflow.outputTypes)-1!==e.workflow.inputTypes.indexOf(t)&&this.addWorkflowChain(n,e)}}addWorkflowChain(e,t){e.downstreamWorkflows.add(t),t.upstreamWorkflows.add(e)}}class ti{constructor(e,t){this.isActivated=!0,this.upstreamWorkflows=new Set,this.downstreamWorkflows=new Set,this.location=t,this.workflow=Object.assign(Object.assign({},e),{inputTypes:Array.isArray(e.inputTypes)?e.inputTypes:[],outputTypes:Array.isArray(e.outputTypes)?e.outputTypes:[]})}}const ni=e=>({id:e.id,kind:e.kind,visibility:e.visibility,collectionScopeType:e.collectionScopeType,inputTypes:e.inputTypes,outputTypes:e.outputTypes,correlatedSignals:e.correlatedSignals}),ai=(e,t)=>null!=e&&null!=t&&e.length>0&&(e===t||0===t.indexOf(e)&&"."===t.charAt(e.length));class ii{constructor(){this.workflowDefByWorkflowAndContextId=new Map,this.workflowDefByWorkflow=new Map}static mergeDefinitions(e,t,n){return Object.assign(Object.assign(Object.assign({},e),t),n)}mergeWorkflowDefinition(e,t,n){if(n){const a=((e,t,n)=>{let a=e.get(t);return a||(a=new Map,e.set(t,a)),a})(this.workflowDefByWorkflowAndContextId,e.id);a.set(n,ii.mergeDefinitions(e,a.get(n),t))}else this.workflowDefByWorkflow.set(e.id,ii.mergeDefinitions(e,this.workflowDefByWorkflow.get(e.id),t))}getWorkflowDefinition(e,t){var n;let a;return t&&(a=null===(n=this.workflowDefByWorkflowAndContextId.get(e.id))||void 0===n?void 0:n.get(t)),a||(a=this.workflowDefByWorkflow.get(e.id)),a||(a=e),a}deleteWorkflowDefinition(e,t){const n=this.workflowDefByWorkflowAndContextId.get(e.id);n&&(n.delete(t),0===n.size&&this.workflowDefByWorkflowAndContextId.delete(e.id))}}const ri=new Set([p.getTypeName(),h.getTypeName(),C.getTypeName(),I.getTypeName()]);class oi{constructor(e,t){this.nextId=1,this.runtimeKind=e,this.workflowGraph=t}static isParentContextId(e,t){return ai(e,t)}applyContextIdOnOperations(e){for(const n of e){const e=t.getTypeNameFor(n);if(this.isSupportedOperation(e))for(const e of n.items)e.contextId?e.source&&this.workflowGraph.getWorkflow(e.source,!1)?e.contextId=this.addNewContextId(e.contextId):this.tryLogMessage(new V({operationName:"ApplyContextIdOnOperations",success:!0}).start(),"Item with a contextId but without a workflow source atribute"):e.contextId=this.addNewContextId()}}addNewContextId(e){const t=`${this.runtimeKind}${this.nextId++}`;return e?`${e}.${t}`:t}isSupportedOperation(e){return ri.has(e)}tryLogMessage(e,t,n=!0){e&&(e.success=n,e.resultDescription=t,ae.verbose(527308633,ge.CoreDefault,e.stop()))}}var si,ci,di,li,ui;!function(e){e[e.Idle=1]="Idle",e[e.Pending=2]="Pending",e[e.Running=3]="Running",e[e.Executed=4]="Executed"}(si||(si={}));class fi{constructor(e){this.scopeItemsByContextId=new Map,this.itemsByWorkflowAndContextId=new Map,this.workflowDefinitionManager=e}setScopeItem(e,t){var n;const a=e.contextId;if(a)if(this.itemsByWorkflowAndContextId.has(t.id)||this.itemsByWorkflowAndContextId.set(t.id,new Map),this.itemsByWorkflowAndContextId.get(t.id).set(a,[]),this.scopeItemsByContextId.has(a)){if(null===(n=this.itemsByWorkflowAndContextId.get(t.id))||void 0===n?void 0:n.has(a)){const n=new V({resultDescription:`Trying to set new scope item: ${e.id} with already existing contextId ${a} for workflow ${t.id}`,operationName:"WIS.setScopeItem",resourceId:t.id,success:!0}).start();ae.verbose(527291288,ge.CoreDefault,n.stop())}}else this.scopeItemsByContextId.set(a,e)}updateScopeItemPath(e,t,n){var a,i;if(!e)return;const r=this.scopeItemsByContextId.get(e);if(!r)return;const o=r.parentPath;this.scopeItemsByContextId.set(e,Ba(t,r));const s=null!==(i=null===(a=this.itemsByWorkflowAndContextId.get(n.id))||void 0===a?void 0:a.get(e))&&void 0!==i?i:[];for(let e=0;e<s.length;e++)s[e]=Ba([...t,...s[e].parentPath.slice(0,o.length)],s[e])}getScopeItem(e,t){var n;for(const a of(null===(n=this.itemsByWorkflowAndContextId.get(t.id))||void 0===n?void 0:n.keys())||[])if(ai(a,e))return this.scopeItemsByContextId.get(a)}addItemToWorkflowList(e,t){const n=e.contextId;if(!n)return;const a=this.itemsByWorkflowAndContextId.get(t.id);if(a)for(const[i,r]of a)if(ai(i,n)){r.push(e);const n=new V({resultDescription:`Items for contextId ${i}: [${r.map(e=>e.id).join(",")}]`,operationName:"WIS.addItemOnContextIdList",resourceId:t.id,success:!0}).start();ae.info(526403808,ge.CoreDefault,n.stop())}}isWorkflowReady(e,t){const n=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.getGeneratedItems(e,t).length>=n}getItemsToExecute(e,t){const n=this.getGeneratedItems(e,t);return this.itemsByWorkflowAndContextId.get(t.id).delete(e),n}onWorkflowExecuted(e,t){const n=e.contextId,a=this.itemsByWorkflowAndContextId.get(t.id);a&&(a.delete(n),0===a.size&&this.itemsByWorkflowAndContextId.delete(t.id)),this.hasWorkflowsAwaitingExecution(n)||this.scopeItemsByContextId.delete(n)}getGeneratedItems(e,t){var n;if(!(null===(n=this.itemsByWorkflowAndContextId.get(t.id))||void 0===n?void 0:n.get(e)))return[];const a=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.itemsByWorkflowAndContextId.get(t.id).get(e).slice(0,a)}hasWorkflowsAwaitingExecution(e){for(const t of this.itemsByWorkflowAndContextId.values())for(const n of t.keys())if(n===e)return!0;return!1}}!function(e){e.JsClient="C",e.Server="S"}(ci||(ci={}));class pi{constructor(e){t.assign(pi,this,e)}static getTypeName(){return"AugLoop_Text_TextTile"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[pi.getTypeName()])}}pi.H_={T_:pi.getTypeName(),B_:pi.getBaseTypes()};class mi{constructor(e){t.assign(mi,this,e)}static getTypeName(){return"AugLoop_Text_FormattedTextTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[mi.getTypeName()])}}mi.H_={T_:mi.getTypeName(),B_:mi.getBaseTypes()};class _i{constructor(e){t.assign(_i,this,e)}static getTypeName(){return"AugLoop_Text_InlineTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[_i.getTypeName()])}}_i.H_={T_:_i.getTypeName(),B_:_i.getBaseTypes()};class hi{constructor(e){t.assign(hi,this,e)}static getTypeName(){return"AugLoop_Text_DynamicTextContext"}static getBaseTypes(){return["AugLoop_Core_DynamicContext"]}static typeGuard(e){return t.matchesTypesFor(e,[hi.getTypeName()])}}hi.H_={T_:hi.getTypeName(),B_:hi.getBaseTypes()};class bi{constructor(e){t.assign(bi,this,e)}static getTypeName(){return"AugLoop_Text_TaskTile"}static getBaseTypes(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[bi.getTypeName()])}}bi.H_={T_:bi.getTypeName(),B_:bi.getBaseTypes()};class gi{constructor(e){t.assign(gi,this,e)}static getTypeName(){return"AugLoop_Text_PersonTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[gi.getTypeName()])}}gi.H_={T_:gi.getTypeName(),B_:gi.getBaseTypes()};class vi{constructor(e){t.assign(vi,this,e)}static getTypeName(){return"AugLoop_Text_DateTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[vi.getTypeName()])}}vi.H_={T_:vi.getTypeName(),B_:vi.getBaseTypes()};class yi{constructor(e){t.assign(yi,this,e)}static getTypeName(){return"AugLoop_Text_LinkTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(e){return t.matchesTypesFor(e,[yi.getTypeName()])}}yi.H_={T_:yi.getTypeName(),B_:yi.getBaseTypes()},function(e){e[e.Add=0]="Add",e[e.Delete=1]="Delete",e[e.Update=2]="Update",e[e.CursorUpdate=3]="CursorUpdate",e[e.FormattingUpdate=4]="FormattingUpdate",e[e.OtherNonContentUpdate=5]="OtherNonContentUpdate",e[e.AttributionUpdate=6]="AttributionUpdate"}(di||(di={})),function(e){e[e.Chars=0]="Chars",e[e.Word=1]="Word",e[e.PartialSentence=2]="PartialSentence",e[e.Sentence=3]="Sentence",e[e.Paragraph=4]="Paragraph"}(li||(li={})),function(e){e[e.SessionUser=0]="SessionUser",e[e.Programmatic=1]="Programmatic",e[e.Collaborator=2]="Collaborator"}(ui||(ui={}));class Si{constructor(e){t.assign(Si,this,e)}static getTypeName(){return"AugLoop_Text_TextTileDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(e){return t.matchesTypesFor(e,[Si.getTypeName()])}}Si.H_={T_:Si.getTypeName(),B_:Si.getBaseTypes()};class Di{constructor(e){t.assign(Di,this,e)}static getTypeName(){return"AugLoop_Text_FormattedTextTileDelta"}static getBaseTypes(){return["AugLoop_Text_TextTileDelta","AugLoop_Core_ItemDelta"]}static typeGuard(e){return t.matchesTypesFor(e,[Di.getTypeName()])}}function Ii(e,t=!1){switch(e){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!t}return!1}function xi(e,t){return e.charCodeAt(t)>=56320&&e.charCodeAt(t)<=57343}Di.H_={T_:Di.getTypeName(),B_:Di.getBaseTypes()};const Ci=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,Oi=/[.!?]/g;function wi(e,t){const n=[],a=Ai(e,t);return a&&n.push(a),n}function Ei(e,t){const n=[],a=Ai(e,t);a&&n.push(a);const i=function(e,t,n){var a,i,r,o,s,c;const d=e,l=t;if((null==d?void 0:d.ipPosition)!==(null==l?void 0:l.ipPosition)||(null==d?void 0:d.isColdIp)!==(null==l?void 0:l.isColdIp)){if((null==d?void 0:d.isColdIp)===(null==l?void 0:l.isColdIp)&&n)if(n.deltaType===di.Add){if((null==l?void 0:l.ipPosition)===(null!==(a=n.position)&&void 0!==a?a:0)+(null!==(i=n.length)&&void 0!==i?i:0))return}else if(n.deltaType===di.Update){if((null==l?void 0:l.ipPosition)===(null!==(r=n.position)&&void 0!==r?r:0)+(null!==(s=null===(o=n.content)||void 0===o?void 0:o.length)&&void 0!==s?s:0))return}else if(n.deltaType===di.Delete&&(null==l?void 0:l.ipPosition)===(null!==(c=n.position)&&void 0!==c?c:0))return;return new Di({deltaType:di.CursorUpdate,cursorData:{ipPosition:null==l?void 0:l.ipPosition,isColdIp:null==l?void 0:l.isColdIp}})}}(e,t,a);i&&n.push(i);const r=function(e,t,n){var a,i,r,o,s,c,d;const l=e,u=t;if((null===(a=u.formattedRanges)||void 0===a?void 0:a.length)<=(null===(i=l.formattedRanges)||void 0===i?void 0:i.length))if(n){let e=l.formattedRanges?[...l.formattedRanges]:[];const t=function(e,t,n){if(!e)return;if(t.deltaType===di.Add){const t=e.find(e=>e.start===n&&0===e.length);if(t)return t;n=Math.max(n-1,0)}const a=e.find(e=>0===e.length?e.start===n:e.start<=n&&n<e.start+e.length);return a}(l.formattedRanges,n,n.position),a=t?e.indexOf(t):-1;if(-1!==a&&(n.position+(n.length||0)>t.start+t.length?t.length=n.position+(null!==(r=n.content)&&void 0!==r?r:"").length-t.start:t.length+=(null!==(o=n.content)&&void 0!==o?o:"").length-(n.length||0),e[a]=t),e.length>0){for(const t of e.slice(a+1))t.start<n.position||(n.position+(n.length||0)>t.start?(t.length=t.start+t.length-(n.position+(n.length||0)),t.start=n.position+(null!==(s=n.content)&&void 0!==s?s:"").length):t.start+=(null!==(c=n.content)&&void 0!==c?c:"").length-(n.length||0));e=e.filter(e=>e.length>0)}const i=null!==(d=null==u?void 0:u.formattedRanges)&&void 0!==d?d:[];if(Ve()(e,i)||0===e.length&&0===i.length)return}else if(Ve()(null==l?void 0:l.formattedRanges,null==u?void 0:u.formattedRanges))return;return new Di({deltaType:di.FormattingUpdate,formattedRanges:null==u?void 0:u.formattedRanges})}(e,t,a);r&&n.push(r);const o=function(e,t,n){var a;const i=e,r=t;if(((null==i?void 0:i.attributionRanges)||r.attributionRanges||(null===(a=null==n?void 0:n.attributionData)||void 0===a?void 0:a.ranges))&&!Ve()(null==i?void 0:i.attributionRanges,null==r?void 0:r.attributionRanges)){if(i.attributionRanges&&r.attributionRanges){const e=[];for(const t of r.attributionRanges)i.attributionRanges.some(e=>Ve()(e,t))||e.push(t);if(0===e.length)return;return new Di({deltaType:di.AttributionUpdate,attributionData:{ranges:e}})}return new Di({deltaType:di.AttributionUpdate,attributionData:{ranges:null==r?void 0:r.attributionRanges}})}}(e,t,a);o&&n.push(o);const s=function(e,t){const n=e,a=t;let i;const r={};let o=!1;for(i in a)-1===["ipPosition","isColdIp","content","formattedRanges","attributionRanges"].indexOf(i)&&(Ve()(a[i],n[i])||(o=!0,r[i]=a[i]));if(o)return new Di({deltaType:di.OtherNonContentUpdate,otherNonContentData:r})}(e,t);return s&&n.push(s),n}function Ai(e,t){const n=e.content,a=t.content,i=function(e,t,n=!1){let a,i,r={firstDiffLeft:0,firstDiffRight:t.length};return e.length<t.length?(a=e,i=t):(a=t,i=e),0===i.indexOf(a)?(r.firstDiffLeft=a.length,r.firstDiffRight=0):i.endsWith(a)?(r.firstDiffLeft=0,r.firstDiffRight=a.length):(r=function(e,t,n=!1){const a={firstDiffLeft:0,firstDiffRight:t.length};let i;for(i=0;i<e.length&&i<t.length;i+=1){const a=e.charCodeAt(i),r=t.charCodeAt(i);if(!(a===r||Ii(a,n)&&Ii(r,n)))break}for(a.firstDiffLeft=i,i=0;i<e.length&&i<t.length;i+=1){const a=e.charCodeAt(e.length-i-1),r=t.charCodeAt(t.length-i-1);if(!(a===r||Ii(a,n)&&Ii(r,n)))break}return a.firstDiffRight=i,a}(e,t,n),r.firstDiffLeft+r.firstDiffRight>a.length&&(r.firstDiffRight=a.length-r.firstDiffLeft)),function(e,t,n){if(e.firstDiffLeft>0){const a=e.firstDiffLeft<t.length&&xi(t,e.firstDiffLeft),i=e.firstDiffLeft<n.length&&xi(n,e.firstDiffLeft);(a||i)&&(e.firstDiffLeft-=1)}if(e.firstDiffRight>1){const a=e.firstDiffRight<t.length&&xi(t,t.length-e.firstDiffRight),i=e.firstDiffRight<n.length&&xi(n,n.length-e.firstDiffRight);(a||i)&&(e.firstDiffRight-=1)}}(r,e,t),r}(n,a),r=i.firstDiffLeft,o=n.length-i.firstDiffRight,s=a.length-i.firstDiffRight;let c,d=di.Update;if(n.length!==a.length)o===r?(d=di.Add,c=n[n.length-1]):s===r&&(d=di.Delete,c=a[a.length-1]);else if(n===a)return;let l,u=0;switch(d){case di.Update:u=o-r,l=a.substring(r,s);break;case di.Add:l=a.substring(r,s);break;case di.Delete:u=o-r,l=n.substring(r,o)}const f=function(e,t){const n=Array.from(e.matchAll(Ci));if(Ci.lastIndex=0,0===n.length)return li.Chars;if(1===n.length){if(0===n[0].index)return t&&Oi.test(t)?li.Sentence:t&&!Ci.test(t)?li.Word:li.Chars;if(n[0].index+1===e.length)return Oi.test(e[n[0].index-1])?li.Sentence:Ci.test(e[n[0].index-1])?li.Chars:li.Word;if(e[n[0].index-1]){const t=e[n[0].index-1];if(Oi.test(t))return li.Sentence;if(Ci.test(t))return li.Chars}return li.Word}const a=Array.from(e.matchAll(Oi));return Oi.lastIndex=0,0===a.length?li.PartialSentence:a.length>1?li.Paragraph:a[0].index+1<=e.length?Ci.test(e[a[0].index+1])?li.Sentence:li.Paragraph:void 0}(l,c);if(void 0!==f)return new Di({content:d!==di.Delete?l:void 0,deltaType:d,unit:f,position:r,length:d!==di.Add?u:0})}class Li{constructor(){this.deltaBuilderHandlers=new Map,this.registerDeltaBuilderHandler(pi.getTypeName(),wi),this.registerDeltaBuilderHandler(mi.getTypeName(),Ei)}registerDeltaBuilderHandler(e,t){this.deltaBuilderHandlers.set(e,t)}executeDeltaBuilderHandler(e,t,n){const a=this.deltaBuilderHandlers.get(e);return a?a(t,n):[]}}const ki=(e,t)=>t?Mi([...t,e]):e,Mi=e=>e.join("\\");class Pi{constructor(e){this.createTextTileDeltasFromItem=(e,n)=>{var a;const i=new V({operationName:"CreateTextTileDeltaFromItem",success:!0}).start();try{if(!e)return i.success=!1,i.resultDescription="Unable to create text tile delta, parent item is undefined",void ae.info(524883085,ge.CoreDefault,i.stop());if(!e.body)return i.success=!1,i.resultDescription="Unable to create text tile delta, parent item has undefined body",void ae.info(524883086,ge.CoreDefault,i.stop());const r=e.body;if(!pi.typeGuard(r))return i.success=!1,void(i.resultDescription=`Unable to create text tile delta, parent item body is not proper type: expected ${pi.getTypeName()}, received ${t.getTypeNameFor(r)}`);const o=ki(e.id,n),s=null!==(a=this.lastSeenTileByTileId.get(o))&&void 0!==a?a:new pi({content:""}),c=this.createDeltas(s,r);return c&&0!==c.length?(i.dimension0=c.length.toString(),this.lastSeenTileByTileId.set(o,r)):(i.dimension0="0",i.resultDescription="No delta differences found"),ae.info(524883087,ge.CoreDefault,i.stop()),c}catch(e){return i.success=!1,i.resultDescription=`Error creating text tile delta: ${e}`,void ae.info(524883088,ge.CoreDefault,i.stop())}},this.lastSeenTileByTileId=null!=e?e:new Map,this.deltaBuilder=new Li}addItemToLocalMap(e,t){const n=ki(e.id,t),a=e.body;pi.typeGuard(a)&&!this.lastSeenTileByTileId.has(n)&&this.lastSeenTileByTileId.set(n,a)}deleteItemFromLocalMap(e,t){const n=ki(e.id,t);this.lastSeenTileByTileId.has(n)&&this.lastSeenTileByTileId.delete(n)}moveItemsInLocalMap(e,t,n){const a=new Set(n),i=Mi(t),r=Mi(e),o=[],s=(e,t)=>e.length>t.length?e.substring(t.length+"\\".length).split("\\")[0]:void 0;for(const[e,t]of this.lastSeenTileByTileId)if(e.startsWith(i)){const n=s(e,i);if(void 0===n||a.has(n)){const n=e.replace(i,r);o.push({item:t,newPathKey:n,prevPathKey:e})}}for(const e of o)this.lastSeenTileByTileId.delete(e.prevPathKey),this.lastSeenTileByTileId.set(e.newPathKey,e.item)}createDeltas(e,n){return this.deltaBuilder.executeDeltaBuilderHandler(t.getTypeNameFor(n),e,n)}}const Ti=e=>Ui(e,Number.POSITIVE_INFINITY),Ui=(e,t)=>{let n=0;const a=[],i=[e];for(;i.length>0;){const e=i.pop(),r=typeof e;if("boolean"===r)n+=4;else if("string"===r)n+=2*e.length;else if("number"===r)n+=8;else if("object"===r&&e&&-1===a.indexOf(e))if(e instanceof Uint8Array)n+=e.length;else{a.push(e);for(const t in e)i.push(e[t])}if(n>t)return n}return n};function Fi(e,t){return n=this,void 0,i=function*(){const{authToken:n,origin:a,sessionUrl:i}=e,{body:r,cv:o,method:s,requestUrl:c}=t,d=yield(0,Un.fetch)(c||i,{method:s,headers:Object.assign({Authorization:`Bearer ${n}`,"x-origin":a,"x-correlationid":o},t.headers),body:r});if(200!==d.status)throw new Error(`Unexpected status code: ${d.status}`);return d},new((a=void 0)||(a=Promise))(function(e,t){function r(e){try{s(i.next(e))}catch(e){t(e)}}function o(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof a?n:new a(function(e){e(n)})).then(r,o)}s((i=i.apply(n,[])).next())});var n,a,i}const Hi=(e,t)=>{t?(e.resultDescription=t,e.success=!1,ae.error(507646878,ge.CoreDefault,e.stop())):ae.info(507646877,ge.CoreDefault,e.stop())};function Ri(e,t,n,a){let i;Fi(e,{headers:{"Content-Type":"application/jsond"},body:Tn.serialize(t),cv:n.cv,method:"POST"}).then(e=>e.json()).catch(e=>{i=new lt({messageId:t.messageId,error:e.message})}).then(e=>{Hi(n,i?i.error:void 0),a(i,e)})}function Ni(e,t,n,a){const{sessionUrl:i}=e;let r;Fi(e,{cv:a.cv,method:"GET",requestUrl:t.refType===Jn.AlCodedLocation?`${i}/blob/${t.value}`:t.value}).then(e=>e.arrayBuffer()).then(e=>new Uint8Array(e)).catch(e=>{r=e}).then(e=>{Hi(a,r?r.message:void 0),n(r,e)})}class Bi extends dn.EventEmitter{init(){return Promise.resolve()}sendMessage(e,t,n){}onMessage(e,t){}forceReconnect(){return Promise.resolve()}closeSession(){}sendBytes(e){}getCorrelationVector(){return new Me}getNetworkWorkerManager(){}setState(e){}}var ji,Vi,zi=function(e,t,n,a){return new(n||(n=Promise))(function(i,r){function o(e){try{c(a.next(e))}catch(e){r(e)}}function s(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,s)}c((a=a.apply(e,t||[])).next())})};!function(e){e[e.LocalWorkflow=0]="LocalWorkflow",e[e.ServerWorkflow=1]="ServerWorkflow",e[e.Submitted=2]="Submitted"}(ji||(ji={})),function(e){e[e.Internal=0]="Internal",e[e.External=1]="External"}(Vi||(Vi={}));const Gi=(e,t)=>{t?(e.resultDescription=t,e.success=!1,ae.error(509203144,ge.CoreDefault,e.stop())):ae.info(509203143,ge.CoreDefault,e.stop())},Ki=e=>!e.items.some(e=>e.source&&0===e.source.indexOf("ThirdParty"));class Wi{constructor(e){var t;this.annotationActivationTrackers=new Map,this.annotationCallbacks=new Map,this.annotationResultStates=new Map,this.tokensByAnnotationType=new Map,this.registeredContextTypes=new Set,this.availableContexts=new Map,this.nextSyncSequenceId=1,this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.hasSessionConnected=!1,this.isSessionClosed=!1,this.serverAuthenticationState=Yn.NotAuthenticated,this.sessionCloseCallbacks=new Map,this.connectCallbacks=new Map,this.reconnectCallbacks=new Map,this.disconnectCallbacks=new Map,this.sessionStateCallbackToken=0,this.workflowGraph=new ei,this.workflowDefinitionManager=new ii,this.contextIdManager=new oi(ci.JsClient,this.workflowGraph),this.workflowItemStorage=new fi(this.workflowDefinitionManager),this.pendingConnectCallbacks=[],this.onAnnotationsSubmittedEnabled=!1,this.reduceBatchOperationsEnabled=!1,this.batchMessagesEnabled=!1,this.cachedClaimsChallenge={claimsVersion:0,actionRequired:!1},this.tokenMessageVersion=1,this.hostCallbacks=e.hostCallbacks,this.sessionManager=e.sessionManager,this.batchMessagesEnabled=e.batchMessagesEnabled||!1,this.reduceBatchOperationsEnabled=e.reduceBatchOperationsEnabled||!1,this.operationBatchConfig=e.batchOptions?this.getOperationBatchConfig(e.batchOptions):void 0,this.extensionConfigs=e.extensionConfigs,this.clientMetadata=e.clientMetadata,this.userContext=e.userContext,this.localWorkflowManager=e.localWorkflowManager,this.annotationResultsProcessor=e.annotationResultsProcessor,e.workflowRuntimeFactory&&(this.workflowRuntime=e.workflowRuntimeFactory(this.sessionManager)),this.localRegisteredWorkflows=e.localRegisteredWorkflows||[],this.enableRemoteExecutionNotification=e.enableRemoteExecutionNotification||!1,this.networkMode=e.networkMode,this.egress=e.egress,this.serverAuthenticationStateChangeCallback=[],this.claimsChallengeCallback=[],this.onAnnotationsSubmittedEnabled=e.onAnnotationsSubmittedEnabled||!1,this.annotationDoesNotExistOnServiceEnabled=e.annotationDoesNotExistOnServiceEnabled||!1,this.sessionManager.on("sessionClose",this.onSessionClose.bind(this)),this.sessionManager.on("reconnect",this.onReconnect.bind(this)),this.sessionManager.on("connect",this.onConnect.bind(this)),this.sessionManager.on("disconnect",this.onDisconnect.bind(this)),this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this)),this.sessionManager.on("serverAuthenticationStateChange",this.onServerAuthenticationStateChange.bind(this)),this.sessionManager.onMessage(Tt.getTypeName(),this.workflowRuntime?this.onAnnotationResultsFromLocal.bind(this):this.onAnnotationResultsFromServer.bind(this)),this.sessionManager.onMessage(xt.getTypeName(),this.onAnnotationResultStateMessage.bind(this)),this.sessionManager.onMessage(jt.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this)),this.sessionManager.onMessage(en.getTypeName(),this.onClaimsChallengeMessage.bind(this)),e.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!e.disableSyncDeltaSending,this.syncDeltaTimeout=null!==(t=e.syncDeltaTimeout)&&void 0!==t?t:700,this.enableDeltaGenerator()),this.setServerAuthenticationStateChangeCallback(this.updateGraphOnAuthStateChange.bind(this)),this.setClaimsChallengeCallback(this.requestAuthTokenWithClaims.bind(this))}getSessionReconnectParams(){if(!this.connectParams)throw new Error("Session has not been established yet.");return{sessionUrl:this.connectParams.sessionUrl,origin:this.connectParams.origin,authToken:this.connectParams.authToken,nextSyncSequenceId:this.nextSyncSequenceId}}setNextSequenceId(e){this.nextSyncSequenceId=e}tryGetDocSessionId(){if(this.clientMetadata&&this.clientMetadata.docSessionId)return this.clientMetadata.docSessionId}getSessionStateCallbackToken(e){var t;return e+"-callback-"+(null!==(t=this.tryGetDocSessionId())&&void 0!==t?t:"unknown")+"-"+this.sessionStateCallbackToken++}updateGraphOnAuthStateChange(e){this.tryActivateWorkflows()}tryActivateWorkflows(){if(this.enableRemoteExecutionNotification){const e=new V({operationName:"GraphServerWorkflowActivation",success:!0}).setClientMetadata(this.clientMetadata).start(),t=[];this.workflowGraph.getWorkflowNodes().filter(e=>e.location===$a.External).forEach(e=>{this.localWorkflowManager.canActivateWorkflow(e,this)?e.isActivated=!0:(this.localWorkflowManager.deactivateServerWorkflow(e,this),t.push(e.workflow.id))}),e.resultDescription=`deactivated workflows: [${t.join()}]`,ae.info(508879493,ge.CoreDefault,e.stop())}}initialize(){return this.localWorkflowManager&&this.localWorkflowManager.addSession(this),this.registerLocalWorkflowsWithoutGraphInit(this.localRegisteredWorkflows),this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress).then(()=>(this.localWorkflowManager&&this.localWorkflowManager.setTokenCallback(this.getAuthToken.bind(this)),this))}isLocalWorkflowRegistered(e){return this.getLocalRegisteredWorkflows().some(t=>e===t.id)}get isConnected(){return!!this.connectParams}get hasConnected(){return this.hasSessionConnected}get isClosed(){return this.isSessionClosed}getServerAuthenticationState(){return this.serverAuthenticationState}getContextIdManager(){return this.contextIdManager}getWorkflowItemStorage(){return this.workflowItemStorage}getWorkflowDefinition(e,t){return this.workflowDefinitionManager.getWorkflowDefinition(e,t)}registerLocalWorkflows(e){this.registerLocalWorkflowsWithoutGraphInit(e),this.trySendWorkflowGraphInitMessage()}registerLocalWorkflowsWithoutGraphInit(e){if(e.length){if(this.workflowRuntime)for(const t of e)this.workflowRuntime.registerWorkflow(t),this.sendMessageToSession(new Ia({workflowDefinition:t}));if(this.localWorkflowManager)for(const t of e)this.localWorkflowManager.registerLocalWorkflow(t,this)}}registerLocalWorkflow(e){this.registerLocalWorkflows([e]);const t=new V({operationName:"SessionRegisterLocalWorkflow",resourceId:e.id,success:!0}).setClientMetadata(this.clientMetadata).start();Gi(t)}activateAnnotation(e,t,n){var a;const i=new Ha(this.sendMessageToSession.bind(this),e,t,this.annotationDoesNotExistOnServiceEnabled);if(t&&t.callback){let n=this.annotationCallbacks.get(e);n||(n=new Map,this.annotationCallbacks.set(e,n)),n.set(i.token,t.callback)}const r=null!==(a=this.tokensByAnnotationType.get(e))&&void 0!==a?a:[];return-1===r.indexOf(i.token)&&r.push(i.token),this.tokensByAnnotationType.set(e,r),this.annotationActivationTrackers.set(i.token,i),this.activateAnnotationForTracker(i,{ignoreExistingAnnotations:!1,sendOnlyIfConnected:!1})}activateAnnotationForTracker(e,t){const n=new V({operationName:"ActivateAnnotation",resourceId:e.annotationType,success:!0}).setClientMetadata(this.clientMetadata).start();return e.activate(t.ignoreExistingAnnotations,t.sendOnlyIfConnected).then(a=>(n.resultSignature="Ok",n.resultDescription=`Activated annotation ${e.annotationType} with token ${e.token}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`,Gi(n),a)).catch(a=>{throw Gi(n,`error on activate annotation type ${e.annotationType}: ${a}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`),a})}updateAnnotationConfig(e,t){const n=new wt({token:e,config:t});this.sendMessageToSession(n);const a=this.annotationActivationTrackers.get(e);a&&a.options&&(a.options.config=t)}releaseAnnotation(e){const t=this.annotationActivationTrackers.get(e);if(t){this.annotationActivationTrackers.delete(e);const n=this.annotationCallbacks.get(t.annotationType);return n&&(n.delete(e),0==n.size&&this.annotationCallbacks.delete(t.annotationType)),t.release()}return Promise.resolve(!1)}setAnnotationState(e,t,n){const a={state:n};this.submitOperation(new _({parentPath:e,items:[{id:t}],M_:a}))}setAnnotationMetadata(e,t,n){this.submitOperation(new _({parentPath:e,items:[{id:t}],M_:n}))}submitOperation(e,t){this.submitOperations([e],t)}submitOperations(e,t){var n,a;if(t||(t=this.generateCorrelationId()),this.contextIdManager.applyContextIdOnOperations(e),this.updateWorkflowExecutionStates(e),!this.onAnnotationsSubmittedEnabled){const[n,a]=this.partitionAnnotationOperations(e);this.executeCallbacksOnAnnotationSubmitted(n,t)}const i=e.filter(this.filterOperationsForSession.bind(this)).filter(Ki);if(this.workflowRuntime){if(this.onAnnotationsSubmittedEnabled){const[e,n]=this.partitionAnnotationOperations(i);this.onAnnotationsSubmitted(e,t),this.submitOperationsToSession(n,t)}else this.submitOperationsToSession(i,t);return}const r=[];if(this.deltaGenerator){const e=new V({operationName:"ExecuteDeltaGenerator",success:!0}).setClientMetadata(this.clientMetadata).start();for(const e of i)if(h.typeGuard(e))r.push(...this.createDeltasFromUpdateOperation(e));else{const t=e;for(const i of t.items)p.typeGuard(e)?this.deltaGenerator.addItemToLocalMap(i,t.parentPath):b.typeGuard(e)?this.deltaGenerator.deleteItemFromLocalMap(i,t.parentPath):m.typeGuard(e)&&this.deltaGenerator.moveItemsInLocalMap(e.parentPath,e.prevParentPath,null!==(a=null===(n=e.items)||void 0===n?void 0:n.map(e=>e.id))&&void 0!==a?a:[]);r.push(e)}Gi(e)}if(this.onAnnotationsSubmittedEnabled){const[e,n]=this.partitionAnnotationOperations(r.length?r:i);this.onAnnotationsSubmitted(e,t),this.submitOperationsToSession(n,t)}else this.submitOperationsToSession(r.length?r:i,t);this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e,this,!0)}submitSeedOperations(e,t){if(!this.allowSeed)throw new Error("Cannot submit seed operations more than once per session");if(this.networkMode===Qn.LocalWorkflowsOnly&&this.localWorkflowManager)return void this.localWorkflowManager.runLocalWorkflows(e,this);t||(t=this.generateCorrelationId()),this.allowSeed=!1,this.allowGroupSeed=!1;const[n,a]=this.partitionAnnotationOperations(e);this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(n,t):this.executeCallbacksOnAnnotationSubmitted(n,t),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?a:e,!0,t):this.sendMessageToSession(new Lt({cv:t,seq:0,ops:this.onAnnotationsSubmittedEnabled?a:e}))}submitSeedGroupOperations(e,t,n){if(!this.allowGroupSeed)throw new Error("Seed operations are not allowed for this session");if(this.networkMode===Qn.LocalWorkflowsOnly&&this.localWorkflowManager)return void this.localWorkflowManager.runLocalWorkflows(e,this);n||(n=this.generateCorrelationId()),t&&(this.allowGroupSeed=!1),this.allowSeed=!1;const[a,i]=this.partitionAnnotationOperations(e);this.executeCallbacksOnAnnotationSubmitted(a,n),this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(a,n):this.executeCallbacksOnAnnotationSubmitted(a,n),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?i:e,!!t,n):(this.seedGroupSize++,this.sendMessageToSession(new Lt({cv:n,seq:0,ops:this.onAnnotationsSubmittedEnabled?i:e,groupId:"Seed",groupSize:t?this.seedGroupSize:void 0,groupComplete:t||void 0})))}submitCustomMessage(e){return new Promise((n,a)=>{this.sendMessageToSession(e,(i,r)=>{i?a(new Error(`${i.error}; for message type: ${t.getTypeNameFor(e)}`)):n(r)})})}submitLargeBinaryDataMessage(e){return new Promise((t,n)=>{this.sendMessageToSessionPostEndpoint(e,(e,a)=>{e?n(new Error(e.error)):t(a)})})}requestBinaryDataForBlob(e){return e.data?Promise.resolve(e.data):e.dataPointer&&e.dataPointer.refType!==Jn.None?new Promise((t,n)=>{this.requestBinaryDataFromSessionBlobEndpoint(e.dataPointer,(e,a)=>{e?n(e):t(a)})}):Promise.reject(new Error("Blob does not have a data pointer"))}requestCacheDump(e){if(e)throw new Error("NYI");return this.submitCustomMessage(new yt)}forceReconnect(e){return this.extensionConfigs=e,this.sessionManager.forceReconnect(e)}close(e){this.isSessionClosed=!0,this.sessionManager.closeSession(e),this.workflowRuntime&&this.workflowRuntime.close(),this.localWorkflowManager&&this.localWorkflowManager.closeSession(this),this.graphInitMessageTimer&&(clearTimeout(this.graphInitMessageTimer),this.graphInitMessageTimer=void 0)}authenticateInteractive(){return zi(this,void 0,void 0,function*(){if(this.cachedClaimsChallenge.claimsVersion>0&&!this.cachedClaimsChallenge.actionRequired)return;const e=yield this.requestAuthTokenInteractive(this.cachedClaimsChallenge,{interactive:!0});if(Ft.typeGuard(e))throw new Error(e.reason)})}getClientMetadata(){return this.clientMetadata}getUserContext(){return this.userContext}setSessionCloseCallback(e){const t=this.getSessionStateCallbackToken("close");return e&&this.sessionCloseCallbacks.set(t,e),t}setConnectCallback(e){const t=this.getSessionStateCallbackToken("connect");return e&&this.connectCallbacks.set(t,e),t}setDisconnectCallback(e){const t=this.getSessionStateCallbackToken("disconnect");return e&&this.disconnectCallbacks.set(t,e),t}setReconnectCallback(e){const t=this.getSessionStateCallbackToken("reconnect");return e&&this.reconnectCallbacks.set(t,e),t}removeSessionStateCallback(e){function t(t){return!!t.has(e)&&(t.delete(e),!0)}return t(this.sessionCloseCallbacks)||t(this.reconnectCallbacks)||t(this.disconnectCallbacks)||t(this.connectCallbacks)}setServerAuthenticationStateChangeCallback(e){this.serverAuthenticationStateChangeCallback.push(e),e(this.serverAuthenticationState)}setClaimsChallengeCallback(e){this.cachedClaimsChallenge.actionRequired&&e(this.cachedClaimsChallenge),this.claimsChallengeCallback.push(e)}getConnectParams(){return this.connectParams}setOfflineMode(){this.sessionManager=new Bi}onAnnotationResults(e,t,n){ae.info(508916486,ge.CoreDefault,new V({operationName:"OnAnnotationResultsEgress",dimension0:null==e?void 0:e.annotationType,success:!0,cv:e.cv})),n(void 0,new it),t===ji.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(e.ops),this.updateWorkflowExecutionStates(e.ops),this.egress&&this.egress(e,()=>{}),this.annotationResultsProcessor.process(e,(e,n)=>{this.applyOperationForContext(e,n,t)},(t,n)=>{this.triggerRegisteredAnnotationCallbacks(t,e.annotationType,n)},e=>{if(t!==ji.ServerWorkflow){const t=e.ops.filter(this.filterOperationsForSession.bind(this)).filter(Ki);this.submitOperationsToSession(t,e.cv)}this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e.ops,this)})}onAnnotationResultStateMessage(e,t){var n;t(void 0,new it);for(const t of e.updates){const{annotationType:e,state:a}=t;if(!this.tokensByAnnotationType.has(e))continue;let i;i=this.annotationResultStates.has(e)?this.annotationResultStates.get(e):a===$e.Idle?$e.Pending:$e.Idle;for(const t of this.tokensByAnnotationType.get(e)){const e=this.annotationActivationTrackers.get(t);(null===(n=e.options)||void 0===n?void 0:n.stateUpdateCallback)&&e.options.stateUpdateCallback(i,a)}}}submitOperationsToSession(e,t){t||(t=this.generateCorrelationId());const n=e.filter(e=>C.typeGuard(e)),a=e.filter(e=>!C.typeGuard(e));if(n.length>0&&this.sendMessageToSession(new Lt({cv:t,ops:n})),a.length>0)if(this.operationBatchConfig){if(!this.batchedOperationsManager){let e;e=this.batchMessagesEnabled?(e,t,n)=>{if(e.length){const t=new At;t.messages=[],e.forEach(e=>{t.messages.push(new Lt({cv:e.cv,seq:this.nextSyncSequenceId++,ops:e.input}))}),this.sendMessageToSession(t,e=>{n(e?new Error(e.error):void 0)})}}:(e,t,n)=>{this.sendMessageToSession(new Lt({cv:t.cv,seq:this.nextSyncSequenceId++,ops:e}),e=>{n(e?new Error(e.error):void 0)})},this.batchedOperationsManager=new Ra(e,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled)}this.batchedOperationsManager.addBatchItem(a,this.operationBatchConfig,{name:"SubmitOperations"},t)}else this.sendMessageToSession(new Lt({cv:t,seq:this.nextSyncSequenceId++,ops:a}))}sendMessageToSession(e,t){this.sessionManager.sendMessage(e,t),vt.typeGuard(e)&&this.close()}sendMessageToSessionPostEndpoint(e,t){const n=new V({operationName:"SendLargeBinaryDataMessage",success:!0,cv:e.cv}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Ri(this.connectParams,e,n,t);else{const a=(a=>Ri(a,e,n,t)).bind(this);this.pendingConnectCallbacks.push(a)}}requestBinaryDataFromSessionBlobEndpoint(e,t){const n=new V({operationName:"RequestBinaryData",success:!0,cv:(new Me).toString()}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Ni(this.connectParams,e,t,n);else{const a=(a=>Ni(a,e,t,n)).bind(this);this.pendingConnectCallbacks.push(a)}}registerContextTypes(e){for(const t of e)this.activateAnnotation(t),this.registeredContextTypes.add(t)}applyOperationForContext(e,n,a){let i=t.getTypeNameFor(e);if(i!=p.getTypeName()&&i!=u.getTypeName()&&i!=h.getTypeName()&&i!=b.getTypeName())return;i==u.getTypeName()&&(i=p.getTypeName());const r=Ba(this.resolvePlaceholdersInOperationParentPath(e.parentPath),n),o=ja(r.parentPath);if(i==p.getTypeName()||i==h.getTypeName()){if(!r.body)return;const e=t.getTypeNameFor(r.body);if(!this.registeredContextTypes.has(e))return;let n=this.availableContexts.get(e);n||(n=new Map,this.availableContexts.set(e,n));let s=n.get(a);if(s||(s=[],n.set(a,s)),!r.id){if(this.workflowRuntime)throw new Error("Expected item to have id already");this.localWorkflowManager&&(r.id=this.localWorkflowManager.getNextClientAnnotationId())}if(i==p.getTypeName())0==s.filter(e=>ja(e.parentPath)==o&&e.id==r.id).length?s.push(r):ae.info(540848911,ge.CoreDefault,`AddOperation for (${a}, ${r.id}, ${r.source}) can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead.`);else for(let e=0;e<s.length;e++)if(s[e].id==r.id&&ja(s[e].parentPath)==o){if(s[e].source==r.source){s[e]=r;break}ae.warn(540848912,ge.CoreDefault,`UpdateOperation for (${a}, ${r.id}, ${r.source}) can't be applied as the context item with provided path and ID has different source: ${s[e].source}`)}else ae.warn(540848913,ge.CoreDefault,`UpdateOperation for (${a}, ${r.id}, ${r.source}) can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead`)}else if(i==b.getTypeName()){if(!r.id)return;this.availableContexts.forEach((e,t)=>{let n=e.get(a);n&&(n=n.filter(e=>!(ja(e.parentPath)==o&&e.id==r.id)),0==n.length?e.delete(a):e.set(a,n),0==e.size?this.availableContexts.delete(t):this.availableContexts.set(t,e))})}}updateWorkflowExecutionStates(e){if(this.localWorkflowManager){const n=this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map(e=>e.workflow):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(const a of e)if(ri.has(t.getTypeNameFor(a)))for(const e of a.items)for(const t of n||[])this.localWorkflowManager.preProcessItemToWorkflow(t,e,this)}}resolveRequestedContexts(e){const t=[];for(const[n,a,i]of Na(e.requestedContextTypesRules)){if(!this.availableContexts.has(n)){if(a==fa.Required)return[!1,[]];continue}const e=Array.from(this.availableContexts.get(n).values()).reduce((e,t)=>e.concat(t),[]);if(0==e.length)throw new Error(`Assert: availableContexts have the entry for ${n} which does not contain any context annotation.`);t.push(...e)}return[!0,this.removeDuplicatedContextItems(t)]}removeDuplicatedContextItems(e){return e.filter((e,t,n)=>n.findIndex(t=>hn.deepEquals(t,e))===t)}getContextAnnotations(e,t,n,a){var i,r;const o=n?ja(n):void 0;return null===(r=null===(i=this.availableContexts.get(e))||void 0===i?void 0:i.get(t))||void 0===r?void 0:r.filter(e=>!(o&&ja(e.parentPath)!=o||a&&e.source!=a))}onWorkflowDefinitionOverrideMessage(e){const t=new V({operationName:"WorkflowDefinitionOverride",success:!0}).setClientMetadata(this.clientMetadata).start(),n=e=>{throw Gi(t,e),Error(`WorkflowDefinitionOverride: ${e}`)};if(!this.localWorkflowManager)return void n("Not supported by this local SessionProxy instance.");const a=this.localWorkflowManager.getWorkflowDefinitionsByName(this),i=a.get(e.sourceWorkflowId);if(!i)return void n(`Workflow registration for source workflow '${e.targetWorkflowId}' was not found.`);t.resourceId=i.id;const r=a.get(e.targetWorkflowId);r&&(r.allowDefinitionOverride?i.definitionOverrideTargetWorkflows&&-1!==i.definitionOverrideTargetWorkflows.indexOf(r.id)?(this.workflowDefinitionManager.mergeWorkflowDefinition(r,e.definition,e.contextId),t.resultDescription=`Updated config for workflow: ${e.targetWorkflowId}, context id: ${e.contextId}`,Gi(t)):n(`Workflow '${i.id}' does not allow workflow definition for workflow '${r.id}'.`):n(`Workflow '${r.id}' does not allow workflow definition override.`))}applyContextIdOnOperations(e){this.contextIdManager.applyContextIdOnOperations(e)}attachToWorkflowGraph(e){this.addToWorkflowGraph(e),this.attachExecutionTrackerToEachWorkflow()}triggerRegisteredAnnotationCallbacks(e,t,n){if(this.callAnnotationCallbacks(e,t,n),this.hostCallbacks.onAnnotationResult)try{this.hostCallbacks.onAnnotationResult(e,n)}catch(e){ae.error(540301151,ge.CoreDefault,new V({operationName:"HostCallbackOnAnnotationResultError",dimension0:t,resultDescription:`onAnnotationResult error: ${e}`}))}}attachExecutionTrackerToEachWorkflow(){this.localWorkflowManager&&this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}onWorkflowExecutionCompleteMessage(e,t){t(void 0,new it),this.localWorkflowManager&&this.localWorkflowManager.onExternalWorkflowExecuted(e.contextId,e.workflowId,this)}onWorkflowExecutionComplete(e,t){}enableDeltaGenerator(){var e,t;this.deltaGenerator=null!==(e=this.deltaGenerator)&&void 0!==e?e:new Pi,this.syncDeltaTimers=null!==(t=this.syncDeltaTimers)&&void 0!==t?t:new Map}createDeltasFromUpdateOperation(e){var t,n;const a=[];ae.info(523776396,ge.CoreDefault,`Calling delta create for UpdateOperation under parent path [${e.parentPath}] (${null===(t=e.items)||void 0===t?void 0:t.length} item(s), first item id: ${(null===(n=e.items)||void 0===n?void 0:n.length)>0?e.items[0].id:"(no items)"})`);let i=[...e.parentPath];for(const t of e.items){const n=[],r=this.deltaGenerator.createTextTileDeltasFromItem(t,e.parentPath);if(null==r?void 0:r.length){for(const a of r){const r=w();i=[...e.parentPath,t.id];const o={id:r,revId:t.revId,body:a,contextId:t.contextId,source:t.source};n.push(o)}n.length>0&&(a.push(new I({parentPath:i,items:n})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(t,i,n))}else ae.info(523329632,ge.CoreDefault,`Failed to create delta on item ${t.id}`)}return a}setupSyncDeltaAfterDelay(e,t,n){var a,i,r;const o=this.syncDeltaTimers.get(e.id);o&&(clearTimeout(o),this.syncDeltaTimers.delete(e.id));const s=n.find(e=>{var t;return(null===(t=e.body)||void 0===t?void 0:t.unit)===li.Chars});if(s){const n=s.body,o={content:"",deltaType:di.Update,length:0,position:(null!==(a=null==n?void 0:n.position)&&void 0!==a?a:0)+(null!==(r=null===(i=null==n?void 0:n.content)||void 0===i?void 0:i.length)&&void 0!==r?r:0),unit:li.Sentence},c=mi.typeGuard(e.body)?new Di(o):new Si(o),d={id:w(),revId:e.revId,body:c,contextId:e.contextId,source:e.source},l=new I({parentPath:t,items:[d]}),u=setTimeout((e,t)=>{this.submitOperation(e),this.syncDeltaTimers.delete(t)},this.syncDeltaTimeout,l,e.id);this.syncDeltaTimers.set(e.id,u)}}addToWorkflowGraph(e){this.workflowGraph.addWorkflow(ni(e))}getAnnotations(e,t){var n,a,i;const r=new V({operationName:"GetAnnotations",success:!0,dimension1:null===(n=e.annotationType)||void 0===n?void 0:n.toString(),dimension2:null===(a=e.maxDelayMs)||void 0===a?void 0:a.toString(),cv:e.cv}).setClientMetadata(this.clientMetadata).start(),o=this.sessionManager.getCorrelationVector(),s=new Pa({annotationTypes:e.annotationType,transientItems:e.transientItems,configs:e.configs,maxDelayMs:e.maxDelayMs,correlationInfo:{cvString:null!==(i=e.cv)&&void 0!==i?i:o.newChild().toString()}}),c=[];let d;this.sendMessageToSession(s,(e,t)=>{c.push({error:e,response:t}),null==d||d(!0)});const l=this;let u=!1;return{[Symbol.asyncIterator]:()=>({next(){var e,n,a,i,o,s;return zi(this,void 0,void 0,function*(){try{0===c.length&&(yield new Promise(e=>d=e));const f=c.shift();return t&&t.IsCancellationRequested?(r.dimension0=`Error code: ${Ye.RequestCancelled}`,Gi(r,"Request cancelled"),{done:!0,value:{content:void 0,error:{clientError:{code:Ye.RequestCancelled,error:"Request cancelled"}}}}):(u?(r.dimension0=`Error code: ${Ye.ResponseReceivedAfterFinalResponse}`,Gi(r,"Response after final response has already been received")):u=null===(e=f.response)||void 0===e?void 0:e.finalResponse,r.dimension3=`final response: ${null===(n=f.response)||void 0===n?void 0:n.finalResponse}`,f.error?(r.dimension0=`Error code: ${f.error.code}`,Gi(r,f.error.error)):(null===(a=f.response)||void 0===a?void 0:a.errorInfo)?(r.dimension0=`Error code: ${f.response.errorInfo}`,Gi(r,"Workflow execution error")):(r.resultDescription="OK",Gi(r)),{done:(null===(i=f.response)||void 0===i?void 0:i.finalResponse)||void 0!==f.error,value:{content:null===(o=f.response)||void 0===o?void 0:o.content,error:{workflowError:null===(s=f.response)||void 0===s?void 0:s.errorInfo,serverError:f.error?{code:f.error.code,error:f.error.error,retryable:null==l?void 0:l.canBeRetried(f.error)}:void 0}}})}catch(e){return r.dimension0=`Error code: ${Ye.Unknown}`,Gi(r,null==e?void 0:e.message),{done:!0,value:{content:void 0,error:{clientError:{code:Ye.Unknown,error:null==e?void 0:e.message}}}}}})}})}}isHttpFallback(){const e=this.sessionManager.getNetworkWorkerManager();return!(!e||e.getInitNetworkMode()!==Qn.JSWebSockets||e.getNetworkMode()!==Qn.HttpFallback)}canBeRetried(e){return(null==e?void 0:e.code)===Je.TooManyRequests||(null==e?void 0:e.code)===Je.RequestTimeout}getAuthToken(e,t){const n={Tickets:[]};this.clientMetadata.docSessionId&&(n.DocSessionId=this.clientMetadata.docSessionId);const a=(e=>{if(e===ia.Substrate)return $n.Substrate})(e);a&&(n.TokenType=a),this.hostCallbacks.requestAuthToken(n).then(n=>{var a;if(!n)throw new Error("Missing AuthTokenResponse from requestAuthToken");if(!n.Token)throw new Error("Missing Token from requestAuthToken");t(void 0,n.Token,{returnedTokenType:e,timeToLiveSec:null===(a=n.TokenProperties)||void 0===a?void 0:a.timeToLiveSec})}).catch(e=>{t(e)})}resetNextSyncSequenceId(){this.nextSyncSequenceId=1}onReconnect(){if(this.annotationActivationTrackers.forEach(e=>{this.activateAnnotationForTracker(e,{ignoreExistingAnnotations:!0,sendOnlyIfConnected:!0}).catch(()=>{})}),this.reconnectCallbacks.forEach((e,t)=>{e()}),!this.connectParams)throw new Error("Expected onConnect before onReconnect")}onSessionClose(e){this.isSessionClosed=!0,this.connectParams=void 0,this.sessionCloseCallbacks.forEach((t,n)=>{t(e)})}onConnect(e,t,n,a,i,r){this.hasSessionConnected?e&&(this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0),this.cachedClaimsChallenge=Object.assign(Object.assign({},this.cachedClaimsChallenge),{claimsVersion:0})):this.enableRemoteExecutionNotification&&this.addDownstreamWorkflowsIntoClientGraph(r),this.connectParams={isSeedingRequired:e,sessionUrl:t,origin:n,authToken:a},this.hasSessionConnected=!0,this.tryActivateWorkflows();for(const e of this.pendingConnectCallbacks)e(this.connectParams);this.connectCallbacks.forEach((i,r)=>{i(e,t,n,a)}),this.serverInputTypes=i}onDisconnect(e){this.connectParams=void 0,this.disconnectCallbacks.forEach((t,n)=>{t(e)})}onServerAuthenticationStateChange(e){if(e!=this.serverAuthenticationState){if(this.serverAuthenticationState==Yn.Authenticated&&e==Yn.Pending)return;this.serverAuthenticationState=e;for(const e of this.serverAuthenticationStateChangeCallback)e(this.serverAuthenticationState)}}callAnnotationCallbacks(e,t,n){if(0===this.annotationCallbacks.size)return;const a=this.annotationCallbacks.get(t);a&&a.forEach(t=>{t(e,n)})}getOperationBatchConfig(e){let t;return t=this.batchMessagesEnabled?e=>({input:e,demultiplex:()=>[[]]}):e=>({input:e.filter(e=>e.length).reduce((e,t)=>e.concat(t),[]),demultiplex:()=>[[]]}),{delayMs:e.delayMs,delayMsMax:e.delayMsMax,maxInputSize:e.maxInputSize,estimateSize:Ti,groupingKeyExtractor:()=>"operations",multiplex:t,split:e=>{if(!(e.length<=1))return{inputs:e.reduce((e,t)=>(e.push([t]),e),[]),join:()=>[]}}}}sendSeedMessagesViaBatchManager(e,t,n){if(!this.seedBatchedOperationsManager){let e;e=this.batchMessagesEnabled?(e,t,n)=>{if(this.batchedSeedMessageGroupSize+=e.length,e.length){const a=new At;a.messages=[],e.forEach(e=>{a.messages.push(new Lt({cv:e.cv,seq:0,ops:e.input,groupId:"Seed",groupSize:t.groupComplete?this.batchedSeedMessageGroupSize:void 0,groupComplete:t.groupComplete?t.groupComplete:void 0}))}),this.sendMessageToSession(a,e=>{n(e?new Error(e.error):void 0)})}}:(e,t,n)=>{this.seedGroupSize++,this.sendMessageToSession(new Lt({cv:t.cv,seq:0,ops:e,groupId:"Seed",groupSize:t.groupComplete?this.seedGroupSize:void 0,groupComplete:t.groupComplete?t.groupComplete:void 0}),e=>{n(e?new Error(e.error):void 0)})},this.seedBatchedOperationsManager=new Ra(e,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled)}this.seedBatchedOperationsManager.addBatchItem(e,this.operationBatchConfig,{name:"SubmitSeedOperations"},n,t)}onAnnotationResultsFromServer(e,t){this.onAnnotationResults(e,ji.ServerWorkflow,t)}onAnnotationResultsFromLocal(e,t){this.onAnnotationResults(e,ji.LocalWorkflow,t)}getLocalRegisteredWorkflows(){return this.workflowRuntime?this.workflowRuntime.getRegisteredWorkflows():this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(e=>ni(e)):[]}sendWorkflowGraphInitMessage(){const e=this.getLocalRegisteredWorkflows(),t=new V({operationName:"WorkflowGraphInit",success:!0}).setClientMetadata(this.clientMetadata).start(),n=new Nt({upstreamRuntimeWorkflows:e});this.sendMessageToSession(n,(n,a)=>{n?Gi(t,n.error):(t.resultDescription=`local workflows: ${e.map(e=>e.id)}, remote workflows: ${a.downstreamRuntimeWorkflows.map(e=>e.id)}`,Gi(t),this.onWorkflowGraphInitResponse(a))})}trySendWorkflowGraphInitMessage(){!this.graphInitMessageTimer&&this.enableRemoteExecutionNotification&&(this.graphInitMessageTimer=setTimeout(()=>{this.graphInitMessageTimer=void 0,this.sendWorkflowGraphInitMessage()},10))}onWorkflowGraphInitResponse(e){this.addDownstreamWorkflowsIntoClientGraph(e.downstreamRuntimeWorkflows),this.tryActivateWorkflows()}addDownstreamWorkflowsIntoClientGraph(e){this.workflowGraph.removeWorkflows(!0);for(const t of e||[])this.workflowGraph.addWorkflow(t,!0);this.workflowRuntime||this.attachExecutionTrackerToEachWorkflow()}resolvePlaceholdersInOperationParentPath(e){let t=e;return 3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("user_")&&(ae.info(540848914,ge.CoreDefault,`Replacing user context placeholder for: ${ja(e)}.`),t=["session","#userContext#"]),3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("tenant_")&&(ae.info(540848915,ge.CoreDefault,`Replacing tenant context placeholder for: ${ja(e)}.`),t=["session","#tenantContext#"]),t}filterOperationsForSession(e){return!!this.workflowRuntime||((e,n)=>{if(!Array.isArray(n)||0===n.length)return!0;if(I.typeGuard(e)||_.typeGuard(e))return!0;for(const a of e.items)if(!a.body||t.matchesTypesFor(a.body,n))return!0;return!1})(e,this.serverInputTypes)}executeCallbacksOnAnnotationSubmitted(e,t){this.getAnnotationOperationsByType(e).forEach((e,n)=>{Array.from(e).forEach(e=>this.triggerRegisteredAnnotationCallbacks(e,n,t))})}partitionAnnotationOperations(e){return e.reduce(([e,t],n)=>n.items.some(e=>e.body&&ln.typeGuard(e.body))?[[...e,n],t]:[e,[...t,n]],[[],[]])}onAnnotationsSubmitted(e,t){this.getAnnotationOperationsByType(e).forEach((e,n)=>{const a=Array.from(e);this.onAnnotationResults(new Tt({annotationType:n,ops:a,cv:t}),ji.Submitted,()=>{})})}getAnnotationOperationsByType(e){const n=new Map;for(const a of e)for(const e of a.items)if(e.body&&ln.typeGuard(e.body)){const i=t.getTypeNameFor(e.body),r=n.get(i)||new Set;r.add(a),n.set(i,r)}return n}onClaimsChallengeMessage(e,t){e.claimsVersion>this.cachedClaimsChallenge.claimsVersion&&(this.cachedClaimsChallenge=Object.assign(Object.assign({},e),{actionRequired:!0}));for(const e of this.claimsChallengeCallback)e(this.cachedClaimsChallenge);t(void 0,new it)}generateCorrelationId(){return this.sessionManager.getCorrelationVector().newChild().toString()}onTokenProvisionResponse(e,t){if(e||!t)return;const n=t.tokenType&&t.tokenType==ia.WacUserInfo?Yn.WacUserInfoAuthenticated:Yn.Authenticated;this.onServerAuthenticationStateChange(n)}requestAuthTokenWithClaims(e){this.requestAuthTokenInteractive(e).catch(()=>{})}requestAuthTokenInteractive(e,t){var n;const a=new V({operationName:"RequestAuthTokenInteractive",success:!0,dimension0:`isInteractive: ${null!==(n=null==t?void 0:t.interactive)&&void 0!==n&&n}`}).start();a.dimension1=`HasClaims: ${!!e.claims&&e.claims.length>0}`;const i={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:$n.Augloop,ConnectParams:this.connectParams,Claims:e.claims,Interactive:null==t?void 0:t.interactive};return this.hostCallbacks.requestAuthToken(i).then(t=>{if(!t)throw new Error("Missing AuthTokenResponse from requestAuthToken claims");if(!t.Token)throw new Error("Missing Token from requestAuthToken claims");return a.resultSignature="Token",new Ut({authToken:t.Token,version:++this.tokenMessageVersion,claimsVersion:e.claimsVersion})}).catch(t=>(a.resultSignature="NoToken",a.dimension2=t.message,new Ft({reason:t.message,version:++this.tokenMessageVersion,claimsVersion:e.claimsVersion}))).then(e=>new Promise((t,n)=>{this.sendMessageToSession(e,(i,r)=>{Gi(a,null==i?void 0:i.error),this.onTokenProvisionResponse(i,r),i?n(new Error(i.error)):(this.cachedClaimsChallenge.actionRequired=!1,t(e))})}))}}class qi{}var Qi,Yi,Ji;!function(e){e[e.Anonymous=0]="Anonymous",e[e.Host=1]="Host"}(Qi||(Qi={}));class Xi{constructor(){this.timers=new Map}scheduleRefresh(e,t,n,a){let i=this.timers.get(e);i||(i={numberOfAttempts:0},this.timers.set(e,i)),i.refreshTimeoutId&&(clearTimeout(i.refreshTimeoutId),i.refreshTimeoutId=void 0),i.expiredTimeoutId&&(clearTimeout(i.expiredTimeoutId),i.expiredTimeoutId=void 0);let r=1e3*t-Xi.tokenRefreshBufferMs,o=1e3*t-Xi.tokenExpirationBufferMs;r>0?i.numberOfAttempts=0:(++i.numberOfAttempts,r=Xi.tokenRefreshBackoffIntervalMs,o=Xi.tokenExpirationBufferMs),i.numberOfAttempts<=Xi.tokenRefreshMaximumAttempts&&(i.refreshTimeoutId=setTimeout(()=>{n()},r)),a&&(i.expiredTimeoutId=setTimeout(()=>{a()},o))}clearRefreshTimeouts(){this.clearTimeouts(!1)}clearAllTimeouts(){this.clearTimeouts(!0)}clearTimeouts(e){this.timers.forEach((t,n)=>{t.refreshTimeoutId&&(clearTimeout(t.refreshTimeoutId),t.refreshTimeoutId=void 0),e&&t.expiredTimeoutId&&(clearTimeout(t.expiredTimeoutId),t.expiredTimeoutId=void 0),t.expiredTimeoutId||this.timers.delete(n)})}}Xi.tokenRefreshBufferMs=24e4,Xi.tokenExpirationBufferMs=12e4,Xi.tokenRefreshBackoffIntervalMs=3e4,Xi.tokenRefreshMaximumAttempts=3;class Zi extends dn.EventEmitter{constructor(e,t,n,a,i){if(super(),this.getSessionStats=e,this.clientMetadata=t,this.tokenRefreshManager=n,this.sendMessage=a,this.options=i||{},this.options.overrideSessionInitMessage=this.options.overrideSessionInitMessage||(e=>e),this.clientMetadata&&!this.clientMetadata.userSystemTimezone)try{this.clientMetadata.userSystemTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}}initSession(e){e.onResponse=e.onResponse||(()=>{});const t=hn.getCurrentTimeMs(),n=this.getSessionStats().lastConnectionClose&&t-this.getSessionStats().lastConnectionClose,a=this.getSessionStats().lastSyncMessage&&t-this.getSessionStats().lastSyncMessage,i=new V({operationName:"SessionInit"}).start(),r={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,timeSinceLastConnectionClose:n,timeSinceLastSyncMessage:a,isTokenRefresh:e.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,error:void 0},o=this.options.overrideSessionInitMessage(new pt({protocolVersion:2,clientMetadata:this.clientMetadata,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:e.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification}));this.sendMessage(o,(t,n)=>{if(i.success=!t,i.resultSignature=this.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect",i.resourceId=we(null==n?void 0:n.sliceUrl),i.setClientMetadata(this.clientMetadata),(null==n?void 0:n.sessionKey)&&r.sessionKey!==n.sessionKey&&(r.sessionKey=n.sessionKey),t&&(r.error=t.error),i.resultDescription=JSON.stringify(r),ae.info(508843779,ge.CoreDefault,i.stop()),e.onResponse(t,n),t)this.emit("serverAuthenticationStateChange",Yn.NotAuthenticated);else if(e.isReconnectOnSameSlice&&n.forceReconnect)this.emit("serverAuthenticationStateChange",Yn.NotAuthenticated);else{if(!n.anonymousToken||!n.tokenExpirationSeconds)return this.emit("serverAuthenticationStateChange",Yn.NotAuthenticated),void ae.error(508843778,ge.CoreDefault,"AL Anonymous token was not generated for the session");this.anonymousToken=n.anonymousToken,this.onSuccessfulSessionInitOnServerSide(n)}})}onSuccessfulSessionInitOnServerSide(e){this.tokenRefreshManager.scheduleRefresh(Qi.Anonymous,e.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),()=>{this.anonymousToken=void 0}),this.connectParams={isSeedingRequired:this.sessionKey!==e.sessionKey,sessionUrl:`${e.sessionUrlBase}/${e.sessionKey}`,origin:e.origin,authToken:this.anonymousToken},this.initHostAuthToken();const t=!!this.sessionKey;this.sessionKey=e.sessionKey,this.origin=e.origin,this.emit("connect",this.connectParams.isSeedingRequired,t,this.connectParams.sessionUrl,this.connectParams.origin,this.connectParams.authToken,e.workflowInputTypes,e.downstreamRuntimeWorkflows),t&&this.emit("reconnect")}getAuthToken(){const e={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:$n.Augloop,ConnectParams:this.connectParams};return this.options.requestAuthToken(e).then(e=>e).catch(()=>{})}initHostAuthToken(){const e=this.getAuthToken.bind(this);if(this.options.requestAuthToken&&e){const t=new V({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();e().then(e=>{if(e){if(!e.Token)return e.TokenError==ea.TokenMissingInteractionRequired?(this.emit("serverAuthenticationStateChange",Yn.TokenMissingInteractionRequired),t.resultDescription="Host auth token provision failed interaction required"):(this.emit("serverAuthenticationStateChange",Yn.NotAuthenticated),t.resultDescription="Host auth token provision failed"),t.success=!1,void ae.info(508843777,ge.CoreDefault,t.stop());ae.info(508843776,ge.CoreDefault,t.stop()),this.sendTokenProvisionMessage(e.Token)}else t.resultDescription="TokenResponse is not set"}).catch(e=>{this.emit("serverAuthenticationStateChange",Yn.NotAuthenticated),t.success=!1,t.resultDescription=`Error happened while attempting to fetch host token: ${e}`,ae.error(508843747,ge.CoreDefault,t.stop())})}}sendTokenProvisionMessage(e){const t=new Ut({authToken:e,version:1});this.emit("serverAuthenticationStateChange",Yn.Pending),this.sendMessage(t,this.onTokenProvisionResponse.bind(this),!0)}onTokenProvisionResponse(e,t){if(e||!t||!t.tokenExpirationSeconds)return void this.emit("serverAuthenticationStateChange",Yn.NotAuthenticated);const n=t.tokenType&&t.tokenType==ia.WacUserInfo?Yn.WacUserInfoAuthenticated:Yn.Authenticated;this.emit("serverAuthenticationStateChange",n),this.tokenRefreshManager.scheduleRefresh(Qi.Host,t.tokenExpirationSeconds,this.initHostAuthToken.bind(this))}}class $i{constructor(e){t.assign($i,this,e)}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[$i.getTypeName()])}}$i.H_={T_:$i.getTypeName(),B_:$i.getBaseTypes()};class er{constructor(e){t.assign(er,this,e)}static getTypeName(){return"AugLoop_Core_Binary"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[er.getTypeName()])}}er.H_={T_:er.getTypeName(),B_:er.getBaseTypes()};class tr{constructor(e){t.assign(tr,this,e)}static getTypeName(){return"AugLoop_Core_TileGroup"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[tr.getTypeName()])}}tr.H_={T_:tr.getTypeName(),B_:tr.getBaseTypes()};class nr{constructor(e){t.assign(nr,this,e)}static getTypeName(){return"AugLoop_Core_Session"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return t.matchesTypesFor(e,[nr.getTypeName()])}}nr.H_={T_:nr.getTypeName(),B_:nr.getBaseTypes()};class ar{constructor(e){t.assign(ar,this,e)}static getTypeName(){return"AugLoop_Core_Document"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return t.matchesTypesFor(e,[ar.getTypeName()])}}ar.H_={T_:ar.getTypeName(),B_:ar.getBaseTypes()};class ir{constructor(e){t.assign(ir,this,e)}static getTypeName(){return"AugLoop_Core_SubDocument"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[ir.getTypeName()])}}ir.H_={T_:ir.getTypeName(),B_:ir.getBaseTypes()};class rr{constructor(e){t.assign(rr,this,e)}static getTypeName(){return"AugLoop_Core_GridCell"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[rr.getTypeName()])}}rr.H_={T_:rr.getTypeName(),B_:rr.getBaseTypes()};class or{constructor(e){t.assign(or,this,e)}static getTypeName(){return"AugLoop_Core_GridNeighborhoodContext"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[or.getTypeName()])}}or.H_={T_:or.getTypeName(),B_:or.getBaseTypes()};class sr{constructor(e){t.assign(sr,this,e)}static getTypeName(){return"AugLoop_Core_ItemFilter"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[sr.getTypeName()])}}sr.H_={T_:sr.getTypeName(),B_:sr.getBaseTypes()};class cr{constructor(e){t.assign(cr,this,e)}static getTypeName(){return"AugLoop_Core_DynamicContext"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[cr.getTypeName()])}}cr.H_={T_:cr.getTypeName(),B_:cr.getBaseTypes()};class dr{constructor(e){t.assign(dr,this,e)}static getTypeName(){return"AugLoop_Core_ContextHolder"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[dr.getTypeName()])}}dr.H_={T_:dr.getTypeName(),B_:dr.getBaseTypes()};class lr{constructor(e){t.assign(lr,this,e)}static getTypeName(){return"AugLoop_Core_UserContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return t.matchesTypesFor(e,[lr.getTypeName()])}}lr.H_={T_:lr.getTypeName(),B_:lr.getBaseTypes()};class ur{constructor(e){t.assign(ur,this,e)}static getTypeName(){return"AugLoop_Core_TenantContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return t.matchesTypesFor(e,[ur.getTypeName()])}}ur.H_={T_:ur.getTypeName(),B_:ur.getBaseTypes()};class fr{constructor(e){t.assign(fr,this,e)}static getTypeName(){return"AugLoop_Core_EventsHolder"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[fr.getTypeName()])}}fr.H_={T_:fr.getTypeName(),B_:fr.getBaseTypes()};class pr{constructor(e){t.assign(pr,this,e)}static getTypeName(){return"AugLoop_Core_UserCommandsHolder"}static getBaseTypes(){return["AugLoop_Core_EventsHolder"]}static typeGuard(e){return t.matchesTypesFor(e,[pr.getTypeName()])}}pr.H_={T_:pr.getTypeName(),B_:pr.getBaseTypes()},function(e){e[e.Undefined=0]="Undefined",e[e.Created=10]="Created",e[e.Sent=20]="Sent",e[e.Duplicated=30]="Duplicated",e[e.Seen=40]="Seen",e[e.Tried=50]="Tried",e[e.Kept=60]="Kept",e[e.Rejected=70]="Rejected"}(Yi||(Yi={})),function(e){e[e.JoinContext=0]="JoinContext",e[e.Session=1]="Session"}(Ji||(Ji={})),Error;var mr={util:{},roots:{default:{}}},_r=(mr.util,mr.roots.default||(mr.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.sessionKey="",e.prototype.annotationType="",e.prototype.annotationState=0,e.prototype.workflowId="",e.prototype.traceId="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/AnnotationMetaDataChangeEvent"},e}());class hr extends _r{constructor(e){super(e),this.eventName="AnnotationMetaDataChange"}}class br{constructor(e){this.item=e,this.operation=e.op,this.delta=e.delta,this.deltas=e.deltas,this.id=ja(this.itemPath),this.revId=e.revId}get itemPath(){return[...this.item.parentPath,this.item.id]}getModelIterator(){throw new Error("Method not implemented.")}getBody(){return this.item.body}getItemReference(){throw new Error("Method not implemented.")}getParentItem(e){throw new Error("Method not implemented.")}getParentItemBody(e){throw new Error("Method not implemented.")}getPrevItem(e,t){throw new Error("Method not implemented.")}getPrevItemBody(e,t){throw new Error("Method not implemented.")}getNextItem(e,t){throw new Error("Method not implemented.")}getNextItemBody(e,t){throw new Error("Method not implemented.")}getChildItem(e){throw new Error("Method not implemented.")}getChildItemBody(e){throw new Error("Method not implemented.")}getChildItems(e){throw new Error("Method not implemented.")}getChildItemBodies(e){throw new Error("Method not implemented.")}getSubtreeItem(e){throw new Error("Method not implemented.")}getSubtreeItemBody(e){throw new Error("Method not implemented.")}getSubtreeItems(e){throw new Error("Method not implemented.")}getSubtreeItemBodies(e){throw new Error("Method not implemented.")}getContextItem(e){throw new Error("Method not implemented.")}getContextItemBody(e){throw new Error("Method not implemented.")}getContextItems(e){throw new Error("Method not implemented.")}getContextItemBodies(e){throw new Error("Method not implemented.")}addAnnotation(e,t){throw new Error("Method not implemented.")}updateAnnotation(e,t){throw new Error("Method not implemented.")}deleteAnnotation(e){throw new Error("Method not implemented.")}loadSubtree(e){throw new Error("Method not implemented.")}getSourceTimestamp(){return this.item.sourceTimestamp}getContextId(){return this.item.contextId}}class gr{constructor(e,n=[]){this.scopeItem=void 0,this.rootItem=void 0,this.normalizeFilter=e=>{if(!e)return e=>void 0!==e;if("function"==typeof e)throw new Error("Not implemented yet");if((e.id?1:0)+(e.ids?1:0)+(e.itemType?1:0)+(e.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");if(e.itemType)return n=>n&&t.matchesTypesFor(n.body,[e.itemType]);if(e.itemTypes)return n=>n&&t.matchesTypesFor(n.body,e.itemTypes);throw new Error("Not implemented yet")},this.items=[...n,e],this.scopeItem=new br(e)}getItem(e){throw new Error("Method not implemented.")}getItems(e){throw new Error("Method not implemented.")}getItemBody(e){return this.getItemBodies(e)[0]}getItemBodies(e){const t=this.normalizeFilter(e);return this.items.filter(t).map(e=>e.body)}getItemByReference(e){throw new Error("Method not implemented.")}getItemBodyByReference(e){throw new Error("Method not implemented.")}}const vr=[di.CursorUpdate,di.FormattingUpdate,di.OtherNonContentUpdate,di.AttributionUpdate];function yr(e,n,a){const i=new V({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();try{if(!n)return i.success=!1,i.resultDescription="Unable to apply text tile delta, parent tile is undefined",void ae.info(538798173,ge.CoreDefault,i.stop());if(t.getTypeNameFor(n)!==pi.getTypeName())return i.success=!1,i.resultDescription=`Unable to apply text tile delta, parent tile is not proper type: expected ${Si.getTypeName()}, received ${t.getTypeNameFor(n)}`,void ae.info(538798174,ge.CoreDefault,i.stop());const a=e,r=n.content;let o="";if(void 0===a.position||a.position<0)return i.success=!1,i.resultDescription="Unable to apply text tile delta, invalid text tile position",void ae.info(538798175,ge.CoreDefault,i.stop());switch(a.deltaType){case di.Add:o=a.position<r.length?`${r.slice(0,a.position)}${a.content}${r.slice(a.position,r.length)}`:r+a.content;break;case di.Update:a.content||a.unit!==li.Sentence||(i.dimension0="1"),o=`${r.slice(0,a.position)}${a.content}${r.slice(a.position+(a.length||0),r.length)}`;break;case di.Delete:o=`${r.slice(0,a.position)}${r.slice(a.position+(a.length||0),r.length)}`}return ae.info(538837071,ge.CoreDefault,i.stop()),new pi({content:o})}catch(e){return i.success=!1,i.resultDescription=`Error applying text tile delta: ${e}`,void ae.info(538798176,ge.CoreDefault,i.stop())}}function Sr(e,t){var n,a,i,r,o;const s=qe("useAttributionDataPropFormattedTextDeltas"),c=s&&(null===(n=t.attributionData)||void 0===n?void 0:n.ranges)||t.attributionRanges;if(s&&((null===(a=t.attributionData)||void 0===a?void 0:a.isFullUpdate)||t.deltaType!==di.AttributionUpdate&&void 0!==c))return c;if(!qe("updateAttributionRangesInFormattedTextDeltas")||!(null===(i=e.attributionRanges)||void 0===i?void 0:i.length)&&!c||s&&t.deltaType===di.Update&&0===t.length)return e.attributionRanges;let d=e.attributionRanges?[...e.attributionRanges]:[];if(t.deltaType!==di.AttributionUpdate){const n=Ir(e.attributionRanges,t.deltaType,t.position),a=n?d.indexOf(n):-1;-1!==a&&(n.length=t.position-n.start);const i=(null!==(r=t.content)&&void 0!==r?r:"").length,s=null!==(o=t.length)&&void 0!==o?o:0,c=t.position+s,l=t.position+i;for(const e of d.slice(a+1)){if(e.start<t.position)continue;const n=e.start+e.length;c>e.start&&(e.length=n-c),e.start=Math.max(e.start+i-s,l)}return d=d.filter(e=>e.length>0),d}const l=[];for(const e of c)0!==l.length&&l[l.length-1].start+l[l.length-1].length>=e.start?l[l.length-1].length=e.start+e.length-l[l.length-1].start:l.push({start:e.start,length:e.length});d=d.filter(e=>e.length>0&&!(e=>{for(const t of l)if(t.start<=e.start&&t.start+t.length>=e.start+e.length)return!0;return!1})(e)),null==c||c.forEach(e=>{d.push(e)}),d.sort((e,t)=>e.start-t.start);const u=[];for(const e of d){const t=u.length>0?u[u.length-1]:void 0;t&&t.start+t.length>e.start&&(t.length=Math.max(e.start-t.start,0)),!t||(p=e,(f=t).attribution.userId!==p.attribution.userId||f.attribution.timestamp!==p.attribution.timestamp||f.attribution.dataSource!==p.attribution.dataSource)||e.start>t.start+t.length?u.push(e):t.length+=Math.max(e.start+e.length-(t.start+t.length),0)}var f,p;return u}function Dr(e,n,a){var i,r,o,s;const c=new V({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();c.clientFlights=a;try{if(!n)return c.success=!1,c.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",void ae.info(538798177,ge.CoreDefault,c.stop());if(t.getTypeNameFor(n)!==mi.getTypeName())return c.success=!1,c.resultDescription=`Unable to apply formatted text tile delta, parent tile is not proper type: expected ${mi.getTypeName()}, received ${t.getTypeNameFor(n)}`,void ae.info(538798178,ge.CoreDefault,c.stop());const a=n,d=e,l=a.content;let u="";if((void 0===d.position||d.position<0)&&!Cr(d.deltaType))return c.success=!1,c.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",void ae.info(538798179,ge.CoreDefault,c.stop());if(void 0===d.content&&!Cr(d.deltaType))return c.success=!1,c.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",void ae.info(538798208,ge.CoreDefault,c.stop());if(d.deltaType===di.Add&&0!==d.length?ae.info(538798209,ge.CoreDefault,new V({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):Cr(d.deltaType)&&void 0!==d.content&&ae.info(538798210,ge.CoreDefault,new V({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),!xr(d.deltaType)){const e=function(e,t){var n,a,i,r;const o=Ir(e.formattedRanges,t.deltaType,t.position);let s=e.formattedRanges?[...e.formattedRanges]:[];const c=o?s.indexOf(o):-1;-1!==c&&(t.position+(t.length||0)>o.start+o.length?o.length=t.position+(null!==(n=t.content)&&void 0!==n?n:"").length-o.start:o.length+=(null!==(a=t.content)&&void 0!==a?a:"").length-(t.length||0),s[c]=o);for(const e of s.slice(c+1))e.start<t.position||(t.position+(t.length||0)>e.start?(e.length=e.start+e.length-(t.position+(t.length||0)),e.start=t.position+(null!==(i=t.content)&&void 0!==i?i:"").length):e.start+=(null!==(r=t.content)&&void 0!==r?r:"").length-(t.length||0));return s=s.filter(e=>e.length>0),s}(a,d),t=Sr(a,d);let n=a.ipPosition;switch(d.deltaType){case di.Add:u=d.position<l.length?`${l.slice(0,d.position)}${d.content}${l.slice(d.position,l.length)}`:l+d.content,n=d.position+d.length;break;case di.Update:d.content||d.unit!==li.Sentence||(c.dimension0="1"),u=`${l.slice(0,d.position)}${d.content}${l.slice(d.position+(null!==(i=d.length)&&void 0!==i?i:0),l.length)}`,n=d.position+d.content.length;break;case di.Delete:u=`${l.slice(0,d.position)}${l.slice(d.position+(null!==(r=d.length)&&void 0!==r?r:0),l.length)}`,n=d.position}const o=new mi(Object.assign(Object.assign({},a),{ipPosition:n,content:u,formattedRanges:e,attributionRanges:t,queryRange:d.queryRange}));return ae.info(538837073,ge.CoreDefault,c.stop()),o}if(d.deltaType===di.CursorUpdate)return new mi(Object.assign(Object.assign({},a),{ipPosition:null===(o=d.cursorData)||void 0===o?void 0:o.ipPosition,isColdIp:null===(s=d.cursorData)||void 0===s?void 0:s.isColdIp}));if(d.deltaType===di.FormattingUpdate)return new mi(Object.assign(Object.assign({},a),{formattedRanges:d.formattedRanges}));if(d.deltaType===di.OtherNonContentUpdate){let e;const t={};for(e in d.otherNonContentData)t[e]=d.otherNonContentData[e];return new mi(Object.assign(Object.assign({},a),t))}return d.deltaType===di.AttributionUpdate?new mi(Object.assign(Object.assign({},a),{attributionRanges:Sr(a,d)})):void 0}catch(e){return c.success=!1,c.resultDescription=`Error applying formatted text tile delta: ${e}`,void ae.info(538798211,ge.CoreDefault,c.stop())}}function Ir(e,t,n){const a=new V({operationName:"FindRangeForDelta",success:!0});if(a.start(),!e)return a.resultDescription="No formatted ranges found within the tile, skipping.",void ae.info(538798212,ge.CoreDefault,a.stop());if(t===di.Add){const t=e.find(e=>e.start===n&&0===e.length);if(t)return a.resultDescription=`Found a zero-length formatted range for add operation with start ${t.start}.`,ae.info(538798213,ge.CoreDefault,a.stop()),t;n=Math.max(n-1,0)}const i=e.find(e=>0===e.length?e.start===n:e.start<=n&&n<e.start+e.length);return i?(a.resultDescription=`Updating formatted range for operation with start: ${i.start} and length: ${i.length}`,ae.info(538798214,ge.CoreDefault,a.stop())):(a.resultDescription=`Unable to find formatted range for operation at position ${n}, skipping.`,ae.info(538798215,ge.CoreDefault,a.stop())),i}function xr(e){return-1!==vr.indexOf(e)}function Cr(e){return xr(e)||di.Delete===e}function Or(e){if(!e)return new wr([],new Set,new Map,new Map);const t=e.split(";"),n=new Set,a=new Map,i=new Map;for(const e of t){const t=e.trim();if(""===t)continue;n.add(wr.normalizeName(t));const[r,...o]=t.split(":"),s=o.join(":"),c=wr.normalizeName(r);if(c){a.set(c,s);const e=wr.parseName(c);e&&e!==c&&i.set(e,c)}}return new wr(t,n,a,i)}class wr{constructor(e,t,n,a){this.originalFlights=e,this.normalizedFlights=t,this.keyValueFlightsMap=n,this.parsedFlightsMap=a}static normalizeName(e){return null==e?void 0:e.toLowerCase()}static parseName(e){const t=null==e?void 0:e.split(".");return t?t[t.length-1]:void 0}hasFlight(e){const t=wr.normalizeName(e),n=this.normalizedFlights.has(t),a=this.keyValueFlightsMap.has(t),i=this.parsedFlightsMap.has(t);return n||a||i}getBooleanValue(e,t){var n,a;const i=null===(n=this.getStringValue(e))||void 0===n?void 0:n.toLowerCase(),r=null===(a=this.getStringValue(this.parsedFlightsMap.get(wr.normalizeName(e))))||void 0===a?void 0:a.toLowerCase();return"true"===i||"true"===r||"false"!==i&&"false"!==r&&t}getIntValue(e,t){const n=this.getStringValue(e),a=Number.parseInt(n,10);return Number.isNaN(a)?t:a}getStringValue(e,t){var n;return null!==(n=this.keyValueFlightsMap.get(wr.normalizeName(e)))&&void 0!==n?n:t}getAll(){return this.originalFlights}getAllParsed(){const e=[];return this.keyValueFlightsMap.forEach((t,n)=>{const a=null==t?void 0:t.toLowerCase();switch(a){case"true":e.push({name:n,value:!0});break;case"false":e.push({name:n,value:!1});break;default:{const i=Number.parseInt(a,10);Number.isNaN(i)?e.push({name:n,value:t}):e.push({name:n,value:i})}}}),e}}class Er{constructor(e){this.model=e.model,this.clientMetadata=e.clientMetadata,this.userContext=e.userContext,this.site=e.site,this.getTokenCallback=e.getTokenCallback}get flights(){var e;return null!==(e=this._flights)&&void 0!==e||(this._flights=Or(this.clientMetadata.flights)),this._flights}getToken(e,t){return this.getTokenCallback(e,t)}}class Ar{constructor(e,t,n){this.itemsContextId=new Set,this.executionState=new Map,this.graphNode=e,this.onContextIdWorkflowExecutionComplete=t,n&&(this.itemsContextId=n.itemsContextId,this.executionState=n.executionState)}addInputItemToProcess(e){this.itemsContextId.add(e)}removeProcessedInputItem(e){this.itemsContextId.delete(e)}countItemsToProcess(e){let t=0;for(const n of this.itemsContextId)0===n.indexOf(e)&&(t+=1);return t}getExecutionState(){return this.executionState}setExecutionState(e,t){return this.graphNode.isActivated?e?(this.executionState.set(e,t),!0):(ae.info(520217546,ge.CoreDefault,new V({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for a undefined contextId (setExecutionState)`})),!1):(ae.info(508883415,ge.CoreDefault,new V({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for a not activated workflow`})),!1)}beforeWorkflowExecution(e){this.setExecutionState(e,si.Pending)}afterWorkflowExecution(e){this.setExecutionState(e,si.Executed)&&this.tryToCompleteWorkflowExecution(e)}clearWorkflowExecutions(){this.executionState.forEach((e,t)=>this.afterWorkflowExecution(t))}tryToCompleteWorkflowExecution(e){if(this.executionState.get(e)===si.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,e);for(const t of this.downstreamWorkflowExecutionTrackers)for(const[n,a]of t.getExecutionState())a===si.Executed&&oi.isParentContextId(e,n)&&t.tryToCompleteWorkflowExecution(n)}}canCompleteExecution(e){for(const t of this.upstreamWorkflowExecutionTrackers)for(const n of t.getExecutionState().keys())if(oi.isParentContextId(n,e))return!1;return!0}}var Lr;!function(e){e.Unknown="",e.InputReceived="input",e.JoinMaxAnnnotation="maxAnnotation",e.JoinMaxTimeout="maxTimeout",e.JoinEarlyCompletion="earlyCompletion"}(Lr||(Lr={}));class kr{constructor(e,n,a){this.executionTrackersByWorkflowNameBySession=new Map,this.workflowsWithSessionAffinity=new Map,this.workflowDefinitionsWithSessionAffinity=[],this.workflowsWithoutSessionAffinity=[],this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.sweepIntervalMs=200,this.sweepTimers=new Map,this.getResourceAsArrayBuffer=(e,t,n)=>this.modelDownloader?this.modelDownloader.getResourceAsArrayBuffer(e,t,n):Promise.reject(new Error("Resource Downloader never created")),this.getResourceAsURL=(e,t,n)=>this.modelDownloader?this.modelDownloader.getResourceAsURL(e,t,n):Promise.reject(new Error("Resource Downloader never created")),this.createModel=e=>(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService?this.inferenceService.then(t=>t.createModel(e)):Promise.reject(new Error("Inference Service never created"))),this.createModelInputs=()=>{if(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService)return this.inferenceService.then(e=>e.createInputs());throw new Error("Inference Service never created")},this.nextAnnotationId=1,this.nextSignalId=1,this.modelDownloader=e,this.inferenceServiceFactory=n,a.enableDeltas&&(this.deltaHandlers=(new Map).set(t.getTypeNameFor(Si),yr).set(t.getTypeNameFor(Di),Dr),this.itemsForDelta=new Map),this.enableEarlyJoin=a.enableEarlyJoin||!1,this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}getNextClientAnnotationId(){return"#AC"+this.nextAnnotationId++}getNextClientSignalId(){return"#SC"+this.nextSignalId++}registerLocalWorkflow(e,t){const n=new V({operationName:"WorkflowRegistration",resourceId:e.id}).start();if(0===e.inputTypes.length)throw new Error("Invalid workflow params");t?(this.workflowsWithSessionAffinity.get(t).push(this.createWorkflowImplementation(e,t)),t.registerContextTypes(Na(e.requestedContextTypesRules).map(([e,t])=>e)),t.attachToWorkflowGraph(e),n.setClientMetadata(t.getClientMetadata())):(e.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(e),this.workflowsWithSessionAffinity.forEach((t,n)=>{t.push(this.createWorkflowImplementation(e,n))})):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(e)),this.workflowsWithSessionAffinity.forEach((t,n)=>{n.registerContextTypes(Na(e.requestedContextTypesRules).map(([e,t])=>e)),n.attachToWorkflowGraph(e)})),n.success=!0,ae.info(572838110,ge.CoreDefault,n.stop())}getAllRegisteredWorkflowsFromSession(e){const t=[];return t.push(...this.workflowsWithoutSessionAffinity||[]),t.push(...this.workflowsWithSessionAffinity.get(e)||[]),t.map(e=>e.workflow)}getWorkflowDefinitionsByName(e){var t;const n=new Map;return null===(t=this.workflowsWithSessionAffinity.get(e))||void 0===t||t.forEach(e=>n.set(e.workflow.id,e.workflow)),n}getWorkflowDefinitionsWithSessionAffinity(){return this.workflowDefinitionsWithSessionAffinity}attachExecutionTrackerToEachWorkflow(e,t,n){const a=e.getWorkflowNodes(),i=this.executionTrackersByWorkflowNameBySession.get(t),r=(e,a)=>{n&&n(e,a),this.enableEarlyJoin&&(()=>{for(const e of this.executionTrackersByWorkflowNameBySession.get(t).values())if(e.graphNode.workflow.kind===ca.Join)for(const t of e.getExecutionState().keys())if(oi.isParentContextId(t,a))return!0;return!1})()&&(this.cancelSweepTimer(t),this.ensureSweepTimer(t),this.sweepScopeExecutionNotifications())};for(const e of a){const t=i.get(e.workflow.id),n=new Ar(e,r.bind(this),t);i.set(e.workflow.id,n)}for(const e of i.values())this.setDownstreamWorkflowExecutionTrackers(e,i),this.setUpstreamWorkflowExecutionTrackers(e,i)}canActivateWorkflow(e,t){var n;return e.location===$a.Local||!!t.hasConnected&&!((null===(n=e.workflow.requiredTokenTypes)||void 0===n?void 0:n.length)>0&&t.getServerAuthenticationState()===Yn.NotAuthenticated)}setDownstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.downstreamWorkflowExecutionTrackers)return;e.downstreamWorkflowExecutionTrackers=new Set;const{graphNode:n}=e;for(const a of n.downstreamWorkflows||[]){const n=t.get(a.workflow.id);this.setDownstreamWorkflowExecutionTrackers(n,t),e.downstreamWorkflowExecutionTrackers.add(n)}}setUpstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.upstreamWorkflowExecutionTrackers)return;e.upstreamWorkflowExecutionTrackers=new Set;const{graphNode:n}=e;for(const a of n.upstreamWorkflows||[]){const n=t.get(a.workflow.id);this.setUpstreamWorkflowExecutionTrackers(n,t),e.upstreamWorkflowExecutionTrackers.add(n)}}deactivateServerWorkflow(e,t){var n;e.location!==$a.Local&&(null===(n=this.executionTrackersByWorkflowNameBySession.get(t))||void 0===n||n.get(e.workflow.id).clearWorkflowExecutions(),e.isActivated=!1)}addSession(e){this.executionTrackersByWorkflowNameBySession.set(e,new Map);const t=[];for(const n of this.workflowDefinitionsWithSessionAffinity)t.push(this.createWorkflowImplementation(n)),e.attachToWorkflowGraph(n);this.workflowsWithSessionAffinity.set(e,t);for(const t of this.workflowsWithoutSessionAffinity)e.attachToWorkflowGraph(t.workflow)}closeSession(e){this.cancelSweepTimer(e);for(const t of this.workflowsWithSessionAffinity.get(e)||[])t.workflowLambda.dispose();this.workflowsWithSessionAffinity.delete(e)}setTokenCallback(e){this.getAuthTokenCallback=e}preProcessItemToWorkflow(e,n,a){const i=this.executionTrackersByWorkflowNameBySession.get(a).get(e.id);e.kind===ca.Join&&t.matchesTypesFor(n.body,e.inputTypes)&&i.addInputItemToProcess(n.contextId),(e.kind===ca.SingleItem&&t.matchesTypesFor(n.body,e.inputTypes)||e.kind===ca.Join&&t.matchesTypesFor(n.body,[e.collectionScopeType]))&&i.beforeWorkflowExecution(n.contextId)}isReadyToEarlyJoin(e,t,n){const a=a=>{var i;const r=Array.from(null!==(i=a.states)&&void 0!==i?i:[]).map(e=>`${e[0]}: ${e[1].map(e=>e.join())}`).join(),o=new V({operationName:"EarlyJoinCompletion",resourceId:e.graphNode.workflow.id,joinContextId:t,success:!0}).start();o.setClientMetadata(n),o.resultDescription=`isReadyToEarlyJoin (${this.enableEarlyJoin}) -> hasProcessedAllInputItems: ${a.hasProcessedAllInputItems}, allUpstreamComplete: ${a.allUpstreamComplete}, states: ${r}`,ae.info(512550800,ge.CoreDefault,o.stop())},i=0===e.countItemsToProcess(t);if(!i)return this.enableEarlyJoin||a({hasProcessedAllInputItems:i}),!1;const{allUpstreamComplete:r,states:o}=this.areAllUpstreamWorkflowComplete(e,t);return this.enableEarlyJoin?r:(a({hasProcessedAllInputItems:i,allUpstreamComplete:r,states:o}),!1)}areAllUpstreamWorkflowComplete(e,t){const n=new Map;for(const a of e.upstreamWorkflowExecutionTrackers){const e=[];for(const[i,r]of a.getExecutionState())if(e.push([i,r]),oi.isParentContextId(t,i))return n.set(a.graphNode.workflow.id,e),{allUpstreamComplete:!1,states:n};e.length>0&&n.set(a.graphNode.workflow.id,e)}return{allUpstreamComplete:!0,states:n}}runLocalWorkflows(e,n,a=!1){var i,r,o;const s=(e,a,i)=>{var r,o;const s=n.getWorkflowItemStorage(),{workflow:c}=e,d=null===(r=this.executionTrackersByWorkflowNameBySession.get(n))||void 0===r?void 0:r.get(c.id),l=c.inputTypes.concat(c.kind===ca.Join?c.collectionScopeType:[]),u=new V({operationName:"RunLocalWorkflows",success:!0,resourceId:c.id,joinContextId:a.contextId}).start();if(u.setClientMetadata(n.getClientMetadata()),t.matchesTypesFor(a.body,l)){const r=Ba(i.parentPath,a);if(c.kind===ca.Join){if(t.matchesTypesFor(r.body,[c.collectionScopeType]))return s.setScopeItem(r,c),u.resultDescription=`Scope item: ${a.id} (${t.getTypeNameFor(a.body)})`,ae.info(524126153,ge.CoreDefault,u.stop()),void this.setScopeExecutionNotification(n,e,r,Vi.Internal);{d.removeProcessedInputItem(r.contextId);const e=s.getScopeItem(r.contextId,c);if(!e)return u.resultDescription=`Filtered out join invalidation: out of scope type (${c.collectionScopeType}), item id: ${r.id}`,void ae.info(541173894,ge.CoreDefault,u.stop());s.addItemToWorkflowList(r,c),u.joinContextId=e.contextId,u.resultDescription=`Input item: ${a.id} (${t.getTypeNameFor(a.body)})`}}if(t.getBaseTypesFor(r.body).indexOf(dr.getTypeName())>=0){const e=[...r.parentPath,r.id];let t=!0;for(const a of null!==(o=c.outputTypes)&&void 0!==o?o:[])if(!n.getContextAnnotations(a,ji.LocalWorkflow,e,c.id)){t=!1;break}if(t)return}const l=()=>{var t;const[i,o]=n.resolveRequestedContexts(c);if(!i)return u.resultDescription=`Required contexts are not ready for ${c.id}. Retrying execution in 500 milliseconds...`,ae.info(545837259,ge.CoreDefault,u.stop()),void setTimeout(l,500);if(c.kind===ca.SingleItem)this.queueWorkflow({workflowInfo:e,scopeItem:r,inputItems:[r],requestedContexts:o,session:n,orchestrationMode:Vi.Internal,triggerReason:Lr.InputReceived,onCompleteCallback:this.onWorkflowExecuted.bind(this,r,c,n)}).then(()=>{ae.info(509154263,ge.WorkflowDefault,u.stop())}).catch(e=>{u.resultDescription=e,ae.error(572838111,ge.CoreDefault,u.stop())});else if(c.kind===ca.Join){const i=a.contextId,r=s.getScopeItem(i,e.workflow);if(!r)return u.resultDescription=`No scope item for ${c.id} workflow from contextId ${i}`,void ae.info(526758475,ge.CoreDefault,u.stop());const l=this.isReadyToEarlyJoin(d,r.contextId,n.getClientMetadata()),f=l?Lr.JoinEarlyCompletion:Lr.JoinMaxAnnnotation;if(s.isWorkflowReady(r.contextId,c)||l){if(!(null===(t=this.pendingScopeExecutionNotificationsByWorkflow.get(c.id))||void 0===t?void 0:t.get(r.contextId)))return u.resultDescription=`Workflow ${c.id}, contextId ${r.contextId}, already queued, skipping new scope execution`,void ae.info(528048977,ge.CoreDefault,u.stop());const a=s.getItemsToExecute(r.contextId,c);this.queueWorkflow({workflowInfo:e,scopeItem:r,inputItems:a,requestedContexts:o,session:n,orchestrationMode:Vi.Internal,triggerReason:f,onCompleteCallback:this.onWorkflowExecuted.bind(this,r,c,n)}).then(()=>{ae.info(509154262,ge.WorkflowDefault,u.stop())}).catch(e=>{u.resultDescription=e,ae.error(541173895,ge.CoreDefault,u.stop())}),this.pendingScopeExecutionNotificationsByWorkflow.get(c.id).delete(r.contextId),0===this.pendingScopeExecutionNotificationsByWorkflow.get(c.id).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(c.id)}}};l()}};let c=e;a&&(c=[new p({parentPath:["session"],items:[{id:"#userContext#",body:new lr}]}),new p({parentPath:["session"],items:[{id:"#tenantContext#",body:new ur}]})],n.getContextIdManager().applyContextIdOnOperations(c),c=c.concat(e));for(const e of c){const a=t.getTypeNameFor(e);for(const t of e.items)if(n.applyOperationForContext(e,t,ji.Submitted),a!==b.getTypeName()){if(t.body)if(a===I.getTypeName()&&this.deltaHandlers&&this.itemsForDelta)this.handleLocalDeltaUpdate(t,e,n);else{null===(r=this.itemsForDelta)||void 0===r||r.set(e.parentPath.concat(t.id).toString(),t);for(const n of this.workflowsWithoutSessionAffinity)s(n,t,e);for(const a of null!==(o=this.workflowsWithSessionAffinity.get(n))&&void 0!==o?o:[])s(a,t,e)}}else null===(i=this.itemsForDelta)||void 0===i||i.delete(e.parentPath.concat(t.id).toString())}}handleLocalDeltaUpdate(e,n,a){const i=new V({operationName:"LocalDeltaUpdate",dimension0:t.getTypeNameFor(e.body),success:!0});i.start();try{const r=this.deltaHandlers.get(t.getTypeNameFor(e.body)),o=this.itemsForDelta.get(n.parentPath.toString());if(r&&o){const t=n.parentPath.length>0?n.parentPath.slice(0,n.parentPath.length-1):n.parentPath,s=r(e.body,o.body);if(s){const n={id:o.id,revId:e.revId,body:s,parentPath:t,delta:e.body,contextId:e.contextId},r=new u({parentPath:n.parentPath,items:[n]});ae.info(539637591,ge.CoreDefault,i.stop()),this.runLocalWorkflows([r],a)}else i.success=!1,i.resultDescription="Failed because the handler did not produce valid updated item",ae.info(539637592,ge.CoreDefault,i.stop())}else i.success=!1,i.resultDescription="Failed due to lack of handler or parent item",ae.info(539637593,ge.CoreDefault,i.stop())}catch(e){i.success=!1,i.resultDescription=`Failed to apply delta, error: ${e}`,ae.info(539637594,ge.CoreDefault,i.stop())}}createWorkflowImplementation(e,t){const n=e.factory();return{workflow:e,workflowLambda:n,initPromise:this.initWorkflow(e.kind,n,t)}}initWorkflow(e,t,n){const a=new Er({model:void 0,clientMetadata:n?n.getClientMetadata():void 0,userContext:n?n.getUserContext():void 0,site:this.site,getTokenCallback:this.getAuthTokenCallback});return e===ca.SingleItem||e===ca.Join?t.init(this.site,a):Promise.resolve()}queueWorkflow(e){return this.executionTrackersByWorkflowNameBySession.get(e.session).get(e.workflowInfo.workflow.id).setExecutionState(e.scopeItem.contextId,si.Running),this.executeLocalWorkflow(e.workflowInfo,e.scopeItem,e.inputItems,e.session,e.requestedContexts,e.orchestrationMode,e.triggerReason).then(t=>{this.processAnnotationResults(t,e.session),e.onCompleteCallback()}).catch(t=>{throw e.onCompleteCallback(),t})}processAnnotationResults(e,t){for(const n of e)t.onAnnotationResults(n,ji.LocalWorkflow,()=>{})}executeLocalWorkflow(e,n,a,i,r,o,s){return new Promise((c,d)=>{var l,u,f;const m=[],_=e.workflow,b=new V({operationName:"ExecuteWorkflow",resourceId:_.id,joinContextId:null!==(l=null==n?void 0:n.contextId)&&void 0!==l?l:"",resultDescription:null!=s?s:"",success:!0}).setClientMetadata(i.getClientMetadata());b.start();const g=null!==(u=null==n?void 0:n.contextId)&&void 0!==u?u:a[0].contextId,v=null!==(f=null==n?void 0:n.revId)&&void 0!==f?f:a[0].revId,y=(()=>{const e=new Map;if(n&&(n.parentPath||ae.error(525382231,ge.CoreDefault,`Missing scope item parent. Workflow: ${_.id}. Type: ${t.getTypeNameFor(n.body)}`),e.set(n.body,n)),Array.isArray(a))for(const n of a)n&&n.body&&(n.parentPath||ae.error(525382232,ge.CoreDefault,`Missing parent. Workflow: ${_.id}. Type: ${t.getTypeNameFor(n.body)}`),e.set(n.body,n));return e})(),S=(e,t=b)=>{if(e)return t.success=!1,t.resultDescription+="string"==typeof e?e:e.message,t.resultSignature="Exception",ae.error(572838112,ge.CoreDefault,t.stop()),"string"==typeof e?new Error(e):e;ae.info(572838113,ge.CoreDefault,t.stop())},D=new Er({model:new gr(a[0],r),clientMetadata:i.getClientMetadata(),userContext:i.getUserContext(),site:this.site,getTokenCallback:this.getAuthTokenCallback}),I=e=>{S(e?e.message:void 0),e?d(e):c(m)},x={setAnnotations:(r,s,c,l)=>{var u;const f=new V({operationName:"SetAnnotations",resourceId:s,joinContextId:null!==(u=null==n?void 0:n.contextId)&&void 0!==u?u:"",success:!0}).setClientMetadata(i.getClientMetadata());f.start();const b=t=>{ae.info(555866112,ge.CoreDefault,new hr({annotationType:s,annotationState:t,workflowId:e.workflow.id}))};for(const e of c)e.metadata=Object.assign(Object.assign({},e.metadata),{state:Yi.Created}),b(Yi.Created);const D=y.get(r),I=t.getTypeNameFor(D.body),x=(()=>{var e;if(_.kind===ca.SingleItem&&a[0].body!==r){const e=`Expected obj to be ${a[0].body} but instead it was ${r}`;return S(e,f),void d(S(e))}let n,u;if(Array.isArray(c))if(!_.outputTypes||_.outputTypes.indexOf(s)<0)n=`Workflow said it would output one of [${_.outputTypes}] but instead output ${s}`;else if(D)for(const e of c)t.matchesTypesFor(e,[ln.getTypeName()])?t.getTypeNameFor(e)!==s&&(n=`Workflow produced inconsistent annotation types in setAnnotations call (${t.getTypeNameFor(e)} did not match expected ${s})`):n=`Workflow produced an output that is not an annotation ${t.getTypeNameFor(e)}`;else n="No item provided";else n="Workflow produced an invalid annotation array";if(n)return S(n,f),void d(S(n));if(u=l&&l.isSessionAnnotation?["session"]:l&&l.ancestorType?D.parentPath:D.parentPath.concat(D.id),o===Vi.External)return;const m=[],y=[];for(const t of c){t.metadata=Object.assign(Object.assign({},t.metadata),{state:Yi.Sent}),b(Yi.Sent);const n=t.id,a=n?null===(e=i.getContextAnnotations(s,ji.LocalWorkflow,u,_.id))||void 0===e?void 0:e.filter(e=>{var t;return(null===(t=e.body)||void 0===t?void 0:t.id)==n}):void 0;1==(null==a?void 0:a.length)?1==a.length?y.push({id:a[0].id,source:_.id,revId:v,body:t,contextId:g}):ae.error(545837260,ge.CoreDefault,`Assert: Multiple existing context annotations with body id ${n} found for ${s} and local workflow ${_.id}).`):m.push({id:this.getNextClientAnnotationId(),source:_.id,revId:v,body:t,contextId:g})}const I=[];return m.length>0&&I.push(new p({parentPath:u,items:m,parentRevId:v})),y.length>0&&I.push(new h({parentPath:u,items:y,parentRevId:v})),new Tt({annotationType:s,ops:I})})();x?(l&&l.immediate?i.onAnnotationResults(x,ji.LocalWorkflow,()=>{}):m.push(x),(I==lr.getTypeName()||I==ur.getTypeName()||t.matchesTypesFor(D.body,[ar.getTypeName(),ir.getTypeName()]))&&i.submitOperationsToSession(x.ops),ae.info(509644822,ge.CoreDefault,f.stop())):ae.info(509644823,ge.CoreDefault,f.stop())},submitSignals:e=>{if(o===Vi.External)return void d(S("NYI"));const n=new V({operationName:"submitSignalsAction",resourceId:_.id,success:!0}).setClientMetadata(i.getClientMetadata());for(const a of e){const e=t.getTypeNameFor(a);t.matchesTypesFor(a,[pn.getTypeName()])||(n.resultDescription=`Workflow produced an output that is not an signal (${t.getTypeNameFor(a)})`,ae.info(521413954,ge.CoreDefault,n)),_.outputTypes&&-1!==_.outputTypes.indexOf(e)||(n.resultDescription=`Workflow said it would output one of [${_.outputTypes}] but instead output ${e}`,ae.info(521413953,ge.CoreDefault,n)),a.timestamp&&(kr.logTimestampUsageByWorkflowId.has(_.id)||(kr.logTimestampUsageByWorkflowId.add(_.id),n.resultDescription=`Workflow "${_.id}" sets signal.timeStamp`,ae.info(509212803,ge.CoreDefault,n)))}const a=e.map(e=>({id:this.getNextClientSignalId(),source:_.id,revId:v,body:e,contextId:g})),r=new C({parentPath:["session"],parentRevId:v,items:a});i.submitOperations([r])},done:I,overrideWorkflowDefinition:(e,t,a)=>{let r;switch(a){case Ji.JoinContext:if(!n.contextId){const e="ContextId is not defined for this scope item.";throw ae.error(527472289,ge.CoreDefault,e),new Error(e)}r=n.contextId;break;case Ji.Session:r=void 0;break;default:{const e="Defined scope is not supported. "+a;throw ae.error(527472290,ge.CoreDefault,e),new Error(e)}}const o=new Ma({definition:t,contextId:r,sourceWorkflowId:_.id,targetWorkflowId:e});i.onWorkflowDefinitionOverrideMessage(o)},getDynamicAnnotations:void 0,setBillingDomain:void 0},O=e.workflowLambda;if(_.kind===ca.SingleItem){1!==a.length&&I(new Error("Single item workflows expect a single input")),D.delta=a[0].delta,D.deltas=a[0].deltas;try{const t=O;e.initPromise||(e.initPromise=t.init(this.site,D)),e.initPromise.then(()=>{t.execute(a[0].body,D,x)}).catch(e=>{S(e)})}catch(e){S(e)}}else if(_.kind===ca.Join){0===a.length&&I(new Error("Join workflows expect an inputs array")),D.delta=n.delta,D.deltas=n.deltas;try{const t=O;e.initPromise||(e.initPromise=t.init(this.site,D)),e.initPromise.then(()=>{t.execute(n.body,a.map(e=>e.body),D,x)}).catch(e=>{S(e)})}catch(e){S(e)}}else S(`Workflow kind ${_.kind} not supported`)})}ensureSweepTimer(e){if(!this.sweepTimers.get(e)){const t=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(e,t)}}cancelSweepTimer(e){const t=this.sweepTimers.get(e);this.sweepTimers.get(e)&&(clearInterval(t),this.sweepTimers.delete(e))}onSweep(){this.sweepScopeExecutionNotifications()}setScopeExecutionNotification(e,t,n,a){var i,r;const o=Date.now(),s={session:e,workflowImplementation:t,scopeItem:n,startTime:o,minTime:o+gn(t.workflow.minDelayMs,1e3),maxTime:o+gn(t.workflow.maxDelayMs,5e3),orchestrationMode:a},c=t.workflow.kind===ca.Join?n.contextId:s.scopeItem.parentPath.concat(n.id).join("\\");if(this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(t.workflow.id,new Map),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).get(c)){const a=new V({resultDescription:`Duplicated pending scope execution for ${t.workflow.id} at ${c}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(r=null==n?void 0:n.contextId)&&void 0!==r?r:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();ae.info(509727899,ge.CoreDefault,a.stop())}else{const a=new V({resultDescription:`New pending scope execution for ${t.workflow.id} at ${c}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(i=null==n?void 0:n.contextId)&&void 0!==i?i:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();ae.info(539883075,ge.CoreDefault,a.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).set(c,s)}this.ensureSweepTimer(e)}sweepScopeExecutionNotifications(){var e,t;const n=new Set(Array.from(this.sweepTimers.keys()));for(const[a,i]of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries()))for(const[r,o]of Array.from(i.entries())){const{session:i,workflowImplementation:{workflow:s},orchestrationMode:c}=o,d=i.getWorkflowItemStorage(),l=new V({operationName:"LocalScopeExecutionNotification",resourceId:s.id,joinContextId:null!==(t=null===(e=o.scopeItem)||void 0===e?void 0:e.contextId)&&void 0!==t?t:"",success:!0}).setClientMetadata(i.getClientMetadata()).start(),u=()=>{if(s.kind===ca.Join){const e=Date.now(),{workflow:t}=o.workflowImplementation,n=o.scopeItem.contextId,a=i.getWorkflowDefinition(t,n).maxDelayMs;return d.isWorkflowReady(n,t)?(l.resultDescription=`Join Workflow: ${t.id} queuing by maxAnnotation, contextId: ${n}`,ae.info(528048978,ge.CoreDefault,l.stop()),{isValid:!0,triggerReason:Lr.JoinMaxAnnnotation}):o.startTime+a<e?(l.resultDescription=`Join Workflow: ${t.id} queuing by maxTimeout, contextId: ${n}`,ae.info(528048979,ge.CoreDefault,l.stop()),{isValid:!0,triggerReason:Lr.JoinMaxTimeout}):this.isReadyToEarlyJoin(this.executionTrackersByWorkflowNameBySession.get(i).get(t.id),n,i.getClientMetadata())?(ae.info(512550856,ge.CoreDefault,`Workflow: ${t.id} queuing by early completion, contextId: ${n}, timeout: ${a}`),{isValid:!0,triggerReason:Lr.JoinEarlyCompletion}):{isValid:!1,triggerReason:Lr.Unknown}}return{isValid:!0,triggerReason:Lr.Unknown}};(()=>{const{isValid:e,triggerReason:t}=u();if(!e)return!1;const[n,a]=i.resolveRequestedContexts(s);if(!n)return!1;try{if(s.kind===ca.Join){const e=o.scopeItem.contextId,n=d.getScopeItem(e,s);if(n){const r=d.getItemsToExecute(n.contextId,s);if(0===r.length)return l.resultDescription=`Failed to retrieve items for workflow: ${s.id}, contextId: ${e}, skipping execution`,ae.info(527472291,ge.CoreDefault,l.stop()),this.onWorkflowExecuted(n,s,i),!0;this.queueWorkflow({workflowInfo:o.workflowImplementation,scopeItem:n,inputItems:r,requestedContexts:a,session:i,orchestrationMode:c,triggerReason:t,onCompleteCallback:this.onWorkflowExecuted.bind(this,n,s,i)}).catch(e=>{l.success=!1,l.resultDescription=e.message,ae.error(509092189,ge.CoreDefault,l.stop())})}else l.resultDescription="ContextId no longer exists, skipping workflow execution",ae.info(539883076,ge.CoreDefault,l.stop())}else l.resultDescription=`Workflow in type ${s.kind} is not supported`,ae.error(539883077,ge.CoreDefault,l.stop())}catch(e){l.resultDescription=`Trying to execute ${s.id} caused an exception: ${e}`,ae.warn(539883078,ge.CoreDefault,l.stop())}return!0})()?(this.pendingScopeExecutionNotificationsByWorkflow.get(a).delete(r),0===this.pendingScopeExecutionNotificationsByWorkflow.get(a).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(a)):n.delete(i)}if(0!==n.size)for(const e of Array.from(n)){const t=new V({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",success:!0}).start();ae.debug(539883079,ge.CoreDefault,t.stop()),this.cancelSweepTimer(e)}}onExternalWorkflowExecuted(e,t,n){const a={id:"",parentPath:[],contextId:e},i={id:t};this.onWorkflowExecuted(a,i,n,!1)}onWorkflowExecuted(e,t,n,a=!0){var i;null===(i=this.executionTrackersByWorkflowNameBySession.get(n).get(t.id))||void 0===i||i.afterWorkflowExecution(e.contextId),a&&t.kind===ca.Join&&n.getWorkflowItemStorage().onWorkflowExecuted(e,t)}}class Mr{constructor(e=500,t=!1){this.prevSeq=-1,this.bufferingTimeMs=e,this.rejectOutdatedSequenceNumbers=t}sequence(e){return new Promise((t,n)=>{if(e<this.prevSeq){if(this.rejectOutdatedSequenceNumbers){const t=new Error(`BufferingSequencer: Item out of order. Expecting seqId > ${this.prevSeq}. Actual seqId ${e}`);return t.name=Mr.Rejected,void n(t)}this.prevSeq=-1}e!=this.prevSeq+1&&ae.warn(542712385,ge.CoreDefault,`BufferingSequencer: got out of order sequence number. Got ${e}, expected ${this.prevSeq+1}`);const a={seq:e,resolve:t};this.insertItem(a),this.runInOrder(a,!0,!1)})}insertItem(e){if(!this.firstQueueItem)return this.firstQueueItem=e,void(this.lastQueueItem=e);let t=this.lastQueueItem,n=null;do{if(e.seq>t.seq)return e.prev=t,t.next=e,void(n?(n.prev=e,e.next=n):this.lastQueueItem=e);n=t,t=t.prev}while(t);n&&(n.prev=e),e.next=n,this.firstQueueItem=e}runInOrder(e,t,n){let a=this.prevSeq,i=!1;const r=[];for(;this.firstQueueItem;){const t=this.firstQueueItem;if(a+1!=t.seq&&(!n||t.seq>e.seq))break;a=t.seq,t.timeout&&clearTimeout(t.timeout),r.push(t),e==t&&(i=!0),this.firstQueueItem=this.firstQueueItem.next,this.firstQueueItem&&(this.firstQueueItem.prev=null)}r.length>0&&setTimeout(()=>{for(const e of r)e.resolve(e.seq)},0),this.prevSeq=a,!i&&t&&(e.timeout=setTimeout(()=>{this.runInOrder(e,!1,!0)},this.bufferingTimeMs))}}Mr.Rejected="SequenceItemRejected";class Pr{constructor(e=500){this.bufferingTimeMs=500,this.workflowIdToSequencersMap=new Map,this.bufferingTimeMs=e}create(e){if(!e.ownerId)return null;let t=this.workflowIdToSequencersMap.get(e.ownerId);return t||(t=new Mr(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(e.ownerId,t)),t}}class Tr{constructor(e=500,t){this.sequencerFactory=null!=t?t:new Pr(e)}sequence(e){var t,n,a,i;return n=this,void 0,i=function*(){if(null==(null===(t=null==e?void 0:e.M_)||void 0===t?void 0:t.seq))return;const n=this.sequencerFactory.create(e);n&&(yield n.sequence(e.M_.seq))},new((a=void 0)||(a=Promise))(function(e,t){function r(e){try{s(i.next(e))}catch(e){t(e)}}function o(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof a?n:new a(function(e){e(n)})).then(r,o)}s((i=i.apply(n,[])).next())})}}class Ur{constructor(e){this.annotationSequencer=null!=e?e:new Tr}process(e,t,n,a){const i=[];for(const a of e.ops){const r=[];if(null==a?void 0:a.items)for(const e of a.items){const n=this.annotationSequencer.sequence(e.body).then(()=>{t(a,e)});r.push(n)}i.push(Promise.all(r).then(()=>{n(a,e.cv)}))}Promise.all(i).then(()=>a(e))}}class Fr{process(e,t,n,a){for(const a of e.ops){if(null==a?void 0:a.items)for(const e of a.items)t(a,e);n(a,e.cv)}a(e)}}class Hr{constructor(e,t,n){this.isOrderingEnabled=e,this.orderedAnnotationResultsProcessor=null!=t?t:new Ur,this.unorderedAnnotationResultsProcessor=null!=n?n:new Fr}process(e,t,n,a){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(e,t,n,a):this.unorderedAnnotationResultsProcessor.process(e,t,n,a)}}class Rr{constructor(e){this.hostCallbacks=e}isFeatureEnabled(e,t=!1,n="None"){return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled("Microsoft.Office.AugLoop."+e,n).catch(()=>Promise.resolve(t)):Promise.resolve(t)}isChangeGateEnabled(e){return this.hostCallbacks&&this.hostCallbacks.isChangeGateEnabled?this.hostCallbacks.isChangeGateEnabled(e):Promise.resolve(!1)}}class Nr{constructor(e,t,n){this.sessionsByDocSessionId=new Map,this.isDeltaGeneratorEnabled=!1,this.disableSyncDeltaSending=!1,this.hasBeenInitialized=!1,this.telemetryLogger=null,this.settings={annotationsOrderingEnabled:!0,deltaOperationsEnabled:!1,checkIdbByFeatures:!1,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0,onAnnotationsSubmittedEnabled:!1,httpFallbackEnabled:!1,reduceBatchOperationsEnabled:!1,batchMessagesEnabled:!1,dynamicRateControllerEnabled:!1,removeDuplicateFlights:!0,delayBeforeSocketClose:!0,annotationDoesNotExistOnService:!0},this.isDownloaderCompatible=()=>{if(this.settings.checkIdbByFeatures)return"undefined"!=typeof Array&&void 0!==Array.from&&"undefined"!=typeof URL&&void 0!==URL.createObjectURL;if("undefined"!=typeof navigator&&navigator.userAgent){const e=navigator.userAgent;return!(!e.indexOf||e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0)}return!1},this.workerFactory=e||(e=>e&&e===Qn.HttpFallback?new Vn:new ke);const a=this.createDefaultSessionManagerFactory();this.sessionManagerFactory=(...e)=>(null==t?void 0:t(...e))||a(...e),this.sessionFactory=n||(e=>new Wi(e))}init(e,t,n,a){var i,r,o,s,d,l,u,f,p;const m=new V({operationName:"InitRuntime",resourceId:we(e),dimension1:this.hasBeenInitialized.toString()});m.start(),this.hasBeenInitialized=!0,this.hostCallbacks=n,this.gateUtils=new Rr(this.hostCallbacks),this.clientMetadata=t,this.clientMetadata&&(this.clientMetadata.runtimeVersion=c(246).r),this.telemetryLogger=new Ee(this.hostCallbacks),this.shouldAddLogger(m)?(ae.addLogger(this.telemetryLogger),this.addLoggingAggregator(a)):(ae.clearLoggers(),ae.addLogger(this.telemetryLogger)),Nr.haveCalledInit=!0,this.annotationResultsProcessor=new Hr(()=>this.settings.annotationsOrderingEnabled),this.inferenceServiceFactory=a.inferenceServiceFactory,m.dimension2=de(F.info).toString();const _=[];e&&(this.defaultServiceUrl=hn.convertServiceUrlToWebSocket(e),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase()),_.push(this.isFeatureEnabled("CheckIdbByFeatures",!1).then(e=>{this.settings.checkIdbByFeatures=e})),_.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!0).then(e=>{this.settings.annotationsOrderingEnabled=e})),_.push(this.isFeatureEnabled("DefaultBatchingDisabled").then(e=>{var t;(t=this.settings).defaultBatchingEnabled&&(t.defaultBatchingEnabled=!e)})),_.push(this.isFeatureEnabled("HttpFallbackEnabled").then(e=>{var t;(t=this.settings).httpFallbackEnabled||(t.httpFallbackEnabled=e)})),_.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then(e=>{var t;(t=this.settings).batchingWith20msIntervalEnabled&&(t.batchingWith20msIntervalEnabled=!e)})),_.push(this.isFeatureEnabled("OnAnnotationsSubmittedDisabled").then(e=>{var t;(t=this.settings).onAnnotationsSubmittedEnabled&&(t.onAnnotationsSubmittedEnabled=!e)})),_.push(this.isFeatureEnabled("ReduceBatchOperationsEnabled").then(e=>{var t;(t=this.settings).reduceBatchOperationsEnabled||(t.reduceBatchOperationsEnabled=e)})),_.push(this.isFeatureEnabled("BatchMessagesEnabled").then(e=>{var t;(t=this.settings).batchMessagesEnabled||(t.batchMessagesEnabled=e)})),_.push(this.isFeatureEnabled("DynamicRateControllerEnabled").then(e=>{this.settings.dynamicRateControllerEnabled=e})),_.push(hn.isChangeGateEnabled(this.hostCallbacks,"DelayBeforeSocketClose").then(e=>{this.settings.delayBeforeSocketClose=e})),_.push(hn.isChangeGateEnabled(this.hostCallbacks,"AnnotationDoesNotExistOnService").then(e=>{this.settings.annotationDoesNotExistOnService=e}));const h={enableDeltas:!1,enableEarlyJoin:!1};_.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then(e=>h.enableDeltas=e).catch(()=>h.enableDeltas=!1),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(e=>h.enableEarlyJoin=e).catch(()=>h.enableEarlyJoin=!1)]).then(()=>{this.localWorkflowManager=new kr(a.modelDownloader&&this.isDownloaderCompatible()?a.modelDownloader:void 0,this.inferenceServiceFactory,h)}));const b=Or(null!==(i=t.flights)&&void 0!==i?i:"");var g;return this.isDeltaGeneratorEnabled=b.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",null!==(r=a.isDeltaGeneratorEnabled)&&void 0!==r&&r),this.disableSyncDeltaSending=b.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",null!==(o=a.disableSyncDeltaSending)&&void 0!==o&&o),this.syncDeltaTimeout=b.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",a.syncDeltaTimeout),(s=this.settings).httpFallbackEnabled||(s.httpFallbackEnabled=b.getBooleanValue("HttpFallbackEnabled",!1)),(d=this.settings).defaultBatchingEnabled&&(d.defaultBatchingEnabled=!b.getBooleanValue("DefaultBatchingDisabled",!1)),(l=this.settings).batchingWith20msIntervalEnabled&&(l.batchingWith20msIntervalEnabled=!b.getBooleanValue("BatchingWith20msIntervalDisabled",!1)),(u=this.settings).reduceBatchOperationsEnabled||(u.reduceBatchOperationsEnabled=b.getBooleanValue("ReduceBatchOperationsEnabled",!1)),(f=this.settings).batchMessagesEnabled||(f.batchMessagesEnabled=b.getBooleanValue("BatchMessagesEnabled",!1)),(p=this.settings).removeDuplicateFlights&&(p.removeDuplicateFlights=b.getBooleanValue("RemoveDuplicateFlights",!0)),m.setDataField("Flights",JSON.stringify(this.settings)),a&&a.loggableUrls&&(g=a.loggableUrls,Ce.push(...g)),Promise.all(_).then(()=>{this.batchOptions=a.batchOptions,!this.batchOptions&&this.settings.defaultBatchingEnabled&&(this.batchOptions={delayMs:1,maxInputSize:1e6,delayMsMax:50},this.settings.batchingWith20msIntervalEnabled&&(this.batchOptions.delayMs=20)),this.batchOptions&&!this.batchOptions.delayMsMax&&(this.batchOptions.delayMsMax=50),a&&a.networkMode&&(a.networkMode===Qn.HttpFallback&&(a.networkMode=this.settings.httpFallbackEnabled?Qn.HttpFallback:Qn.JSWebSockets),this.networkMode=a.networkMode,a.networkMode===Qn.LocalWorkflowsOnly&&(this.sessionManagerFactory=()=>new Bi)),m.dimension0=JSON.stringify(this.batchOptions),this.logOperation(m,!0)}).catch(e=>{this.logOperation(m,!1,"Error",e?e.message:"(no error)")})}getServiceProtocol(){return this.serviceProtocol}registerLocalWorkflow(e){this.localWorkflowManager.registerLocalWorkflow(e)}flushTelemetry(e){ae.flushAggregators(e)}createSession(e){var t;const n=e&&e.docSessionId?e.docSessionId:w(),a=e&&e.documentId?e.documentId:void 0,i=this.sessionsByDocSessionId.get(n),r=new V({operationName:"CreateSession",resourceId:n,dimension1:this.hasBeenInitialized.toString()});if(r.start(),i&&!1===i.isClosed)throw this.logOperation(r,!1,"Error","docSessionId already exists"),new Error("docSessionId already exists");let o=e&&null!==(t=e.serviceUrl)&&void 0!==t?t:this.defaultServiceUrl;o=hn.convertServiceUrlToWebSocket(o),o||((e=e||{}).networkMode=Qn.LocalWorkflowsOnly),!this.networkMode||void 0!==(null==e?void 0:e.networkMode)&&null!==(null==e?void 0:e.networkMode)||((e=e||{}).networkMode=this.networkMode),void 0!==(null==e?void 0:e.networkMode)&&null!==(null==e?void 0:e.networkMode)&&(null==e?void 0:e.networkMode)!==Qn.JSWebSockets||!this.hasHttpFallbackSession()||((e=e||{}).networkMode=Qn.HttpFallback),e&&e.networkMode===Qn.HttpFallback&&(e.networkMode=this.settings.httpFallbackEnabled?Qn.HttpFallback:Qn.JSWebSockets);const s=Object.assign({},this.clientMetadata);s.docSessionId=n,a&&(s.documentId=a),e&&e.flights&&(s.flights=s.flights?s.flights+";"+e.flights:e.flights),this.settings.removeDuplicateFlights&&s.flights&&(s.flights=function(e){if(!e)return"";const t=new Set,n=[];for(const a of e.split(";").reverse()){const e=a.split(":")[0],i=wr.normalizeName(e);t.has(i)||(t.add(i),n.push(a))}return n.reverse().join(";")}(s.flights)),r.setDataField("Flights",s.flights||"");const c=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(s,o,e),batchOptions:this.batchOptions,extensionConfigs:(null==e?void 0:e.extensionConfigs)||[],clientMetadata:s,userContext:e?e.userContext:void 0,localWorkflowManager:e&&e.enableComplexLocalWorkflows?void 0:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,localRegisteredWorkflows:(null==e?void 0:e.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(null==e?void 0:e.enableRemoteExecutionNotification)||!1,networkMode:null==e?void 0:e.networkMode,egress:e?e.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,onAnnotationsSubmittedEnabled:this.settings.onAnnotationsSubmittedEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout,reduceBatchOperationsEnabled:this.settings.reduceBatchOperationsEnabled,batchMessagesEnabled:this.settings.batchMessagesEnabled,annotationDoesNotExistOnServiceEnabled:this.settings.annotationDoesNotExistOnService});return this.sessionsByDocSessionId.set(n,c),e&&e.onSessionConnect&&c.setConnectCallback(e.onSessionConnect),e&&e.onSessionDisconnect&&c.setDisconnectCallback(e.onSessionDisconnect),e&&e.onSessionReconnect&&c.setReconnectCallback(e.onSessionReconnect),e&&e.onSessionClose&&c.setSessionCloseCallback(e.onSessionClose),e&&e.onServerAuthenticationStateChangeCallback&&c.setServerAuthenticationStateChangeCallback(e.onServerAuthenticationStateChangeCallback),e&&e.onClaimsChallengeCallback&&c.setClaimsChallengeCallback(e.onClaimsChallengeCallback),this.logOperation(r,!0),c.initialize?c.initialize():Promise.resolve(c)}getSessionManagerFactory(){return this.sessionManagerFactory}shouldAddLogger(e){if(Nr.haveCalledInit){const t=new Error("Runtime already initialized");return e.dimension3=t.stack,e.dimension2=de(F.info).toString(),this.logOperation(e,!1,"Error",t.message),!1}return!0}createDefaultSessionManagerFactory(){return(e,t,n)=>{if(n&&n.enableComplexLocalWorkflows)throw new Error("NYI");if(n&&n.networkMode==Qn.LocalWorkflowsOnly)return new Bi;const a=new Xi,i=new qi;let r=()=>{ae.error(573321615,ge.CoreDefault,"Unexpectedly not set sendMessage")};const o=new Zi(()=>i,e,a,(e,t,n)=>{r(e,t,n)},{requestAuthToken:this.hostCallbacks.requestAuthToken,overrideSessionInitMessage:this.hostCallbacks.overrideSessionInitMessage,enableRemoteExecutionNotification:(null==n?void 0:n.enableRemoteExecutionNotification)||!1}),s=new Ua(hn.convertServiceUrlToWebSocket(t),i,this.workerFactory,o,e,a,this.settings,this.gateUtils,null==n?void 0:n.networkMode);return r=s.sendMessage.bind(s),s.on("disconnect",()=>a.clearRefreshTimeouts()),s.on("connect",(e,t,n,a)=>{e&&this.hostCallbacks.setSessionData&&this.hostCallbacks.setSessionData(t,n,a);const i=t.substring(t.lastIndexOf("/")+1);this.telemetryLogger.setServerSessionKey(i)}),s}}isFeatureEnabled(e,t=!1,n="None"){return hn.isFeatureEnabled(this.hostCallbacks,e,t,n)}hasHttpFallbackSession(){let e=!1;return this.sessionsByDocSessionId.forEach(t=>{t.isHttpFallback()&&(e=!0)}),e}logOperation(e,t,n,a){e.stop(),e.success=t,e.resultSignature=n,e.resultDescription=a,ae.info(573321622,ge.CoreDefault,e)}addLoggingAggregator(e){var t,n,a,i;hn.isChangeGateEnabled(this.hostCallbacks,"AggregateInProductionOnly")&&"Dogfood"===this.clientMetadata.releaseAudienceGroup||(ae.addAggregator(Oe("Operation","operationName",["ExecuteBatch","ReduceBatchOperations","ProcessResponse","LocalDeltaUpdate","ApplyFormattedTextTileDeltaForLocalWorkflows","ApplyTextTileDeltaForLocalWorkflows","FindRangeForDelta","RunModelForInferencing","GetResource","CreateTextTileDeltaFromItem","NetworkEgressControl","HttpEgress","LongPollNoOp","NetworkRateControllerAbandonedSyncMessage","NetworkRateControllerEgress","NetworkRateControllerQueueItem","NetworkRateControllerOnRateLimitResponse","NetworkRateControllerOnRateLimitError","NetworkRateControllerRateLimitsSet","NetworkRateControllerQueueItem"],null!==(t=e.telemetryAggregationIntervalSec)&&void 0!==t?t:30)),ae.addAggregator(Oe("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","EarlyJoinCompletion","OnLongPollMessage","OnAnnotationResultsEgress"],null!==(n=e.telemetryAggregationIntervalSec)&&void 0!==n?n:60)),ae.addAggregator(Oe("Operation","operationName",["LocalScopeExecutionNotification","RunLocalWorkflows","EarlyJoinCompletion","SetAnnotations","WIS.addItemOnContextIdList","WIS.setScopeItem"],null!==(a=e.telemetryAggregationIntervalSec)&&void 0!==a?a:120)),ae.addAggregator(Oe("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],null!==(i=e.telemetryAggregationIntervalSec)&&void 0!==i?i:60)))}uninitialize(){this.flushTelemetry(!0),this.hostCallbacks=null,this.hasBeenInitialized=!1,this.telemetryLogger=null,Nr.haveCalledInit=!1,ae.clearAggregators(),ae.clearLoggers()}}new Nr;const Br=()=>new Nr;var jr=c(737),Vr=c(408);class zr{constructor(e){t.assign(zr,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ExampleGenerativeAi_SentimentAnalysis"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[zr.getTypeName()])}}zr.H_={T_:zr.getTypeName(),B_:zr.getBaseTypes()};class Gr{constructor(e){t.assign(Gr,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ExampleGenerativeAi_AnswerToQuestionAboutDocument"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Gr.getTypeName()])}}Gr.H_={T_:Gr.getTypeName(),B_:Gr.getBaseTypes()};class Kr{constructor(e){t.assign(Kr,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ExampleGenerativeAi_AnswerToQuestion"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Kr.getTypeName()])}}Kr.H_={T_:Kr.getTypeName(),B_:Kr.getBaseTypes()};class Wr{constructor(e){t.assign(Wr,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ExampleGenerativeAi_RaiAnswerToQuestion"}static getBaseTypes(){return["AugLoop_ExampleGenerativeAi_AnswerToQuestion","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Wr.getTypeName()])}}Wr.H_={T_:Wr.getTypeName(),B_:Wr.getBaseTypes()};class qr{constructor(e){t.assign(qr,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ExampleGenerativeAi_StreamedAnswerToQuestion"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[qr.getTypeName()])}}qr.H_={T_:qr.getTypeName(),B_:qr.getBaseTypes()};class Qr{constructor(e){t.assign(Qr,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ExampleGenerativeAi_MostRelevantTile"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Qr.getTypeName()])}}Qr.H_={T_:Qr.getTypeName(),B_:Qr.getBaseTypes()};class Yr{constructor(e){t.assign(Yr,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_ExampleGenerativeAi_DalleImageResponse"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Yr.getTypeName()])}}Yr.H_={T_:Yr.getTypeName(),B_:Yr.getBaseTypes()};var Jr,Xr,Zr,$r=function(){function e(n){t.assign(e,this,n)}return Object.defineProperty(e.prototype,"metadata",{get:function(){return this.M_},set:function(e){this.M_=e},enumerable:!1,configurable:!0}),e.getTypeName=function(){return"AugLoop_TextToIcon_TextToIconAnnotation"},e.getBaseTypes=function(){return["AugLoop_Core_Annotation"]},e.typeGuard=function(n){return t.matchesTypesFor(n,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}(),eo=function(){function e(n){t.assign(e,this,n)}return Object.defineProperty(e.prototype,"metadata",{get:function(){return this.M_},set:function(e){this.M_=e},enumerable:!1,configurable:!0}),e.getTypeName=function(){return"AugLoop_AzureKeyPhrases_AzureKeyPhraseAnnotation"},e.getBaseTypes=function(){return["AugLoop_Core_Annotation"]},e.typeGuard=function(n){return t.matchesTypesFor(n,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}();!function(e){e[e.Success=0]="Success",e[e.NoResults=1]="NoResults",e[e.Cancelled=2]="Cancelled",e[e.Timeout=3]="Timeout",e[e.UnexpectedError=4]="UnexpectedError",e[e.InvalidInputError=5]="InvalidInputError",e[e.SubstrateResponseError=6]="SubstrateResponseError"}(Jr||(Jr={})),function(){function e(n){t.assign(e,this,n)}e.typeGuard=function(n){return t.matchesTypesFor(n,[e.getTypeName()])},e.getTypeName=function(){return"AugLoop_LayoutAnalysis_LayoutAnalysisRequest"},e.getBaseTypes=function(){return["AugLoop_Signals_Signal"]},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}}();class to{constructor(e){t.assign(to,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_Hubble_BaseContentAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[to.getTypeName()])}}to.H_={T_:to.getTypeName(),B_:to.getBaseTypes()};class no{constructor(e){t.assign(no,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_Hubble_ContentDownloadAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[no.getTypeName()])}}no.H_={T_:no.getTypeName(),B_:no.getBaseTypes()};class ao{constructor(e){t.assign(ao,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_Hubble_ContentAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[ao.getTypeName()])}}ao.H_={T_:ao.getTypeName(),B_:ao.getBaseTypes()};class io{constructor(e){t.assign(io,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_Hubble_ProviderContentAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_ContentAnnotation","AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[io.getTypeName()])}}io.H_={T_:io.getTypeName(),B_:io.getBaseTypes()};class ro{constructor(e){t.assign(ro,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_Hubble_AggregateContentAnnotation"}static getBaseTypes(){return["AugLoop_Hubble_ContentAnnotation","AugLoop_Hubble_BaseContentAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[ro.getTypeName()])}}ro.H_={T_:ro.getTypeName(),B_:ro.getBaseTypes()};var oo="prod",so="https://augloop.svc.cloud.microsoft",co=((Xr={}).spdf="https://dogfood.augloop.svc.cloud.microsoft",Xr.prodbubble="https://msit.augloop.svc.cloud.microsoft",Xr.prod=so,Xr.dprod=so,Xr.gcc="https://gcc.augloop.svc.cloud.microsoft",Xr.gcch="https://augloop.gov.online.office365.us",Xr.dod="https://augloop.dod.online.office365.us",Xr.ag08="https://svc.augloop.eaglex.ic.gov",Xr.ag09="https://svc.augloop.microsoft.scloud",Xr.chn="https://augloop.microsoftonline.cn",Xr),lo=((Zr={}).spdf="Dogfood",Zr.prodbubble="Microsoft",Zr.prod="Production",Zr.dprod="Production",Zr.gcc="GCC Moderate",Zr.gcch="GCC High",Zr.dod="DoD",Zr.ag08="AG08",Zr.ag09="AG09",Zr.chn="CN",Zr);function uo(){var e,t=new URLSearchParams((null===(e=window.location)||void 0===e?void 0:e.search)||"").get("alTest")||void 0;if(t)try{return new URL(t),t}catch(e){return"https://test.augloop.svc.cloud.dev.microsoft"}}var fo,po=function(){function t(e){this._params=e}return t.prototype.tryCreateSession=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){return(0,e.__generator)(this,function(e){switch(e.label){case 0:return[4,this._getAugloopClient()];case 1:return[4,e.sent().createSession(t)];case 2:return[2,e.sent()]}})})},t.prototype.dispose=function(){this._augloopRuntime&&this._augloopRuntime.flushTelemetry(!0)},t.prototype._getAugloopClient=function(){return(0,e.__awaiter)(this,void 0,void 0,function(){var t;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return this._augloopRuntime?[3,2]:(t=this,[4,this._createAugloopClient()]);case 1:t._augloopRuntime=e.sent(),e.label=2;case 2:return[2,this._augloopRuntime]}})})},t.prototype._createAugloopClient=function(){return(0,e.__awaiter)(this,void 0,void 0,function(){var t,n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return this._augloopRuntime=Br(),i=this._params.env,t=i?lo[i]:"",n={appName:this._params.metadata.appName,appPlatform:"Web",flights:this._params.metadata.flights,releaseAudienceGroup:t,sessionId:"alproxy_".concat(this._params.metadata.aadSessionId),uiLanguage:this._params.metadata.uiLanguage},a=function(e,t){var n,a;if(void 0===t&&(t=!1),null===(n=window.sessionStorage)||void 0===n?void 0:n.getItem("_isRunningTABTest")){var i=uo();if(i)return i}return"spdf"===e&&t&&(a=uo()),a||(a=co[null!=e?e:oo]),a}(this._params.env,this._params.useAugloopTestUrl),[4,this._augloopRuntime.init(a,n,this._params.hostCallbacks,{telemetryAggregationIntervalSec:100})];case 1:return e.sent(),[2,this._augloopRuntime]}var i})})},t}();(function(){function e(n){t.assign(e,this,n)}e.getTypeName=function(){return"AugLoop_SharepointCopilot_SharepointCopilotRequest"},e.getBaseTypes=function(){return["AugLoop_Signals_Signal"]},e.typeGuard=function(n){return t.matchesTypesFor(n,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}})(),function(){function e(n){t.assign(e,this,n)}e.typeGuard=function(n){return t.matchesTypesFor(n,[e.getTypeName()])},e.getTypeName=function(){return"AugLoop_SharepointCopilot_SharepointCopilotAnswer"},e.getBaseTypes=function(){return["AugLoop_Signals_Signal"]},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}}(),function(e){e["FileHandler.getAnswerForFile"]="FileHandler.getAnswerForFile"}(fo||(fo={}));class mo{constructor(e){mo.assign(mo,this,e)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFor(e){return e&&e.H_?e.H_.T_:void 0}static getBaseTypesFor(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}static getAllTypesFor(e){const t=mo.getTypeNameFor(e);return t?[t,...mo.getBaseTypesFor(e)]:[]}static matchesTypesFor(e,t){if(!Array.isArray(t)||0===t.length)return!0;const n=mo.getTypeNameFor(e),a=mo.getBaseTypesFor(e);for(const e of t){if(e===n)return!0;if(a.indexOf(e)>=0)return!0}return!1}static assign(e,t,n){if(n)for(const e of Object.keys(n))t[e]=n[e];return t.H_=e.H_,t}}mo.H_={T_:mo.getTypeName(),B_:mo.getBaseTypes()};class _o{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){mo.assign(_o,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointCopilotAnswer"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return mo.matchesTypesFor(e,[_o.getTypeName()])}}_o.H_={T_:_o.getTypeName(),B_:_o.getBaseTypes()};class ho{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){mo.assign(ho,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SharePointCopilotPanelAnswer"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return mo.matchesTypesFor(e,[ho.getTypeName()])}}ho.H_={T_:ho.getTypeName(),B_:ho.getBaseTypes()};class bo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){mo.assign(bo,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointListCopilotAnswer"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return mo.matchesTypesFor(e,[bo.getTypeName()])}}bo.H_={T_:bo.getTypeName(),B_:bo.getBaseTypes()};class go{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){mo.assign(go,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SharePointCopilotOdslAnnotation"}static getBaseTypes(){return["AugLoop_CopilotOdsl_CopilotOdslAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return mo.matchesTypesFor(e,[go.getTypeName()])}}go.H_={T_:go.getTypeName(),B_:go.getBaseTypes()};class vo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){mo.assign(vo,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_PageAuthoringCopilotAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return mo.matchesTypesFor(e,[vo.getTypeName()])}}vo.H_={T_:vo.getTypeName(),B_:vo.getBaseTypes()};class yo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){mo.assign(yo,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_CommonAuthoringPartialAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return mo.matchesTypesFor(e,[yo.getTypeName()])}}yo.H_={T_:yo.getTypeName(),B_:yo.getBaseTypes()};class So{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){mo.assign(So,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_CommonAuthoringAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return mo.matchesTypesFor(e,[So.getTypeName()])}}So.H_={T_:So.getTypeName(),B_:So.getBaseTypes()};class Do{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Do,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotOutputAnnotation"}static getBaseTypes(){return["AugLoop_Copilot_CopilotOutputAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Do.getTypeName()])}}Do.H_={T_:Do.getTypeName(),B_:Do.getBaseTypes()};class Io{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Io,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCortexIndexingAnnotation"}static getBaseTypes(){return["AugLoop_Copilot_CopilotOutputAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Io.getTypeName()])}}Io.H_={T_:Io.getTypeName(),B_:Io.getBaseTypes()};class xo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(xo,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotChatHistoryAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[xo.getTypeName()])}}xo.H_={T_:xo.getTypeName(),B_:xo.getBaseTypes()};class Co{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Co,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotScopeContextAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Co.getTypeName()])}}Co.H_={T_:Co.getTypeName(),B_:Co.getBaseTypes()};class Oo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Oo,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCopilotFileContextAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Oo.getTypeName()])}}Oo.H_={T_:Oo.getTypeName(),B_:Oo.getBaseTypes()};class wo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(wo,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPCortexFileAnnotation"}static getBaseTypes(){return["AugLoop_OdspCopilot_ODSPCopilotFileContextAnnotation","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[wo.getTypeName()])}}wo.H_={T_:wo.getTypeName(),B_:wo.getBaseTypes()};class Eo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Eo,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPValidateGptAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Eo.getTypeName()])}}Eo.H_={T_:Eo.getTypeName(),B_:Eo.getBaseTypes()};class Ao{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Ao,this,e)}static getTypeName(){return"AugLoop_OdspCopilot_ODSPResearchGenerateContentResponseAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Ao.getTypeName()])}}function Lo(){return H._SPKillSwitch.isActivated("2ca46dd2-a9a8-4e1d-99c4-4ea3fad1a943")}function ko(){return H._SPKillSwitch.isActivated("3245a4fb-a739-42b9-aabe-d9deb962f041")}Ao.H_={T_:Ao.getTypeName(),B_:Ao.getBaseTypes()};var Mo,Po="https://augloop.svc.cloud.microsoft",To="https://augloop.office.com/v2",Uo=[Yr.getTypeName(),$r.getTypeName(),eo.getTypeName(),io.getTypeName(),vo.getTypeName(),"AugLoop_LayoutAnalysis_LayoutAnalysisAnnotation",Do.getTypeName()],Fo=R._LogSource.create("sp-augloop-component"),Ho={};function Ro(e){var t=e.env,n=e.aadSessionId,a=e.appNameOverride,i=null!=a?a:jo(),r=H._SPKillSwitch.isActivated("7c0ba7be-5de1-44ce-ab7d-ad6a50a0455c")?t:"".concat(t,".").concat(n,".").concat(i),o=Ho[r];return o||(o=new po({env:t,useAugloopTestUrl:H._SPFlight.isDebugFlightEnabled,metadata:{appName:i,aadSessionId:n},hostCallbacks:es()}),Ho[r]=o),o}function No(){if(H._SPFlight.isDebugFlightEnabled){var e=new URLSearchParams(window.location.search).get("alTest")||void 0;try{return new URL(e),e}catch(t){return e?"https://test.augloop.svc.cloud-dev.microsoft":void 0}}}var Bo=function(e,t){var n=function(e){var t="";if(e){var n=e.env2;"prodbubble"===n?t=Zo(e)?"Dogfood":"Microsoft":"prod"!==n&&"dprod"!==n||(t="Production")}return t}(e);return{appName:null!=t?t:jo(),appPlatform:"Web",clientVersion:Vr._Telemetry.buildNumber,releaseAudienceGroup:n,sessionId:"alproxy_".concat(e.aadSessionId)}};function jo(){return function(){if(H._SPFlight.isDebugFlightEnabled)return new URLSearchParams(window.location.search).get("alTestAppName")||void 0}()||"SharePoint"}function Vo(t,n,a,i,r){var o;return void 0===n&&(n=!0),void 0===a&&(a="dogfood"),(0,e.__awaiter)(this,void 0,void 0,function(){var s,c,d,l,u=this;return(0,e.__generator)(this,function(f){switch(f.label){case 0:s=new R._QosMonitor("AugloopSessionModule.initNewAugloopSession"),f.label=1;case 1:return f.trys.push([1,7,,8]),d={docSessionId:H.Guid.newGuid().toString(),flights:(0,e.__spreadArray)((0,e.__spreadArray)(["mc-editor-oa","mc-editor-oa-ecc-annotation","honeybee-al-smartCompose","mc-editor-oa-files-flag","mc-editor-oa-client-ecc-files","mc-editor-oa-flags","vivatopics","oaFluid","mc-editor-oa-vivatopics","mc-editor-oa-debug","csi-editor-topicsuggestions","scd-suggestions-toplevel","csi-editor-topicsuggestions","csi-editor-topicsuggestions-kserving"],H._SPKillSwitch.isActivated("b023eecd-a49a-4c26-84e3-959e80b63e01")?[]:["enableStopRespondingODSP:false","enableDataSourcesWithInputSignal:true","Microsoft.Office.Shared.Augloop.Copilot.UseAvalon:true"],!0),H._SPKillSwitch.isActivated("fad5aca9-d190-4a0b-bd77-32c18faf2eed")?[]:["disableSydneyGeneratedSuggestions:true"],!0).join(";"),onSessionConnect:function(t){return(0,e.__awaiter)(u,void 0,void 0,function(){var a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return t&&(i=c,r=new p({parentPath:["session"],items:[{id:"doc",body:new ar({isReadonly:!1})}]}),i.submitSeedOperations([r])),n?(a=Uo.map(function(e){return c.activateAnnotation(e)}),[4,Promise.all(a)]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}var i,r})})},documentId:$o(t,i)},H._SPKillSwitch.isActivated("05decb6a-7068-496e-aaaf-faf760625c8b")?[3,3]:[4,Ro({env:"prod"===a?oo:null!==(o=t.cloudType)&&void 0!==o?o:oo,aadSessionId:t.aadSessionId||"",appNameOverride:r}).tryCreateSession(d)];case 2:return c=f.sent(),[3,6];case 3:return[4,ts(t,a,r)];case 4:return[4,f.sent().createSession(d)];case 5:c=f.sent(),f.label=6;case 6:return s.writeSuccess(),[2,c];case 7:throw l=f.sent(),R._TraceLogger.logError(Fo,l,"Unable to init augloop session"),s.writeUnexpectedFailure("AugloopSessionModule.initNewAugloopSessionFailure",l),l;case 8:return[2]}})})}var zo,Go,Ko,Wo,qo,Qo,Yo,Jo,Xo,Zo=function(e){return"spdf"===e.cloudType};function $o(e,t){var n;if(t){var a=e.siteId,i=e.webId,r=e.listId;n=[a,i,r].map(function(e){return e.replace(/[{}]/g,"")}),a=n[0],i=n[1],r=n[2];var o=btoa(a+","+i+","+r).slice(0,-1);return"SPO_".concat(o,"_").concat(t)}}function es(){return{onAnnotationResult:function(e){R._TraceLogger.logVerbose(Fo,"Workflow annotation result","onAnnotationResult")},isFeatureEnabled:function(e,t){return Promise.resolve(!0)},onResult:function(){},executeLocalLambda:function(){return Promise.resolve()},areLicenseFeaturesEnabled:function(){return Promise.resolve(!1)},requestAuthToken:function(){return new Promise(function(e,t){var n,a;(a=new R._QosMonitor("AugloopSessionModule.AugLoopAuthCallback.GetToken"),jr._AadTokenProviders.configurable._getTokenInternal(H._SPKillSwitch.isActivated("5eaf8b7e-6971-454c-9688-543950eea15d")?To:(n=No(),n&&(n.includes("int")||n.includes("test"))?"https://augloop-int.officeppe.com/v2":To),jr._AadTokenProviders.preAuthorizedConfiguration).then(function(e){return a.writeSuccess(),e}).catch(function(e){throw R._TraceLogger.logError(Fo,e,"Unable to get augloop token"),a.writeUnexpectedFailure("AugloopSessionModule.AugLoopAuthCallback.GetTokenFailure",e),e})).then(function(t){e({Token:t})}).catch(function(e){R._TraceLogger.logError(Fo,e,"Unable to get augloop token"),t(e)})})},sendTelemetryEvent:function(){}}}function ts(t,n,a){return void 0===n&&(n="dogfood"),(0,e.__awaiter)(this,void 0,void 0,function(){var i,r,o;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return Mo&&"prod"!==n?[2,Mo]:(Mo=Br(),i=Bo(t,a),r=es(),o=function(e,t){return void 0===t&&(t="dogfood"),"prod"===t?Po:No()||(Zo(e)?"https://dogfood.augloop.svc.cloud.microsoft":Po)}(t,n),[4,Mo.init(o,i,r,{telemetryAggregationIntervalSec:100})]);case 1:return e.sent(),[2,Mo]}})})}class ns{constructor(e){t.assign(ns,this,e)}static getTypeName(){return"AugLoop_BasicChat_BasicChat"}static getBaseTypes(){return["AugLoop_Chat_Chat"]}static typeGuard(e){return t.matchesTypesFor(e,[ns.getTypeName()])}}ns.H_={T_:ns.getTypeName(),B_:ns.getBaseTypes()};class as{constructor(e){t.assign(as,this,e)}get metadata(){return this.M_}set metadata(e){this.M_=e}static getTypeName(){return"AugLoop_BasicChat_BasicChatResponse"}static getBaseTypes(){return["AugLoop_GenerativeAi_TextChatResponse","AugLoop_Chat_ChatResponse","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[as.getTypeName()])}}as.H_={T_:as.getTypeName(),B_:as.getBaseTypes()};class is{constructor(e){t.assign(is,this,e)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(e){return t.matchesTypesFor(e,[is.getTypeName()])}}is.H_={T_:is.getTypeName(),B_:is.getBaseTypes()};class rs{constructor(e){t.assign(rs,this,e)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(e){return t.matchesTypesFor(e,[rs.getTypeName()])}}rs.H_={T_:rs.getTypeName(),B_:rs.getBaseTypes()};class os{constructor(e){t.assign(os,this,e)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiEmbeddingsModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(e){return t.matchesTypesFor(e,[os.getTypeName()])}}os.H_={T_:os.getTypeName(),B_:os.getBaseTypes()};class ss{constructor(e){t.assign(ss,this,e)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiTextModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(e){return t.matchesTypesFor(e,[ss.getTypeName()])}}ss.H_={T_:ss.getTypeName(),B_:ss.getBaseTypes()};class cs{constructor(e){t.assign(cs,this,e)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiMultiModalityModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(e){return t.matchesTypesFor(e,[cs.getTypeName()])}}cs.H_={T_:cs.getTypeName(),B_:cs.getBaseTypes()};class ds{constructor(e){t.assign(ds,this,e)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiChatModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(e){return t.matchesTypesFor(e,[ds.getTypeName()])}}ds.H_={T_:ds.getTypeName(),B_:ds.getBaseTypes()};class ls{constructor(e){t.assign(ls,this,e)}static getTypeName(){return"AugLoop_GenerativeAi_OpenAiMultiModalityChatModelConfig"}static getBaseTypes(){return["AugLoop_GenerativeAi_OpenAiModelWithParametersConfigBase","AugLoop_GenerativeAi_OpenAiModelConfig","AugLoop_GenerativeAi_ModelConfig"]}static typeGuard(e){return t.matchesTypesFor(e,[ls.getTypeName()])}}ls.H_={T_:ls.getTypeName(),B_:ls.getBaseTypes()},function(e){e[e.TextChatDavinci002=0]="TextChatDavinci002",e[e.TextDavinci001=1]="TextDavinci001",e[e.TextDavinci002=2]="TextDavinci002",e[e.TextDavinci003=3]="TextDavinci003",e[e.TextCurie001=4]="TextCurie001",e[e.TextBabbage001=5]="TextBabbage001",e[e.TextAda001=6]="TextAda001",e[e.CodeDavinci002=7]="CodeDavinci002",e[e.CodeCushman001=8]="CodeCushman001",e[e.Custom=9]="Custom",e[e.TextSimilarityAda001=10]="TextSimilarityAda001",e[e.TextSimilarityBabbage001=11]="TextSimilarityBabbage001",e[e.TextSimilarityCurie001=12]="TextSimilarityCurie001",e[e.TextSimilarityDavinci001=13]="TextSimilarityDavinci001",e[e.TextSearchAdaDoc001=14]="TextSearchAdaDoc001",e[e.TextSearchAdaQuery001=15]="TextSearchAdaQuery001",e[e.TextSearchBabbageDoc001=16]="TextSearchBabbageDoc001",e[e.TextSearchBabbageQuery001=17]="TextSearchBabbageQuery001",e[e.TextSearchCurieDoc001=18]="TextSearchCurieDoc001",e[e.TextSearchCurieQuery001=19]="TextSearchCurieQuery001",e[e.TextSearchDavinciDoc001=20]="TextSearchDavinciDoc001",e[e.TextSearchDavinciQuery001=21]="TextSearchDavinciQuery001",e[e.CodeSearchAdaCode001=22]="CodeSearchAdaCode001",e[e.CodeSearchAdaText001=23]="CodeSearchAdaText001",e[e.CodeSearchBabbageCode001=24]="CodeSearchBabbageCode001",e[e.CodeSearchBabbageText001=25]="CodeSearchBabbageText001",e[e.TextEmbeddingAda002=26]="TextEmbeddingAda002",e[e.Gpt35Turbo=27]="Gpt35Turbo",e[e.Gpt4_32k=28]="Gpt4_32k",e[e.Gpt4_0203=29]="Gpt4_0203",e[e.Gpt4_0314_4k=30]="Gpt4_0314_4k",e[e.Gpt4_0314_32k=31]="Gpt4_0314_32k",e[e.Gpt4_DV3_FP_Variant=32]="Gpt4_DV3_FP_Variant",e[e.Gpt4_DV3_FP=33]="Gpt4_DV3_FP",e[e.Gpt4_PPO_FP_Variant=34]="Gpt4_PPO_FP_Variant",e[e.Gpt4_PPO_FP=35]="Gpt4_PPO_FP",e[e.GptV=36]="GptV",e[e.Gpt35Turbo16k=37]="Gpt35Turbo16k",e[e.Gpt35TurboInstruct=38]="Gpt35TurboInstruct",e[e.Gpt4Turbo=39]="Gpt4Turbo",e[e.Gpt4=40]="Gpt4",e[e.Gpt4Turbo_0125=41]="Gpt4Turbo_0125",e[e.Gpt35Turbo_1106=42]="Gpt35Turbo_1106",e[e.Gpt35Turbo_0125=43]="Gpt35Turbo_0125",e[e.Gpt35Turbo_Deucalion=44]="Gpt35Turbo_Deucalion",e[e.Gpt4_0613=45]="Gpt4_0613",e[e.TextEmbedding3Small=46]="TextEmbedding3Small",e[e.TextEmbedding3Large=47]="TextEmbedding3Large",e[e.Gpt35Turbo_0613_EditorFineTuned_Japanese=48]="Gpt35Turbo_0613_EditorFineTuned_Japanese",e[e.TextEmbeddingAda002_Substrate=49]="TextEmbeddingAda002_Substrate",e[e.Gpt35Turbo_0125_AOAI=50]="Gpt35Turbo_0125_AOAI",e[e.Gpt4Turbo_0409=51]="Gpt4Turbo_0409",e[e.Gpt4o_0513=52]="Gpt4o_0513",e[e.Gpt4o_AOAI=53]="Gpt4o_AOAI",e[e.Phi2=10001]="Phi2",e[e.Mixtral_8x7b_Instruct_V01=10002]="Mixtral_8x7b_Instruct_V01",e[e.Mistral_7b_Instruct_V02=10003]="Mistral_7b_Instruct_V02",e[e.Mistral_7b_v01=10004]="Mistral_7b_v01",e[e.Phi3Mini=10005]="Phi3Mini",e[e.Phi3Medium=10006]="Phi3Medium",e[e.Phi3Small=10007]="Phi3Small"}(zo||(zo={})),function(e){e[e.Success=0]="Success",e[e.OffensiveContentInput=1]="OffensiveContentInput",e[e.OffensiveContentOutput=2]="OffensiveContentOutput",e[e.EmptyResponse=3]="EmptyResponse",e[e.ErrorInExecution=4]="ErrorInExecution",e[e.ResourcesNotAvailable=5]="ResourcesNotAvailable",e[e.RaiUnsupportedLanguageInContentInput=6]="RaiUnsupportedLanguageInContentInput",e[e.RaiUnsupportedLanguageInContentOutput=7]="RaiUnsupportedLanguageInContentOutput",e[e.InputBlockedByDynamicGuardList=8]="InputBlockedByDynamicGuardList",e[e.OutputBlockedByDynamicGuardList=9]="OutputBlockedByDynamicGuardList",e[e.InputAttackDetected=10]="InputAttackDetected",e[e.OutputAttackDetected=11]="OutputAttackDetected",e[e.EnumValueNotInUse=12]="EnumValueNotInUse",e[e.PartialResult=13]="PartialResult",e[e.ModelContentFilter=14]="ModelContentFilter",e[e.Unknown=15]="Unknown",e[e.Overloaded=16]="Overloaded",e[e.Timeout=17]="Timeout",e[e.TooLargeRequest=18]="TooLargeRequest",e[e.BadRequest=19]="BadRequest",e[e.InternalServerError=20]="InternalServerError",e[e.UserNotAuthenticated=21]="UserNotAuthenticated",e[e.UserNotAuthorized=22]="UserNotAuthorized",e[e.UserThrottled=23]="UserThrottled",e[e.ScenarioThrottled=24]="ScenarioThrottled",e[e.InvalidFormatting=25]="InvalidFormatting",e[e.WorkflowQuotaLimitExceeded=26]="WorkflowQuotaLimitExceeded",e[e.UnsupportedRequirement=27]="UnsupportedRequirement",e[e.UrlPresentInInput=28]="UrlPresentInInput",e[e.DocumentUrlChangeDetected=29]="DocumentUrlChangeDetected",e[e.ExpectedError=30]="ExpectedError",e[e.BlockedByUserPrompt=31]="BlockedByUserPrompt",e[e.PromptDefinedError=32]="PromptDefinedError",e[e.FailedToGetFileContents=33]="FailedToGetFileContents"}(Go||(Go={})),function(e){e.text="text",e.image="image"}(Ko||(Ko={})),function(e){e.System="system",e.User="user",e.Assistant="assistant"}(Wo||(Wo={})),function(e){e.NotStarted="NotStarted",e.Running="Running",e.Succeeded="Succeeded"}(qo||(qo={}));class us{constructor(e){t.assign(us,this,e)}static getTypeName(){return"AugLoop_Chat_ChatsHolder"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return t.matchesTypesFor(e,[us.getTypeName()])}}us.H_={T_:us.getTypeName(),B_:us.getBaseTypes()};class fs{constructor(e){t.assign(fs,this,e)}static getTypeName(){return"AugLoop_Chat_Chat"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[fs.getTypeName()])}}fs.H_={T_:fs.getTypeName(),B_:fs.getBaseTypes()};class ps{constructor(e){t.assign(ps,this,e)}static getTypeName(){return"AugLoop_Chat_MessagesHolder"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return t.matchesTypesFor(e,[ps.getTypeName()])}}ps.H_={T_:ps.getTypeName(),B_:ps.getBaseTypes()};class ms{constructor(e){t.assign(ms,this,e)}static getTypeName(){return"AugLoop_Chat_ChatMessage"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[ms.getTypeName()])}}ms.H_={T_:ms.getTypeName(),B_:ms.getBaseTypes()};class _s{constructor(e){t.assign(_s,this,e)}static getTypeName(){return"AugLoop_Chat_TextChatMessage"}static getBaseTypes(){return["AugLoop_Chat_ChatMessage"]}static typeGuard(e){return t.matchesTypesFor(e,[_s.getTypeName()])}}_s.H_={T_:_s.getTypeName(),B_:_s.getBaseTypes()};class hs{constructor(e){t.assign(hs,this,e)}static getTypeName(){return"AugLoop_AzureKeyPhrases_AzureKeyPhraseRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[hs.getTypeName()])}}hs.H_={T_:hs.getTypeName(),B_:hs.getBaseTypes()};class bs{constructor(e){t.assign(bs,this,e)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_ExampleChat"}static getBaseTypes(){return["AugLoop_Chat_Chat"]}static typeGuard(e){return t.matchesTypesFor(e,[bs.getTypeName()])}}bs.H_={T_:bs.getTypeName(),B_:bs.getBaseTypes()};class gs{constructor(e){t.assign(gs,this,e)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_DocumentQuestionSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[gs.getTypeName()])}}gs.H_={T_:gs.getTypeName(),B_:gs.getBaseTypes()};class vs{constructor(e){t.assign(vs,this,e)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_FindMostRelevantTileSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[vs.getTypeName()])}}vs.H_={T_:vs.getTypeName(),B_:vs.getBaseTypes()};class ys{constructor(e){t.assign(ys,this,e)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_SentimentAnalysisSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[ys.getTypeName()])}}ys.H_={T_:ys.getTypeName(),B_:ys.getBaseTypes()};class Ss{constructor(e){t.assign(Ss,this,e)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_QuestionSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Ss.getTypeName()])}}Ss.H_={T_:Ss.getTypeName(),B_:Ss.getBaseTypes()};class Ds{constructor(e){t.assign(Ds,this,e)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_DalleImageRequest"}static getBaseTypes(){return[]}static typeGuard(e){return t.matchesTypesFor(e,[Ds.getTypeName()])}}Ds.H_={T_:Ds.getTypeName(),B_:Ds.getBaseTypes()};class Is{constructor(e){t.assign(Is,this,e)}static getTypeName(){return"AugLoop_ExampleGenerativeAi_MultiModalitySignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Is.getTypeName()])}}Is.H_={T_:Is.getTypeName(),B_:Is.getBaseTypes()},function(e){e.LoopingVideos="32318599-a475-448c-a583-7aadf5e41c8c",e.Icons="f9a6197b-243d-4381-ad7d-43250cb11014",e.Illustrations="5c594da3-1700-4c4e-824b-dbefe528f53b",e.CartoonPeople="71309e27-d6ab-4fa5-865c-60d4e6d863b3",e.Images="f8218404-63dd-4670-b0f5-f8b50674f963",e.AiGeneratedImages="60f8b9be-536b-4a0f-9552-f3321c243f86",e.CutoutPeople="42fea961-805e-4900-a0f5-7288c55d7780",e.Stickers="0678df82-d05e-475d-9c04-5daa1f5c6d55",e.Emojis="84e04d41-3574-4764-a2d3-c24ae80c75eb",e.Audios="72b42841-c22c-44fd-9ac3-964371503269"}(Qo||(Qo={})),function(e){e.Icon="Icon",e.Image="Image",e.Video="Video",e.Audio="Audio"}(Yo||(Yo={})),function(e){e.My="My",e.Stock="Stock",e.Enterprise="Enterprise",e.External="External"}(Jo||(Jo={})),function(e){e.Bing="Bing",e.Getty="Getty",e.GettyVideo="GettyVideo",e.Giphy="Giphy",e.GooglePhotos="GooglePhotos",e.Hubble="Hubble",e.OneDrivePhotos="OneDrivePhotos",e.Shutterstock="Shutterstock",e.Storyblocks="Storyblocks",e.TAS="TAS",e.Tenor="Tenor",e.Unknown="Unknown"}(Xo||(Xo={}));class xs{constructor(e){t.assign(xs,this,e)}static getTypeName(){return"AugLoop_Hubble_BaseContentSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[xs.getTypeName()])}}xs.H_={T_:xs.getTypeName(),B_:xs.getBaseTypes()};class Cs{constructor(e){t.assign(Cs,this,e)}static getTypeName(){return"AugLoop_Hubble_ContentSearchSignal"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentSignal","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Cs.getTypeName()])}}Cs.H_={T_:Cs.getTypeName(),B_:Cs.getBaseTypes()};class Os{constructor(e){t.assign(Os,this,e)}static getTypeName(){return"AugLoop_Hubble_ContentDownloadSignal"}static getBaseTypes(){return["AugLoop_Hubble_BaseContentSignal","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Os.getTypeName()])}}Os.H_={T_:Os.getTypeName(),B_:Os.getBaseTypes()};var ws=function(){function e(n){t.assign(e,this,n)}return e.getTypeName=function(){return"AugLoop_TextToIcon_TextToIconSignal"},e.getBaseTypes=function(){return["AugLoop_TextToSuggestions_TextToSuggestionSignal","AugLoop_Signals_Signal"]},e.typeGuard=function(n){return t.matchesTypesFor(n,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}();class Es{constructor(e){mo.assign(Es,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SharePointCopilotOdslSignal"}static getBaseTypes(){return["AugLoop_CopilotOdsl_CopilotOdslSignal","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Es.getTypeName()])}}Es.H_={T_:Es.getTypeName(),B_:Es.getBaseTypes()};class As{constructor(e){mo.assign(As,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_BaseAuthoringRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[As.getTypeName()])}}As.H_={T_:As.getTypeName(),B_:As.getBaseTypes()};class Ls{constructor(e){mo.assign(Ls,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SectionSubtopicRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Ls.getTypeName()])}}Ls.H_={T_:Ls.getTypeName(),B_:Ls.getBaseTypes()};class ks{constructor(e){mo.assign(ks,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_PageSkeletonRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[ks.getTypeName()])}}ks.H_={T_:ks.getTypeName(),B_:ks.getBaseTypes()};class Ms{constructor(e){mo.assign(Ms,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_PageOutlineRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Ms.getTypeName()])}}Ms.H_={T_:Ms.getTypeName(),B_:Ms.getBaseTypes()};class Ps{constructor(e){mo.assign(Ps,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_PageAuthoringRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Ps.getTypeName()])}}Ps.H_={T_:Ps.getTypeName(),B_:Ps.getBaseTypes()};class Ts{constructor(e){mo.assign(Ts,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_DraftComposeRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Ts.getTypeName()])}}Ts.H_={T_:Ts.getTypeName(),B_:Ts.getBaseTypes()};class Us{constructor(e){mo.assign(Us,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_WebPartsAuthoringRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Us.getTypeName()])}}Us.H_={T_:Us.getTypeName(),B_:Us.getBaseTypes()};class Fs{constructor(e){mo.assign(Fs,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_CommonAuthoringRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Fs.getTypeName()])}}Fs.H_={T_:Fs.getTypeName(),B_:Fs.getBaseTypes()};class Hs{constructor(e){mo.assign(Hs,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SourceExtractionRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseAuthoringRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Hs.getTypeName()])}}Hs.H_={T_:Hs.getTypeName(),B_:Hs.getBaseTypes()};class Rs{constructor(e){mo.assign(Rs,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_BaseDynamicFAQRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Rs.getTypeName()])}}Rs.H_={T_:Rs.getTypeName(),B_:Rs.getBaseTypes()};class Ns{constructor(e){mo.assign(Ns,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_DynamicFAQTopicSuggestionRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseDynamicFAQRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Ns.getTypeName()])}}Ns.H_={T_:Ns.getTypeName(),B_:Ns.getBaseTypes()};class Bs{constructor(e){mo.assign(Bs,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_DynamicFAQQuestionGenerationRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseDynamicFAQRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Bs.getTypeName()])}}Bs.H_={T_:Bs.getTypeName(),B_:Bs.getBaseTypes()};class js{constructor(e){mo.assign(js,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_DynamicFAQAnswerGenerationRequest"}static getBaseTypes(){return["AugLoop_SharepointCopilot_BaseDynamicFAQRequest","AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[js.getTypeName()])}}js.H_={T_:js.getTypeName(),B_:js.getBaseTypes()};class Vs{constructor(e){t.assign(Vs,this,e)}static getTypeName(){return"AugLoop_Translator_TranslatorSignalBase"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Vs.getTypeName()])}}Vs.H_={T_:Vs.getTypeName(),B_:Vs.getBaseTypes()};class zs{constructor(e){t.assign(zs,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateFileSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[zs.getTypeName()])}}zs.H_={T_:zs.getTypeName(),B_:zs.getBaseTypes()};class Gs{constructor(e){t.assign(Gs,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateChunkedFileChunk"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Gs.getTypeName()])}}Gs.H_={T_:Gs.getTypeName(),B_:Gs.getBaseTypes()};class Ks{constructor(e){t.assign(Ks,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateChunkedFileSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Ks.getTypeName()])}}Ks.H_={T_:Ks.getTypeName(),B_:Ks.getBaseTypes()};class Ws{constructor(e){t.assign(Ws,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateContentSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Ws.getTypeName()])}}Ws.H_={T_:Ws.getTypeName(),B_:Ws.getBaseTypes()};class qs{constructor(e){t.assign(qs,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateContentArraySignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[qs.getTypeName()])}}qs.H_={T_:qs.getTypeName(),B_:qs.getBaseTypes()};class Qs{constructor(e){t.assign(Qs,this,e)}static getTypeName(){return"AugLoop_Translator_DictionaryLookupSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Qs.getTypeName()])}}Qs.H_={T_:Qs.getTypeName(),B_:Qs.getBaseTypes()};class Ys{constructor(e){t.assign(Ys,this,e)}static getTypeName(){return"AugLoop_Translator_SupportedLanguagesSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Ys.getTypeName()])}}Ys.H_={T_:Ys.getTypeName(),B_:Ys.getBaseTypes()};class Js{constructor(e){t.assign(Js,this,e)}static getTypeName(){return"AugLoop_Translator_BreakSentencesSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Js.getTypeName()])}}Js.H_={T_:Js.getTypeName(),B_:Js.getBaseTypes()};class Xs{constructor(e){t.assign(Xs,this,e)}static getTypeName(){return"AugLoop_Translator_DictionaryExamplesSignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Xs.getTypeName()])}}Xs.H_={T_:Xs.getTypeName(),B_:Xs.getBaseTypes()};class Zs{constructor(e){t.assign(Zs,this,e)}static getTypeName(){return"AugLoop_Translator_DetectLanguagesArraySignal"}static getBaseTypes(){return["AugLoop_Translator_TranslatorSignalBase","AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Zs.getTypeName()])}}Zs.H_={T_:Zs.getTypeName(),B_:Zs.getBaseTypes()};class $s{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign($s,this,e)}static getTypeName(){return"AugLoop_Translator_TranslatorAnnotationBase"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[$s.getTypeName()])}}$s.H_={T_:$s.getTypeName(),B_:$s.getBaseTypes()};class ec{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(ec,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateContentResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[ec.getTypeName()])}}ec.H_={T_:ec.getTypeName(),B_:ec.getBaseTypes()};class tc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(tc,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateContentArrayResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[tc.getTypeName()])}}tc.H_={T_:tc.getTypeName(),B_:tc.getBaseTypes()};class nc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(nc,this,e)}static getTypeName(){return"AugLoop_Translator_DictionaryLookupResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[nc.getTypeName()])}}nc.H_={T_:nc.getTypeName(),B_:nc.getBaseTypes()};class ac{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(ac,this,e)}static getTypeName(){return"AugLoop_Translator_TranslateFileResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[ac.getTypeName()])}}ac.H_={T_:ac.getTypeName(),B_:ac.getBaseTypes()};class ic{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(ic,this,e)}static getTypeName(){return"AugLoop_Translator_SupportedLanguagesResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[ic.getTypeName()])}}ic.H_={T_:ic.getTypeName(),B_:ic.getBaseTypes()};class rc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(rc,this,e)}static getTypeName(){return"AugLoop_Translator_BreakSentencesResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[rc.getTypeName()])}}rc.H_={T_:rc.getTypeName(),B_:rc.getBaseTypes()};class oc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(oc,this,e)}static getTypeName(){return"AugLoop_Translator_DictionaryExamplesResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[oc.getTypeName()])}}oc.H_={T_:oc.getTypeName(),B_:oc.getBaseTypes()};class sc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(sc,this,e)}static getTypeName(){return"AugLoop_Translator_DetectLanguagesArrayResponse"}static getBaseTypes(){return["AugLoop_Translator_TranslatorAnnotationBase","AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[sc.getTypeName()])}}sc.H_={T_:sc.getTypeName(),B_:sc.getBaseTypes()};var cc,dc,lc,uc,fc,pc,mc,_c,hc=function(e,t){var n=e.boundingRegions[0].polygon[0].x,a=e.boundingRegions[0].polygon[1].y,i=t.boundingRegions[0].polygon[0].x,r=t.boundingRegions[0].polygon[1].y;return a<r?-1:a===r?n<i?-1:0:1},bc=function(e,t){var n=e.boundingBox.left,a=e.boundingBox.top,i=t.boundingBox.left,r=t.boundingBox.top;return a<r?-1:a===r?n<i?-1:0:1},gc=function(e,t){var n=(Math.min(e.right,t.right)-Math.max(e.left,t.left))*(Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top));return n/(e.width*e.height+t.width*t.height-n)*100},vc=function(e){var t=e.cells.filter(function(e){return"columnHeader"===e.kind}).reduce(function(e,t){return"".concat(e,"<th colspan=").concat(t.columnSpan,">").concat(t.content,"</th>")},""),n=t?"<thead><tr>".concat(t,"</tr></thead>"):"",a=e.cells.filter(function(e){return"content"===e.kind}).reduce(function(e,t){var n;return e.has(t.rowIndex)?null===(n=e.get(t.rowIndex))||void 0===n||n.push(t):e.set(t.rowIndex,[t]),e},new Map),i=Array.from(a.keys()).reduce(function(e,t){var n=a.get(t).reduce(function(e,t){return"".concat(e,"<td colspan=").concat(t.columnSpan,">").concat(t.content,"</td>")},"");return"".concat(e,"<tr>").concat(n,"</tr>")},"");return"<table>".concat(n,"<tbody>").concat(i,"</tbody></table>")};function yc(t,n){if(null!==t&&null!==n){var a=t.pages[0].width,i=t.pages[0].height;(t.paragraphs||[]).sort(hc);var r=n.filter(function(e){return(e.probability||0)>.4&&"ck5wp"!==e.tagName});r.sort(bc),r=function(t,n,a){return a.map(function(a){var i={height:a.boundingBox.height*n,width:a.boundingBox.width*t,left:a.boundingBox.left*t,top:a.boundingBox.top*n};return(0,e.__assign)((0,e.__assign)({},a),{boundingBox:i})})}(a,i,r);var o,s,c,d=function(e,t,n,a){var i=new Map,r=e.filter(function(e){return!e.role});return t.forEach(function(e){for(var t=e.boundingBox,o={left:t.left,right:t.left+t.width,top:t.top,bottom:t.top+t.height,width:t.width,height:t.height},s=0,c=void 0,d=0;d<r.length;d++){var l=r[d],u={left:0,width:0,height:0,right:n,top:l.boundingRegions[0].polygon[1].y,bottom:d===r.length-1?a:r[d+1].boundingRegions[0].polygon[1].y};u.width=n,u.height=u.bottom-u.top;var f=gc(u,o);if(!(f<0)&&(f>s&&(s=f,c=l),f<s))break}c&&(i.has(c)?i.get(c).push(e):i.set(c,[e]))}),i}(t.paragraphs||[],r,a,i),l=function(e,t,n,a){var i=new Map,r=e.filter(function(e){return!e.role});return t.forEach(function(e){var t=e.boundingRegions[0],o={left:t.polygon[0].x,top:t.polygon[0].y,right:t.polygon[1].x,bottom:t.polygon[2].y,width:0,height:0};o.width=o.right-o.left,o.height=o.bottom-o.top;for(var s=0,c=void 0,d=0;d<r.length;d++){var l=r[d],u={left:0,width:0,height:0,right:n,top:l.boundingRegions[0].polygon[1].y,bottom:d===r.length-1?a:r[d+1].boundingRegions[0].polygon[1].y};u.width=n,u.height=u.bottom-u.top;var f=gc(u,o);if(!(f<0)&&(f>s&&(s=f,c=l),f<s))break}c&&(i.has(c)?i.get(c).push(e):i.set(c,[e]))}),i}(t.paragraphs||[],t.tables||[],a,i),u=(o=t.paragraphs||[],s=t.tables||[],c=s.reduce(function(e,t){return e.concat(t.cells)},[]),o.filter(function(e){var t=e.boundingRegions[0].polygon;return!!c.find(function(e){return t.some(function(t){return!!e.boundingRegions[0].polygon.find(function(e){return e.x===t.x&&e.y===t.y})})})}));return function(e,t,n,a){var i=e.find(function(e){return"title"===e.role}),r=e.filter(function(e){return"title"!==e.role}).map(function(e,i){var r={index:i+1,sections:[]},o={index:1,webParts:[]};if(r.sections.push(o),t.has(e)){var s=t.get(e)[0],c="imagewp"===(s.tagName||"")?"Image":"Text";if(s.boundingBox.top>=e.boundingRegions[0].polygon[2].y){var d={type:"Text",source:"<p>".concat(e.content,"</p>"),ctrlIndex:1},l={ctrlIndex:2,type:c};o.webParts.push(d),o.webParts.push(l)}else{var u={index:2,webParts:[]};r.sections.push(u),d={type:"Text",source:"<p>".concat(e.content,"</p>"),ctrlIndex:1},l={ctrlIndex:1,type:c},s.boundingBox.left>=e.boundingRegions[0].polygon[0].x?(o.webParts.push(d),u.webParts.push(l)):(o.webParts.push(l),u.webParts.push(d))}}else if(n.has(e)){var f=n.get(e)[0];if(a.includes(e)){var p={type:"Table",source:vc(f),ctrlIndex:1};o.webParts.push(p)}else f.boundingRegions[0].polygon[0].y>=e.boundingRegions[0].polygon[2].y?(d={type:"Text",source:"<p>".concat(e.content,"</p>"),ctrlIndex:1},p={type:"Table",source:vc(f),ctrlIndex:2},o.webParts.push(d),o.webParts.push(p)):(u={index:2,webParts:[]},r.sections.push(u),d={type:"Text",source:"<p>".concat(e.content,"</p>"),ctrlIndex:1},p={type:"Table",source:vc(f),ctrlIndex:1},f.boundingRegions[0].polygon[0].y>=e.boundingRegions[0].polygon[1].x?(o.webParts.push(d),u.webParts.push(p)):(o.webParts.push(p),u.webParts.push(d)))}else a.includes(e)||(d={type:c=e.role?"SectionHeading":"Text",source:"SectionHeading"===c?"<h2>".concat(e.content,"</h2>"):"<p>".concat(e.content,"</p>"),ctrlIndex:1},o.webParts.push(d));return r});return{title:null==i?void 0:i.content,zones:r}}(t.paragraphs||[],d,l,u)}}!function(e){e[e.NotAuthenticated=0]="NotAuthenticated",e[e.Pending=1]="Pending",e[e.Authenticated=2]="Authenticated",e[e.WacUserInfoAuthenticated=3]="WacUserInfoAuthenticated"}(cc||(cc={})),(_c=dc||(dc={})).GetCurrentChatOperation="GetCurrentChatOperation",_c.GetAllChatsOperation="GetAllChatsOperation",_c.GetChatOperation="GetChatOperation",_c.AddChatOperation="AddChatOperation",_c.AddMessageOperation="AddMessageOperation",_c.GetMessagesInCurrentChatSession="GetMessagesInCurrentChatSession",_c.RemoveAllMessagesFromCurrentChatOperation="RemoveAllMessagesFromCurrectChatOperation",_c.DeleteChatOperation="DeleteChatOperation",_c.UpdateMessageOperation="UpdateMessageOperation",_c.UpdateChatOperation="UpdateChatOperation",function(e){e.User="User",e.Copilot="Copilot",e.System="System"}(lc||(lc={})),function(e){e.Canvas="Canvas",e.Pane="Pane"}(uc||(uc={})),function(e){e.Success="Success",e.Failure="Failure"}(fc||(fc={})),function(e){e.PlainText="PlainText",e.RichText="RichText",e.AdaptiveCard="AdaptiveCard"}(pc||(pc={})),function(e){e.AIResponse="AIResponse",e.ContentCreation="ContentCreation"}(mc||(mc={}));class Sc{constructor(e){t.assign(Sc,this,e)}static getTypeName(){return"AugLoop_CopilotChatHistory_CopilotChatHistorySignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return t.matchesTypesFor(e,[Sc.getTypeName()])}}Sc.H_={T_:Sc.getTypeName(),B_:Sc.getBaseTypes()};var Dc=function(){function e(){}return e.generateId=function(){return e._operationId++,"AugLoopChatSharePoint"+e._operationId.toString()},e._operationId=0,e}(),Ic=function(){function t(t){this._config=t,this._responseCallbacks=new Map,this._operationBacklog=new Map,this._chatId=H.Guid.newGuid().toString();var n,a,i,r=(0,e.__spreadArray)((0,e.__spreadArray)([],t.annotationPath,!0),[this._chatId],!1);this._messagesPath=(0,e.__spreadArray)((0,e.__spreadArray)([],r,!0),["messages"],!1),this._activateAnnotation(t.annotation),this._submitOperations([(n=this._chatId,a={newChat:{userId:"",documentId:"",sessionId:n,messages:[]},type:dc.AddChatOperation},i=new Sc({operation:a,timestamp:Date.now()}),new C({parentPath:["signal",Sc.getTypeName()],items:[{id:Dc.generateId(),body:i}]}))]),this._handleReconnect()}return t.prototype.send=function(t,n){return(0,e.__awaiter)(this,void 0,void 0,function(){var a,i,r=this;return(0,e.__generator)(this,function(e){var o,s,c,d;return a=Dc.generateId(),i=[new p({parentPath:this._messagesPath,items:[{id:a,body:t}]})],n&&i.push((o={content:n,entry:uc.Pane,userRole:lc.User,format:pc.PlainText,timestamp:(new Date).getTime(),messageId:a},s=this._chatId,c={newMessage:o,type:dc.AddMessageOperation,chatSessionId:s},d=new Sc({operation:c,timestamp:Date.now()}),new C({parentPath:["signal",Sc.getTypeName()],items:[{id:Dc.generateId(),body:d}]}))),this._submitOperations(i),this._operationBacklog.set(a,i),[2,new Promise(function(e){return r._responseCallbacks.set(a,e)})]})})},t.prototype.close=function(){return this._config.session.releaseAnnotation(this._activatedAnnotationToken)},t.prototype._activateAnnotation=function(e){var t=this;return this._config.session.activateAnnotation(e,{callback:function(e){if(p.typeGuard(e)&&t._isUnderSubtree(e.parentPath,t._messagesPath))for(var n=0,a=e.items;n<a.length;n++){var i=a[n],r=e.parentPath[e.parentPath.length-1],o=t._responseCallbacks.get(r);o&&(o(i.body),t._responseCallbacks.delete(r)),!Lo()&&t._operationBacklog.has(r)&&t._operationBacklog.delete(r)}}}).then(function(e){t._activatedAnnotationToken=e.token})},t.prototype._isUnderSubtree=function(e,t){if(e.length<t.length)return!1;for(var n=0;n<t.length;n++)if(e[n]!==t[n])return!1;return!0},t.prototype._submitOperations=function(e){this._config.session.submitOperations(e)},t.prototype._handleReconnect=function(){var e=this;this._config.session.setReconnectCallback(function(){e._activateAnnotation(e._config.annotation)}),this._config.session.setServerAuthenticationStateChangeCallback(function(t){!Lo()&&t===cc.Authenticated&&e._operationBacklog.size>0&&e._operationBacklog.forEach(function(t){e._submitOperations(t)})})},t}();const xc=Ic;class Cc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Cc,this,e)}static getTypeName(){return"AugLoop_SharepointDesignIdeasPersonalizer_DesignIdeasRankAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Cc.getTypeName()])}}Cc.H_={T_:Cc.getTypeName(),B_:Cc.getBaseTypes()};class Oc{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){t.assign(Oc,this,e)}static getTypeName(){return"AugLoop_SharepointDesignIdeasPersonalizer_DesignIdeasRewardAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return t.matchesTypesFor(e,[Oc.getTypeName()])}}function wc(){return H._SPFlight.isEnabled(61343)}Oc.H_={T_:Oc.getTypeName(),B_:Oc.getBaseTypes()};var Ec,Ac,Lc,kc,Mc,Pc,Tc,Uc,Fc,Hc,Rc,Nc,Bc,jc,Vc,zc,Gc,Kc,Wc,qc="SPAugmentationLoop.AlWorkflowProxy.",Qc="".concat(qc,"sendGptMessage"),Yc=function(){function t(e,t,n){var a=this;this.getAugloopSession=function(){return a._augloopSessionPromise||(a._augloopSessionPromise=Vo(a._pageContext,void 0,void 0,a._pageUniqueId,a._appNameOverride)),a._augloopSessionPromise},this._createChatHelper=function(e,t){var n=new R._QosMonitor("".concat(qc,"createChatHelper"));return E.create({session:e,chat:new ns(null!=t?t:{modelConfig:new ss({model:zo.TextDavinci003,parameters:{temperature:.7,stop:["","<|endoftext|>"],maxTokens:1e3}}),context:"The following is a transcript of a conversation between a human and a smart, helpful AI assistant. They take turns making statements. Human statements start with Human and AI assistant statements start with AI. The transcript consists of only these statements from now on.\nHuman\nhi Chat gpt!\nAI\nhello!\n",prefixText:"\nHuman\n",suffixText:"\nAI\n",historyDepth:-1}),responseType:as.getTypeName()}).then(function(e){return n.writeSuccess(),e}).catch(function(e){throw R._TraceLogger.logError(Fo,e,"Unable to instantiate ChatGPT helper"),n.writeUnexpectedFailure(void 0,e),e})},this._getChatHelper=function(){return a._chatHelperPromise||(a._chatHelperPromise=a.getAugloopSession().then(function(e){return a._createChatHelper(e)})),a._chatHelperPromise},this._pageContext=e,this._pageUniqueId=t,this._appNameOverride=n}return t.prototype.getAugloopSessionId=function(){return Bo(this._pageContext).sessionId},t.prototype.runSingleItemWorkflow=function(t,n,a,i){return void 0===a&&(a=!1),void 0===i&&(i="dogfood"),(0,e.__awaiter)(this,void 0,void 0,function(){var r,o,s=this;return(0,e.__generator)(this,function(c){switch(c.label){case 0:return H._SPKillSwitch.isActivated("d743f719-69db-4a13-96eb-5c52ae023a1f")?[3,1]:[2,this._runWorkflow(t,a,i,function(e){return e.submitOperation(n)})];case 1:return a?[4,Vo(this._pageContext,!1,i,this._pageUniqueId,this._appNameOverride)]:[3,3];case 2:return o=c.sent(),[3,5];case 3:return[4,this.getAugloopSession()];case 4:o=c.sent(),c.label=5;case 5:return r=o,[2,new Promise(function(i,o){var c;r.activateAnnotation(t,{callback:function(n){r.releaseAnnotation(c.token).then(function(){return(0,e.__awaiter)(s,void 0,void 0,function(){var t;return(0,e.__generator)(this,function(e){return t=n.items[0].body,a&&r.close(),i(t),[2]})})}).catch(function(e){R._TraceLogger.logError(Fo,e,"error releasing ".concat(t," annotation")),o(e)})}}).then(function(e){c=e,r.submitOperation(n)}).catch(function(e){R._TraceLogger.logError(Fo,e,"performing ".concat(t," request")),o(e)})})]}})})},t.prototype.runMultipleItemsWorkflow=function(t,n,a,i){return void 0===a&&(a=!1),void 0===i&&(i="dogfood"),(0,e.__awaiter)(this,void 0,void 0,function(){return(0,e.__generator)(this,function(e){return[2,this._runWorkflow(t,a,i,function(e){return e.submitOperations(n)})]})})},t.prototype.generateOdsl=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n;return(0,e.__generator)(this,function(e){return n=new Promise(function(e,t){setTimeout(function(){t(new Error("Timeout: ODSL generation took too long"))},12e4)}),[2,Promise.race([n,this._generateOdslInternal(t)])]})})},t.prototype.getLayoutPageModel=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=new C({parentPath:["Signal"],items:[{id:H.Guid.newGuid().toString(),revId:"0",body:t}]}),[4,this.runSingleItemWorkflow("AugLoop_LayoutAnalysis_LayoutAnalysisAnnotation",n)];case 1:return[2,yc((a=e.sent()).layout,a.predictions)]}})})},t.prototype.callSpCopilot=function(t,n){return void 0===n&&(n=3),(0,e.__awaiter)(this,void 0,void 0,function(){var a,i,r,o,s,c,d;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return a=this,(i=this._spChatClient)?[3,2]:[4,this._createSPChatClient()];case 1:i=e.sent(),e.label=2;case 2:return a._spChatClient=i,r=new R._QosMonitor("".concat(qc,"sendMessageWithRetry")),n<=0?(r.writeUnexpectedFailure("MaxRetryCountReached"),[2,void 0]):[4,this._spChatClient.send(t)];case 3:switch(o=e.sent(),s=o.status,c=Go[s],d={alias:c,sessionid:this.getAugloopSessionId()},s){case Go.Success:case Go.PartialResult:case Go.EmptyResponse:return[3,4];case Go.ResourcesNotAvailable:case Go.Overloaded:case Go.TooLargeRequest:case Go.UserNotAuthenticated:case Go.UserNotAuthorized:return[3,5];case Go.OffensiveContentInput:case Go.OffensiveContentOutput:case Go.RaiUnsupportedLanguageInContentInput:case Go.RaiUnsupportedLanguageInContentOutput:case Go.InputBlockedByDynamicGuardList:case Go.OutputBlockedByDynamicGuardList:case Go.InputAttackDetected:case Go.OutputAttackDetected:case Go.ModelContentFilter:return[3,6]}return[3,7];case 4:return r.writeSuccess(d),[2,o];case 5:return r.writeUnexpectedFailure(c,void 0,d),[2,o];case 6:return r.writeExpectedFailure(c,void 0,d),[2,o];case 7:return r.writeUnexpectedFailure(c,void 0,d),[4,this.callSpCopilot(t,--n)];case 8:return[2,e.sent()]}})})},t.prototype.sendGptMessage=function(e,t){var n=this;return new Promise(function(a,i){var r=new R._QosMonitor(Qc);n._getChatHelper().then(function(n){n.send(new _s({message:"".concat(e,""),modelPlaceholders:t}),function(e){r.writeSuccess(),a(e)})}).catch(function(e){r.writeUnexpectedFailure(e),R._TraceLogger.logError(Fo,e,"error in send message"),i(e)})})},t.prototype.getKeyPhrases=function(t,n){return(0,e.__awaiter)(this,void 0,void 0,function(){var a,i;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return a=H.Guid.newGuid().toString(),i=new p({parentPath:["KeyPhrasesSignal"],items:[{id:a,body:H._SPKillSwitch.isActivated("f10394fa-d246-4ebd-8d55-b2f232875375")?new A({content:t}):new hs({content:t})}]}),[4,this.runSingleItemWorkflow(eo.getTypeName(),i,!!n||void 0,n?"prod":void 0)];case 1:return[2,e.sent()]}})})},t.prototype.resetChat=function(){return(0,e.__awaiter)(this,void 0,void 0,function(){return(0,e.__generator)(this,function(e){switch(e.label){case 0:return[4,this._getChatHelper()];case 1:return[4,e.sent().close()];case 2:return e.sent(),this._chatHelperPromise=void 0,[2]}})})},t.prototype.dispose=function(){return(0,e.__awaiter)(this,void 0,void 0,function(){var t;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),[4,this.resetChat()];case 1:return e.sent(),[4,this.getAugloopSession()];case 2:return e.sent().close(),[3,4];case 3:return t=e.sent(),R._TraceLogger.logError(Fo,t,"error in destroy Augloop Proxy"),[3,4];case 4:return[2]}})})},t.prototype.generateInsights=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session","doc",n],items:[{id:n,contextId:"alproxyinsights",body:new L({content:t})}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.generateImageByDallE=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session","doc"],items:[{id:n,revId:"0",body:new Ds({caption:t})}]}),[4,this.runSingleItemWorkflow(Yr.getTypeName(),a)];case 1:return[2,e.sent()]}})})},t.prototype.findProviderContentAnnotationImages=function(t,n,a,i,r){return void 0===i&&(i=20),void 0===r&&(r=Jo.Stock),(0,e.__awaiter)(this,void 0,void 0,function(){var o,s;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return o=n||H.Guid.newGuid().toString(),s=new p({parentPath:["ContentSearchSignal"],items:[{id:o,body:new Cs({query:t,contentProviders:[{provider:a||wc()&&r===Jo.External?Xo.TAS:Xo.Hubble,contentSource:wc()?r:Jo.Stock,contentType:Yo.Image,pageSize:i,pageOffset:"0",queryParams:[],pivotIds:[Qo.Images]}]})}]}),[4,this.runSingleItemWorkflow(io.getTypeName(),s,!a||!ko()||void 0,a&&ko()?void 0:"prod")];case 1:return[2,e.sent()]}})})},t.prototype.translateContent=function(t,n,a,i,r){return(0,e.__awaiter)(this,void 0,void 0,function(){var o,s;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return o=i||H.Guid.newGuid().toString(),s=new p({parentPath:["TranslateContentSignal"],items:[{id:o,body:new Ws({requestId:o,contentType:0,sourceLanguage:n,targetLanguage:a,text:t})}]}),[4,this.runSingleItemWorkflow(ec.getTypeName(),s,r)];case 1:return[2,e.sent()]}})})},t.prototype.rankSuggestions=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,contextId:"DesignIdeasPersonalizerContext",body:t}]}),[4,this.runSingleItemWorkflow(Cc.getTypeName(),a,!0)];case 1:return[2,e.sent()]}})})},t.prototype.rewardSuggestion=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,contextId:"DesignIdeasPersonalizerContext",body:t}]}),[4,this.runSingleItemWorkflow(Oc.getTypeName(),a,!0)];case 1:return[2,e.sent()]}})})},t.prototype.findHubbleIcon=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["TextToIconSignal"],items:[{id:n,body:new ws({content:t})}]}),[4,this.runSingleItemWorkflow($r.getTypeName(),a)];case 1:return[2,e.sent()]}})})},t.prototype.generatePageSkeleton=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,body:new ks(t)}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.generatePageOutline=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,body:new Ms(t)}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.generateSections=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,body:new Ps(t)}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.generateSubtopics=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,body:new Ls(t)}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.generateWebParts=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,body:new Us(t)}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.extractSources=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,body:new Hs(t)}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.composeAnswerRequest=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=H.Guid.newGuid().toString(),a=new p({parentPath:["session"],items:[{id:n,body:new Ts(t)}]}),[4,this.getAugloopSession()];case 1:return e.sent().submitOperations([a]),[2]}})})},t.prototype.subscribeToWorkflows=function(t,n){return(0,e.__awaiter)(this,void 0,void 0,function(){var a,i;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return[4,this.getAugloopSession()];case 1:return a=e.sent(),i=t.map(function(e){return a.activateAnnotation(e,{callback:n})}),[4,Promise.all(i)];case 2:return[2,e.sent().map(function(e){return e.token})]}})})},t.prototype.unSubscribeFromWorkflows=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return[4,this.getAugloopSession()];case 1:return n=e.sent(),a=t.map(function(e){return n.releaseAnnotation(e)}),[4,Promise.all(a)];case 2:return[2,0===e.sent().filter(function(e){return!e}).length]}})})},t.prototype._createSPChatClient=function(){return(0,e.__awaiter)(this,void 0,void 0,function(){var t,n,a,i,r;return(0,e.__generator)(this,function(e){switch(e.label){case 0:t=new R._QosMonitor("".concat(qc,"createSPChatClient")),e.label=1;case 1:return e.trys.push([1,3,,4]),a=xc.bind,r={},[4,this.getAugloopSession()];case 2:return n=new(a.apply(xc,[void 0,(r.session=e.sent(),r.annotation=_o.getTypeName(),r.annotationPath=["session","chat"],r)])),t.writeSuccess(),[2,n];case 3:throw i=e.sent(),R._TraceLogger.logError(Fo,i,"Unable to instantiate SPChatClient"),t.writeUnexpectedFailure(void 0,i),i;case 4:return[2]}})})},t.prototype._createOdslChatClient=function(){return(0,e.__awaiter)(this,void 0,void 0,function(){var t,n,a,i,r;return(0,e.__generator)(this,function(e){switch(e.label){case 0:t=new R._QosMonitor("".concat(qc,"createOdslChatClient")),e.label=1;case 1:return e.trys.push([1,3,,4]),a=xc.bind,r={},[4,this.getAugloopSession()];case 2:return n=new(a.apply(xc,[void 0,(r.session=e.sent(),r.annotation=go.getTypeName(),r.annotationPath=["session","doc"],r)])),t.writeSuccess(),[2,n];case 3:throw i=e.sent(),R._TraceLogger.logError(Fo,i,"Unable to instantiate OdslChatClient"),t.writeUnexpectedFailure(void 0,i),i;case 4:return[2]}})})},t.prototype._generateOdslInternal=function(t){return(0,e.__awaiter)(this,void 0,void 0,function(){var n,a;return(0,e.__generator)(this,function(e){switch(e.label){case 0:return n=this,(a=this._odslChatClient)?[3,2]:[4,this._createOdslChatClient()];case 1:a=e.sent(),e.label=2;case 2:return n._odslChatClient=a,[4,this._odslChatClient.send(new Es(t),t.query)];case 3:return[2,e.sent()]}})})},t.prototype._runWorkflow=function(t,n,a,i){return void 0===n&&(n=!1),void 0===a&&(a="dogfood"),(0,e.__awaiter)(this,void 0,void 0,function(){var r,o,s=this;return(0,e.__generator)(this,function(c){switch(c.label){case 0:return n?[4,Vo(this._pageContext,!1,a,this._pageUniqueId,this._appNameOverride)]:[3,2];case 1:return o=c.sent(),[3,4];case 2:return[4,this.getAugloopSession()];case 3:o=c.sent(),c.label=4;case 4:return r=o,[2,new Promise(function(a,o){var c;r.activateAnnotation(t,{callback:function(i){r.releaseAnnotation(c.token).then(function(){return(0,e.__awaiter)(s,void 0,void 0,function(){var t;return(0,e.__generator)(this,function(e){return t=i.items[0].body,n&&r.close(),a(t),[2]})})}).catch(function(e){R._TraceLogger.logError(Fo,e,"error releasing ".concat(t," annotation")),o(e)})}}).then(function(e){c=e,i(r)}).catch(function(e){R._TraceLogger.logError(Fo,e,"performing ".concat(t," request")),o(e)})})]}})})},t}();class Jc{constructor(e){mo.assign(Jc,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointCopilotRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Jc.getTypeName()])}}Jc.H_={T_:Jc.getTypeName(),B_:Jc.getBaseTypes()};class Xc{constructor(e){mo.assign(Xc,this,e)}static getTypeName(){return"AugLoop_SharepointCopilot_SharepointListCopilotRequest"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return mo.matchesTypesFor(e,[Xc.getTypeName()])}}Xc.H_={T_:Xc.getTypeName(),B_:Xc.getBaseTypes()},function(e){e["SiteHandler.describeSiteAndTheme"]="SiteHandler.describeSiteAndTheme",e["SiteHandler.describeHomePage"]="SiteHandler.describeHomePage",e["SiteHandler.describeOtherPages"]="SiteHandler.describeOtherPages",e["SiteHandler.describeInitialPages"]="SiteHandler.describeInitialPages",e["PageHandler.designHomePage"]="PageHandler.designHomePage",e["PageHandler.designPage"]="PageHandler.designPage",e["PageHandler.convertDocToPage"]="PageHandler.convertDocToPage",e["OdslPageHandler.designDocumentPage"]="OdslPageHandler.designDocumentPage",e["SiteIntentHandler.filterIntent"]="SiteIntentHandler.filterIntent",e["FileHandler.getAnswerForFile"]="FileHandler.getAnswerForFile",e["RteHandler.getRewriteSuggestions"]="RteHandler.getRewriteSuggestions"}(Ec||(Ec={})),function(e){e.copilotRewrite="copilotRewrite",e.copilotLonger="copilotLonger",e.copilotToneCasual="copilotToneCasual",e.copilotToneProfessional="copilotToneProfessional",e.copilotToneConcise="copilotToneConcise",e.copilotToneEnthusiastic="copilotToneEnthusiastic",e.copilotToneEngaging="copilotToneEngaging",e.copilotToneCreative="copilotToneCreative"}(Ac||(Ac={})),function(e){e.copilotUser="CopilotUser",e.people="People",e.topics="Topics",e.topicRelatedPeople="TopicRelatedPeople",e.topicRelatedSites="TopicRelatedSites",e.topicRelatedFiles="TopicRelatedFiles",e.copilotFile="CopilotFile"}(Lc||(Lc={})),function(e){e.text="text",e.image="image",e.video="video",e.people="people",e.links="links",e.title="title"}(kc||(kc={})),function(e){e.Refresh="Refresh"}(Mc||(Mc={})),function(e){e.Month="Month",e.Day="Day",e.Hour="Hour",e.Minute="Minute",e.Week="Week"}(Pc||(Pc={})),function(e){e[e.Message=0]="Message",e[e.File=1]="File"}(Tc||(Tc={})),function(e){e[e.SharePoint=0]="SharePoint",e[e.OneDriveBusiness=1]="OneDriveBusiness",e[e.Exchange=2]="Exchange"}(Uc||(Uc={})),function(e){e[e.MessageId=0]="MessageId",e[e.ConversationId=1]="ConversationId",e[e.SiteId=2]="SiteId",e[e.WebId=3]="WebId",e[e.UniqueId=4]="UniqueId",e[e.SuggestionEntityId=5]="SuggestionEntityId",e[e.AuthorId=6]="AuthorId",e[e.ImmutableId=7]="ImmutableId",e[e.ListId=8]="ListId",e[e.AADObjectId=9]="AADObjectId",e[e.BookmarkUrl=10]="BookmarkUrl",e[e.AttachmentId=11]="AttachmentId",e[e.RecommendationEntityId=12]="RecommendationEntityId",e[e.ConnectorEntityId=13]="ConnectorEntityId",e[e.EventId=14]="EventId",e[e.TaskId=15]="TaskId",e[e.SharepointDocId=16]="SharepointDocId"}(Fc||(Fc={})),function(e){e.None="None",e.Exchange="Exchange",e.SharePoint="SharePoint",e.OneDriveBusiness="OneDriveBusiness",e.ExchangeArchive="ExchangeArchive",e.Mailbox="Mailbox",e.Directory="Directory",e.Teams="Teams",e.Connectors="Connectors",e.SamsungNotes="SamsungNotes",e.OneNote="OneNote"}(Hc||(Hc={})),function(e){e.None="None",e.Suggestion="Suggestion",e.Modification="Modification",e.NoResultModification="NoResultModification",e.NoRequeryModification="NoRequeryModification",e.NoResultFolderRefinerModification="NoResultFolderRefinerModification",e.Extension="Extension"}(Rc||(Rc={})),function(e){e.None="None",e.Directory="Directory",e.Exchange="Exchange",e.ExchangeArchive="ExchangeArchive",e.Mailbox="Mailbox",e.OneDriveBusiness="OneDriveBusiness",e.SharePoint="SharePoint",e.Teams="Teams",e.Connectors="Connectors"}(Nc||(Nc={})),function(e){e.Interleaved="Interleaved",e.Blocks="Blocks"}(Bc||(Bc={})),function(e){e.Optimized="Optimized"}(jc||(jc={})),function(e){e.None="None",e.KQLParser="KQLParser",e.AQSParser="AQSParser",e.FQLParser="FQLParser"}(Vc||(Vc={})),function(e){e.Id="Id",e.TenantId="TenantId",e.ConcatenatedId="ConcatenatedId",e.ExternalDirectoryObjectId="ExternalDirectoryObjectId",e.ADObjectId="ADObjectId",e.UserPrincipalName="UserPrincipalName",e.MRI="MRI",e.Alias="Alias",e.DisplayName="DisplayName",e.GivenName="GivenName",e.Surname="Surname",e.JobTitle="JobTitle",e.ImAddress="ImAddress",e.Phones="Phones",e.CompanyName="CompanyName",e.Department="Department",e.OfficeLocation="OfficeLocation",e.EmailAddresses="EmailAddresses",e.Confidence="Confidence",e.Inferences="Inferences",e.Summary="Summary",e.URL="URL",e.Title="Title",e.Author="Author",e.filename="filename",e.HitHighlightedSummary="HitHighlightedSummary",e.FromTuring="FromTuring"}(zc||(zc={})),function(e){e.Text="Text",e.Speech="Speech"}(Gc||(Gc={})),function(e){e.FinalResult="FinalResult",e.Partial="Partial"}(Kc||(Kc={})),Error,Error,function(e){e.FileEnablePersonMatch="FileEnablePersonMatch",e.FileDisablePersonMatch="FileDisablePersonMatch"}(Wc||(Wc={}));var Zc=c(909),$c="https://substrate.office.com/search",ed=jr._AadTokenProviders.configurable,td=R._LogSource.create("sp-SubstrateApiCallLogger");function nd(e){return new Promise(function(t){e.whenFinished(function(){return t(!0)})})}function ad(e){if(!Array.isArray(e.EntitySets))return[];var t=e.EntitySets.reduce(function(e,t){var n,a,i=(a=null===(n=t.ResultSets)||void 0===n?void 0:n.filter(function(e){var t;return 0!==e.Total||(null===(t=e.Results)||void 0===t?void 0:t.length)}))?a.reduce(function(e,t){var n,a;if(null===(n=t.Results)||void 0===n?void 0:n.length){var i=null===(a=t.Results)||void 0===a?void 0:a.map(function(e){return function(e){var t,n,a,i,r,o,s,c,d,l,u,f,p,m,_,h,b,g,v,y,S,D,I,x,C,O,w,E,A,L,k,M,P,T,U,F,H,R,N,B,j,V,z,G,K,W,q,Q,Y,J,X,Z,$,ee,te,ne,ae;switch(e.Provenance){case Hc.SharePoint:return{itemKind:Tc.File,itemProvenance:Uc.SharePoint,displayTitle:null===(t=e.Source)||void 0===t?void 0:t.Title,displayPreview:(null===(n=e.Source)||void 0===n?void 0:n.HitHighlightedSummary)||(null===(a=e.Source)||void 0===a?void 0:a.Description),displayAuthor:(null===(r=null===(i=e.Source)||void 0===i?void 0:i.DisplayAuthor)||void 0===r?void 0:r.split(";"))||(null===(s=null===(o=e.Source)||void 0===o?void 0:o.Author)||void 0===s?void 0:s.DisplayName),displayFileType:(null===(c=e.Source)||void 0===c?void 0:c.FileType)||(null===(d=e.Source)||void 0===d?void 0:d.FileExtension),redirectUrl:(null===(l=e.Source)||void 0===l?void 0:l.ServerRedirectedURL)||(null===(u=e.Source)||void 0===u?void 0:u.Url),previewUrl:null===(f=e.Source)||void 0===f?void 0:f.ServerRedirectedPreviewURL,embedUrl:null===(p=e.Source)||void 0===p?void 0:p.ServerRedirectedEmbedURL,contextTimestamp:(null===(m=e.Source)||void 0===m?void 0:m.LastModifiedTime)||(null===(_=e.Source)||void 0===_?void 0:_.LastModifiedDateTime),hitHighlightedSummary:e.HitHighlightedSummary||(null===(h=e.Source)||void 0===h?void 0:h.Description),author:(null===(b=e.Source)||void 0===b?void 0:b.Author)||(null===(v=null===(g=e.Source)||void 0===g?void 0:g.Author)||void 0===v?void 0:v.DisplayName),path:(null===(y=e.Source)||void 0===y?void 0:y.Path)||(null===(S=e.Source)||void 0===S?void 0:S.Url),originalPath:(null===(D=e.Source)||void 0===D?void 0:D.OriginalPath)||(null===(I=e.Source)||void 0===I?void 0:I.Url),spWebUrl:(null===(x=e.Source)||void 0===x?void 0:x.SPWebUrl)||(null===(C=e.Source)||void 0===C?void 0:C.WebUrl),guids:{siteId:null===(O=e.Source)||void 0===O?void 0:O.SiteId,webId:null===(w=e.Source)||void 0===w?void 0:w.WebId,listId:null===(E=e.Source)||void 0===E?void 0:E.ListId,itemId:null===(A=e.Source)||void 0===A?void 0:A.UniqueId}};case Hc.OneDriveBusiness:return{itemKind:Tc.File,itemProvenance:Uc.OneDriveBusiness,displayTitle:null===(L=e.Source)||void 0===L?void 0:L.Title,displayAuthor:(null===(k=e.Source)||void 0===k?void 0:k.Author)||(null===(P=null===(M=e.Source)||void 0===M?void 0:M.Author)||void 0===P?void 0:P.DisplayName),displayFileType:(null===(T=e.Source)||void 0===T?void 0:T.FileType)||(null===(U=e.Source)||void 0===U?void 0:U.FileExtension),redirectUrl:null===(F=e.Source)||void 0===F?void 0:F.LinkingUrl,contextTimestamp:(null===(H=e.Source)||void 0===H?void 0:H.LastModifiedTime)||(null===(R=e.Source)||void 0===R?void 0:R.LastModifiedDateTime),hitHighlightedSummary:e.HitHighlightedSummary||(null===(N=e.Source)||void 0===N?void 0:N.Description),author:(null===(B=e.Source)||void 0===B?void 0:B.Author)||(null===(V=null===(j=e.Source)||void 0===j?void 0:j.Author)||void 0===V?void 0:V.DisplayName),path:(null===(z=e.Source)||void 0===z?void 0:z.Path)||(null===(G=e.Source)||void 0===G?void 0:G.Url),originalPath:(null===(K=e.Source)||void 0===K?void 0:K.OriginalPath)||(null===(W=e.Source)||void 0===W?void 0:W.Url),spWebUrl:(null===(q=e.Source)||void 0===q?void 0:q.SPWebUrl)||(null===(Q=e.Source)||void 0===Q?void 0:Q.WebUrl),guids:{siteId:null===(Y=e.Source)||void 0===Y?void 0:Y.SiteId,webId:null===(J=e.Source)||void 0===J?void 0:J.WebId,listId:null===(X=e.Source)||void 0===X?void 0:X.ListId,itemId:null===(Z=e.Source)||void 0===Z?void 0:Z.UniqueId}};case Hc.Exchange:return{itemKind:Tc.Message,itemProvenance:Uc.Exchange,displayTitle:null===($=e.Source)||void 0===$?void 0:$.NormalizedSubject,displayPreview:null===(ee=e.Source)||void 0===ee?void 0:ee.Preview,displayAuthor:null===(te=e.Source)||void 0===te?void 0:te.From.Name,previewUrl:null===(ne=e.Source)||void 0===ne?void 0:ne.Weblink,contextTimestamp:null===(ae=e.Source)||void 0===ae?void 0:ae.DateTimeSent};default:throw new Error("unexpected provenance in response result")}}(e)});return e.concat(Array.isArray(i)?i:[])}return e.concat([])},[]):[];return e.concat(Array.isArray(i)?i:[])},[]);return t}function id(e){if(!Array.isArray(e.EntitySets))return[];var t=e.EntitySets.reduce(function(e,t){var n,a,i=(a=null===(n=t.ResultSets)||void 0===n?void 0:n.filter(function(e){var t;return 0!==e.Total||(null===(t=e.Results)||void 0===t?void 0:t.length)}))?a.reduce(function(e,t){var n,a;if(null===(n=t.Results)||void 0===n?void 0:n.length){var i=null===(a=t.Results)||void 0===a?void 0:a.map(function(e,t){return function(e,t){var n,a,i,r,o,s,c,d;switch(e.Provenance){case Hc.SharePoint:case Hc.OneDriveBusiness:return{Id:t.toString(),FileSourceType:null===(n=e.Source)||void 0===n?void 0:n.FileType,text:null===(a=e.Source)||void 0===a?void 0:a.Title,FileName:null===(i=e.Source)||void 0===i?void 0:i.Filename,FileExtension:null===(r=e.Source)||void 0===r?void 0:r.FileExtension,FileSize:0,AccessUrl:null===(o=e.Source)||void 0===o?void 0:o.DefaultEncodingUrl,DateAccessed:null===(s=e.Source)||void 0===s?void 0:s.lastAccessDateTime,DateModified:null===(c=e.Source)||void 0===c?void 0:c.LastModifiedTime,DateCreated:"",ListId:null===(d=e.Source)||void 0===d?void 0:d.ListId,confidence:0};default:throw new Error("unexpected provenance in response result")}}(e,t)});return e.concat(Array.isArray(i)?i:[])}return e.concat([])},[]):[];return e.concat(Array.isArray(i)?i:[])},[]);return t}function rd(t,n,a,i){return(0,e.__awaiter)(this,void 0,void 0,function(){return(0,e.__generator)(this,function(e){switch(e.label){case 0:return[4,od(t,n,a,i)];case 1:return[2,id(e.sent())]}})})}function od(t,n,a,i){return(0,e.__awaiter)(this,void 0,void 0,function(){var r,o,s,c,d,l,u,f,p;return(0,e.__generator)(this,function(e){switch(e.label){case 0:r=new R._QosMonitor("ContentDiscoveryApiCall"),e.label=1;case 1:return e.trys.push([1,6,,7]),[4,nd(t)];case 2:return e.sent(),[4,ed._getTokenInternal($c,jr._AadTokenProviders.preAuthorizedConfiguration)];case 3:return o=e.sent(),s=t.consume(Zc.HttpClient.serviceKey),c=new Zc.HttpClientConfiguration(Zc.HttpClient.configurations.v1),(d=new Headers).set("Authorization","Bearer "+o),d.set("Content-Type","application/json"),d.set("Accept","application/json"),l=JSON.stringify({EntityRequests:[{EntityType:"File",ContentSources:[Nc.SharePoint,Nc.OneDriveBusiness],Query:{QueryString:n,QueryTemplate:a||""},From:null==i?void 0:i.from,Size:null==i?void 0:i.size,Sort:null==i?void 0:i.sort,HitHighlight:null==i?void 0:i.hitHighlight,SupportedResultSourceFormats:["EntityData"],PreferredResultSourceFormat:"EntityData"}],Scenario:{Name:"sharepoint_copilot"},Cvid:H.Guid.newGuid().toString()}),u={credentials:"same-origin",headers:d,body:l},[4,s.post("".concat($c,"/api/v2/query"),c,u)];case 4:return[4,e.sent().json()];case 5:return f=e.sent(),r.writeSuccess({apiTraceId:f.Instrumentation.TraceId}),[2,f];case 6:throw p=e.sent(),r.writeUnexpectedFailure(p),R._TraceLogger.logError(td,p,"error in send message"),p;case 7:return[2]}})})}function sd(t,n){return(0,e.__awaiter)(this,void 0,void 0,function(){var a,i,r,o,s,c,d,l,u;return(0,e.__generator)(this,function(e){switch(e.label){case 0:a=new R._QosMonitor("ContentDiscoveryApiCall"),e.label=1;case 1:return e.trys.push([1,6,,7]),[4,nd(t)];case 2:return e.sent(),[4,ed._getTokenInternal($c,jr._AadTokenProviders.preAuthorizedConfiguration)];case 3:return i=e.sent(),r=t.consume(Zc.HttpClient.serviceKey),o=new Zc.HttpClientConfiguration(Zc.HttpClient.configurations.v1),(s=new Headers).set("Authorization","Bearer "+i),s.set("Content-Type","application/json"),s.set("Accept","application/json"),c=JSON.stringify({EntityRequests:[{EntityType:"Document",Context:{EntityId:n}}],Scenario:{Name:"FileInsights"},Cvid:H.Guid.newGuid().toString()}),d={credentials:"same-origin",headers:s,body:c},[4,r.post("".concat($c,"/api/v1/recommendations"),o,d)];case 4:return[4,e.sent().json()];case 5:return l=e.sent(),a.writeSuccess({apiTraceId:l.Instrumentation.TraceId}),[2,ad(l)];case 6:throw u=e.sent(),a.writeUnexpectedFailure(u),R._TraceLogger.logError(td,u,"error in send message"),u;case 7:return[2]}})})}})(),d})());